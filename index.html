<!DOCTYPE html>
<html>
<head>
    <title>Kalkulator ELO Dart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { margin: 0; padding: 0; background: #1a1a1a; color: white; }
        
        /* MENU NAWIGACYJNE - RESPONSYWNE */
        .nav-menu {
            display: flex;
            background: #2d2d2d;
            padding: 0;
            border-bottom: 2px solid #4CAF50;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
        }
        .nav-btn {
            flex: 1 0 auto;
            min-width: 120px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        @media (max-width: 480px) {
            .nav-btn {
                min-width: 90px;
                padding: 10px 5px;
                font-size: 12px;
            }
            .nav-btn span {
                font-size: 10px;
            }
        }
        @media (max-width: 360px) {
            .nav-btn {
                min-width: 80px;
                padding: 8px 4px;
                font-size: 11px;
            }
        }
        .nav-btn:hover {
            background: #3a3a3a;
            color: white;
        }
        .nav-btn.active {
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
            font-weight: bold;
            background: #333;
        }
        .nav-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .nav-btn.disabled:hover {
            background: transparent;
            color: #aaa;
        }
        .nav-icon {
            font-size: 18px;
        }
        @media (max-width: 480px) {
            .nav-icon {
                font-size: 16px;
            }
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 15px; 
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
        }
        
        h1 { 
            text-align: center; 
            color: #4CAF50; 
            margin-bottom: 20px; 
            margin-top: 10px; 
            font-size: 22px;
        }
        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
                margin-bottom: 15px;
            }
        }
        
        .player-box { 
            background: #2d2d2d; 
            padding: 12px; 
            margin: 12px 0; 
            border-radius: 8px; 
        }
        @media (max-width: 480px) {
            .player-box {
                padding: 10px;
                margin: 10px 0;
            }
        }
        
        .input-group { margin-bottom: 8px; }
        label { display: block; margin-bottom: 4px; color: #aaa; font-size: 14px; }
        input { 
            width: 100%; 
            padding: 10px; 
            font-size: 16px; 
            border: 1px solid #444; 
            background: #333; 
            color: white; 
            border-radius: 5px; 
        }
        @media (max-width: 480px) {
            input {
                padding: 8px;
                font-size: 15px;
            }
        }
        
        .elo-display { font-size: 22px; font-weight: bold; margin: 8px 0; }
        @media (max-width: 480px) {
            .elo-display {
                font-size: 20px;
            }
        }
        
        .chance { 
            text-align: center; 
            font-size: 16px; 
            margin: 15px 0; 
            color: #BB86FC; 
            padding: 8px;
            background: rgba(187, 134, 252, 0.1);
            border-radius: 5px;
        }
        @media (max-width: 480px) {
            .chance {
                font-size: 15px;
                margin: 12px 0;
                padding: 6px;
            }
        }
        
        .buttons { 
            display: flex; 
            gap: 8px; 
            margin: 15px 0; 
            flex-wrap: wrap;
        }
        @media (max-width: 480px) {
            .buttons {
                gap: 6px;
                margin: 12px 0;
            }
        }
        
        button { 
            flex: 1; 
            padding: 12px; 
            font-size: 14px; 
            border: none; 
            border-radius: 5px; 
            color: white; 
            cursor: pointer; 
            min-width: 100px;
        }
        @media (max-width: 480px) {
            button {
                padding: 10px 8px;
                font-size: 13px;
                min-width: 0;
            }
        }
        
        .btn-win1 { background: #4CAF50; }
        .btn-win2 { background: #F44336; }
        .btn-draw { background: #FF9800; }
        .btn-add { background: #9C27B0; }
        .btn-login { background: #2196F3; }
        .btn-logout { background: #f44336; }
        .btn-dev { background: #FFFFFF; color: #1a1a1a; }
        .btn-toggle { background: #607D8B; }
        
        .history { 
            margin-top: 25px; 
            background: #2d2d2d; 
            padding: 12px; 
            border-radius: 8px; 
        }
        .players-list { margin-top: 15px; }
        .player-item { 
            background: #333; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .player-item:nth-child(odd) { background: #3a3a3a; }
        
        /* PRZYCISKI USUWANIA */
        .delete-btn { 
            background: #f44336; 
            color: white; 
            border: none; 
            width: 30px; 
            height: 30px; 
            min-width: 30px;
            min-height: 30px;
            border-radius: 5px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 14px;
            padding: 0;
            flex-shrink: 0;
        }
        @media (max-width: 480px) {
            .delete-btn, .lock-btn {
                width: 28px;
                height: 28px;
                min-width: 28px;
                min-height: 28px;
                font-size: 13px;
            }
        }
        
        .lock-btn { 
            background: #FF9800; 
            color: white; 
            border: none; 
            width: 30px; 
            height: 30px; 
            min-width: 30px;
            min-height: 30px;
            border-radius: 5px; 
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            padding: 0;
            flex-shrink: 0;
        }
        
        select { 
            width: 100%; 
            padding: 10px; 
            background: #333; 
            color: white; 
            border: 1px solid #444; 
            border-radius: 5px; 
            font-size: 15px;
        }
        @media (max-width: 480px) {
            select {
                padding: 8px;
                font-size: 14px;
            }
        }
        
        .login-box { 
            background: #2d2d2d; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            text-align: center; 
        }
        .admin-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #FF9800; 
        }
        .user-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #2196F3; 
        }
        .dev-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #FFFFFF; 
        }
        .hidden { display: none; }
        .role-badge { 
            display: inline-block; 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: bold; 
            margin-left: 8px; 
        }
        @media (max-width: 480px) {
            .role-badge {
                font-size: 10px;
                padding: 2px 6px;
                margin-left: 6px;
            }
        }
        
        .admin-badge { background: #FF9800; color: black; }
        .user-badge { background: #2196F3; color: white; }
        .dev-badge { background: #FFFFFF; color: #1a1a1a; border: 1px solid #ccc; }
        .swap-btn { 
            background: transparent; 
            border: none; 
            color: #BB86FC; 
            cursor: pointer; 
            font-size: 22px; 
            padding: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 480px) {
            .swap-btn {
                font-size: 20px;
                padding: 0 6px;
            }
        }
        
        .swap-btn:hover { color: #ffffff; }
        .swap-btn:disabled { 
            color: #666; 
            cursor: not-allowed; 
        }
        .player-select-row {
            display: flex; 
            gap: 5px; 
            margin-bottom: 10px;
            align-items: center;
        }
        
        /* STRONY */
        .page { display: none; }
        .page.active { display: block; }
        
        /* MODAL DO WERYFIKACJI KODU - POPRAWIONY */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            border: 2px solid #4CAF50;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        
        .close-modal {
            background: #f44336;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .close-modal:hover {
            background: #d32f2f;
        }
        
        .code-input {
            letter-spacing: 8px;
            font-size: 24px;
            text-align: center;
            font-family: monospace;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .player-name-highlight {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
            margin: 10px 0;
            text-align: center;
            padding: 8px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
        }
        
        /* STRONA GRY */
        .games-page {
            text-align: center;
            padding: 30px 15px;
        }
        
        /* STRONA RANG */
        .ranks-page {
            padding: 15px;
        }
        
        /* STRONA INFO */
        .info-page {
            padding: 15px;
        }
        
        .info-box {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        @media (max-width: 480px) {
            .info-box {
                padding: 12px;
                font-size: 13px;
            }
        }
        
        .coming-soon {
            text-align: center;
            font-size: 22px;
            color: #BB86FC;
            margin-top: 40px;
            padding: 20px;
        }
        @media (max-width: 480px) {
            .coming-soon {
                font-size: 20px;
                margin-top: 30px;
                padding: 15px;
            }
        }
        
        /* MOBILE OPTIMIZATION */
        .mobile-only { display: none; }
        .desktop-only { display: block; }
        
        @media (max-width: 480px) {
            .mobile-only { display: block; }
            .desktop-only { display: none; }
        }
        
        /* Lepsze zarzƒÖdzanie tekstem na ma≈Çych ekranach */
        .player-name-truncate {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        @media (max-width: 480px) {
            .player-name-truncate {
                max-width: 120px;
            }
        }
        @media (max-width: 360px) {
            .player-name-truncate {
                max-width: 100px;
            }
        }
        
        /* KOD W LISCIE GRACZY */
        .player-code {
            background: rgba(76, 175, 80, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #4CAF50;
        }
        
        /* ADMIN PANEL IMPROVEMENTS */
        .admin-input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .admin-input-group {
            flex: 1;
        }
        
        .generate-code-btn {
            background: #607D8B;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            height: 42px;
            min-width: 80px;
        }
        
        .generate-code-btn:hover {
            background: #546E7A;
        }
        
        /* DEV PANEL STYLES */
        .role-toggle-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .role-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-enabled {
            background: #4CAF50;
            color: white;
        }
        
        .status-disabled {
            background: #f44336;
            color: white;
        }
        
        .dev-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        
        .password-input {
            flex: 2;
        }
        
        .toggle-btn {
            flex: 1;
            min-width: 120px;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- MENU NAWIGACYJNE - ZOPTYMALIZOWANE DLA TELEFONU -->
    <div class="nav-menu">
        <button class="nav-btn active" onclick="showPage('elo')">
            <span class="nav-icon">üéØ</span>
            <span>Kalkulator Elo</span>
        </button>
        <button class="nav-btn" id="gamesBtn" onclick="showPage('games')">
            <span class="nav-icon">üéÆ</span>
            <span>Gry</span>
        </button>
        <button class="nav-btn" onclick="showPage('ranks')">
            <span class="nav-icon">‚≠ê</span>
            <span>Rangi</span>
        </button>
        <button class="nav-btn" onclick="showPage('info')">
            <span class="nav-icon">‚ÑπÔ∏è</span>
            <span>Info</span>
        </button>
    </div>

    <!-- MODAL DO WERYFIKACJI KODU - POPRAWIONY -->
    <div id="codeModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0; color: #4CAF50;">üîí WERYFIKACJI KODU</h3>
                <button class="close-modal" onclick="closeCodeModal()">‚úï</button>
            </div>
            
            <div id="modalMessage" style="text-align: center; margin-bottom: 15px;">
                <p>Wprowad≈∫ 5-cyfrowy kod weryfikacyjny dla wybranego gracza</p>
            </div>
            
            <div class="player-name-highlight" id="modalPlayerName">
                <!-- Tu pojawi siƒô nazwa gracza -->
            </div>
            
            <div class="input-group">
                <label style="text-align: center;">5-cyfrowy kod:</label>
                <input type="text" 
                       id="codeInput" 
                       class="code-input" 
                       maxlength="5" 
                       placeholder="00000"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5)">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-logout" onclick="closeCodeModal()" style="flex: 1;">ANULUJ</button>
                <button class="btn-win1" onclick="submitCode()" style="flex: 2;">ZATWIERD≈π KOD</button>
            </div>
            
            <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #aaa;">
                Naci≈õnij ESC lub kliknij poza modal aby zamknƒÖƒá
            </div>
        </div>
    </div>

    <!-- STRONA KALKULATORA ELO -->
    <div class="container page active" id="eloPage">
        <h1>üéØ KALKULATOR ELO DART</h1>
        
        <!-- Panel logowania -->
        <div class="login-box" id="loginBox">
            <h3>ZALOGUJ SIƒò</h3>
            <p style="font-size: 14px; color: #aaa;">Dane synchronizowane w chmurze Firebase</p>
            <div class="input-group">
                <input type="password" id="adminPassword" placeholder="Wprowad≈∫ has≈Ço...">
            </div>
            <button class="btn-login" onclick="login()">ZALOGUJ</button>
            <div style="margin-top: 10px; font-size: 12px; color: #aaa;">
                <span class="desktop-only">Bez logowania: tylko przeglƒÖdanie<br>
                Z logowaniem: dostƒôp do pe≈Çnych funkcji</span>
                <span class="mobile-only">Go≈õƒá: przeglƒÖdanie<br>
                Zalogowany: pe≈Çny dostƒôp</span>
            </div>
        </div>
        
        <!-- Admin Panel (ukryty domy≈õlnie) -->
        <div class="admin-panel hidden" id="adminPanel">
            <h3 style="margin-top: 0;">üëë KONTO PREMIUM <span class="role-badge admin-badge">PREMIUM</span></h3>
            
            <div class="input-group">
                <label>Imiƒô nowego gracza:</label>
                <input type="text" id="newPlayerName" placeholder="np. Jan Kowalski">
            </div>
            
            <div class="input-group">
                <label>PoczƒÖtkowe ELO:</label>
                <input type="number" id="newPlayerElo" value="1500" placeholder="1500">
            </div>
            
            <div class="admin-input-row">
                <div class="admin-input-group">
                    <label>5-cyfrowy kod weryfikacyjny:</label>
                    <input type="text" 
                           id="newPlayerCode" 
                           maxlength="5" 
                           placeholder="12345"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5)">
                </div>
                <button onclick="generateRandomCode()" class="generate-code-btn">
                    Losuj
                </button>
            </div>
            
            <small style="color: #aaa; font-size: 12px; display: block; margin-top: 5px;">
                Mo≈ºesz wpisaƒá w≈Çasny kod lub u≈ºyƒá przycisku "Losuj". Kody mogƒÖ siƒô powtarzaƒá.
            </small>
            
            <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button class="btn-add" onclick="addNewPlayer()" style="flex: 2;">‚ûï DODAJ GRACZA</button>
                <button class="btn-logout" onclick="logout()" style="flex: 1;">WYLOGUJ</button>
            </div>
        </div>
        
        <!-- User Panel (ukryty domy≈õlnie) -->
        <div class="user-panel hidden" id="userPanel">
            <h3 style="margin-top: 0;">üë§ KONTO U≈ªYTKOWNIKA <span class="role-badge user-badge">USER</span></h3>
            <button class="btn-logout" onclick="logout()" style="width: 100%;">WYLOGUJ</button>
        </div>
        
        <!-- Dev Panel (ukryty domy≈õlnie) -->
        <div class="dev-panel hidden" id="devPanel">
            <h3 style="margin-top: 0;">‚öôÔ∏è PANEL SYSTEMOWY <span class="role-badge dev-badge">SYSTEM</span></h3>
            
            <!-- Status rang -->
            <div class="role-toggle-section">
                <h4 style="margin-top: 0; color: #FFFFFF;">üéÆ ZARZƒÑDZANIE DOSTƒòPAMI</h4>
                
                <div style="margin-bottom: 15px;">
                    <strong>Dostƒôp Premium:</strong> 
                    <span id="adminStatus" class="role-status status-disabled">WY≈ÅƒÑCZONY</span>
                    <div class="dev-controls">
                        <input type="password" 
                               id="adminPasswordInput" 
                               class="password-input" 
                               placeholder="Ustaw has≈Ço dla dostƒôpu Premium...">
                        <button class="btn-toggle toggle-btn" onclick="toggleAdminRole()">
                            W≈ÅƒÑCZ
                        </button>
                    </div>
                    <small style="color: #aaa; display: block; margin-top: 5px;">
                        Aktualne has≈Ço: <span id="currentAdminPassword">brak</span>
                    </small>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Dostƒôp U≈ºytkownika:</strong> 
                    <span id="userStatus" class="role-status status-disabled">WY≈ÅƒÑCZONY</span>
                    <div class="dev-controls">
                        <input type="password" 
                               id="userPasswordInput" 
                               class="password-input" 
                               placeholder="Ustaw has≈Ço dla dostƒôpu U≈ºytkownika...">
                        <button class="btn-toggle toggle-btn" onclick="toggleUserRole()">
                            W≈ÅƒÑCZ
                        </button>
                    </div>
                    <small style="color: #aaa; display: block; margin-top: 5px;">
                        Aktualne has≈Ço: <span id="currentUserPassword">brak</span>
                    </small>
                </div>
                
                <div style="font-size: 12px; color: #aaa; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                    <strong>‚ö†Ô∏è Uwaga:</strong> Gdy dostƒôp jest wy≈ÇƒÖczony, nikt nie mo≈ºe siƒô na niego zalogowaƒá.<br>
                    PrzeglƒÖdanie bez logowania jest zawsze dostƒôpne.
                </div>
            </div>
            
            <!-- Dodawanie graczy -->
            <div style="margin-top: 20px;">
                <h4 style="margin-top: 0; color: #FFFFFF;">‚ûï DODAWANIE GRACZY</h4>
                
                <div class="input-group">
                    <label>Imiƒô nowego gracza:</label>
                    <input type="text" id="devNewPlayerName" placeholder="np. Jan Kowalski">
                </div>
                
                <div class="input-group">
                    <label>PoczƒÖtkowe ELO:</label>
                    <input type="number" id="devNewPlayerElo" value="1500" placeholder="1500">
                </div>
                
                <div class="admin-input-row">
                    <div class="admin-input-group">
                        <label>5-cyfrowy kod weryfikacyjny:</label>
                        <input type="text" 
                               id="devNewPlayerCode" 
                               maxlength="5" 
                               placeholder="12345"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5)">
                    </div>
                    <button onclick="generateRandomCodeDev()" class="generate-code-btn">
                        Losuj
                    </button>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 15px;">
                    <button class="btn-add" onclick="addNewPlayerDev()" style="flex: 2;">‚ûï DODAJ GRACZA</button>
                    <button class="btn-logout" onclick="logout()" style="flex: 1;">WYLOGUJ</button>
                </div>
            </div>
        </div>
        
        <!-- Wyb√≥r graczy do meczu -->
        <div class="player-box">
            <h3 style="margin-top: 0;">WYBIERZ GRACZY DO MECZU</h3>
            
            <div class="player-select-row">
                <div style="flex: 1;">
                    <label>Gracz A:</label>
                    <select id="selectPlayerA">
                        <option value="">Wybierz gracza</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: center; min-height: 60px;">
                    <button class="swap-btn" onclick="swapPlayers()" id="swapBtn" title="Zamie≈Ñ graczy miejscami">
                        üîÑ
                    </button>
                </div>
                
                <div style="flex: 1;">
                    <label>Gracz B:</label>
                    <select id="selectPlayerB">
                        <option value="">Wybierz gracza</option>
                    </select>
                </div>
            </div>
            
            <div class="chance" id="chance">Wybierz graczy aby zobaczyƒá szanse</div>
            
            <div class="buttons">
                <button class="btn-win1" onclick="playerAWins()" id="btnA">GRACZ A wygrywa</button>
                <button class="btn-draw" onclick="draw()" id="btnDraw">REMIS</button>
                <button class="btn-win2" onclick="playerBWins()" id="btnB">GRACZ B wygrywa</button>
            </div>
            
            <div style="text-align: center; margin-top: 10px; color: #aaa; font-size: 12px;">
                ‚ö†Ô∏è Po klikniƒôciu przycisku bƒôdzie wymagane podanie kodu weryfikacyjnego dla obu graczy
            </div>
        </div>
        
        <!-- Lista wszystkich graczy -->
        <div class="players-list">
            <h3 style="margin-top: 0;">üèÜ RANKING GRACZY</h3>
            <div id="allPlayersList">≈Åadowanie z chmury...</div>
        </div>
        
        <!-- Historia zmian -->
        <div class="history">
            <h3 style="margin-top: 0;">üìú OSTATNIE MECZE</h3>
            <div id="historyList">-</div>
        </div>
        
        <!-- Info o synchronizacji -->
        <div style="text-align: center; margin-top: 20px; color: #777; font-size: 11px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
            <span class="desktop-only">
                üîÑ Synchronizacja z Firebase | üíæ Auto-zapis | üë• Wielu u≈ºytkownik√≥w | ‚òÅÔ∏è Chmura
            </span>
            <span class="mobile-only">
                üîÑ Synchronizacja | üíæ Auto-zapis | ‚òÅÔ∏è Chmura
            </span>
        </div>
    </div>

    <!-- STRONA GRY -->
    <div class="container page" id="gamesPage">
        <div class="games-page">
            <h1>üéÆ GRY I TURNIEJE</h1>
            <div class="coming-soon">üöß STRONA W BUDOWIE üöß</div>
            <p style="text-align: center; color: #aaa; margin-top: 20px; font-size: 14px;">
                Tutaj bƒôdƒÖ dostƒôpne r√≥≈ºne tryby gry i turnieje
            </p>
        </div>
    </div>

    <!-- STRONA RANG -->
    <div class="container page" id="ranksPage">
        <div class="ranks-page">
            <h1>‚≠ê SYSTEM RANG</h1>
            <div class="coming-soon">üöß STRONA W BUDOWIE üöß</div>
            <p style="text-align: center; color: #aaa; margin-top: 20px; font-size: 14px;">
                Tutaj bƒôdzie system rang i osiƒÖgniƒôƒá
            </p>
        </div>
    </div>

    <!-- STRONA INFO -->
    <div class="container page" id="infoPage">
        <div class="info-page">
            <h1>‚ÑπÔ∏è INFORMACJE</h1>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #4CAF50;">üîê SYSTEM WERYFIKACJI KOD√ìW</h4>
                <p>Ka≈ºdy gracz ma 5-cyfrowy kod weryfikacyjny. Podczas meczu wymagane jest podanie kodu gracza, aby:</p>
                <ul style="padding-left: 20px;">
                    <li>Zapobiec kradzie≈ºy ELO przez innych graczy</li>
                    <li>Potwierdziƒá to≈ºsamo≈õƒá zawodnika</li>
                    <li>Zapewniƒá uczciwo≈õƒá rozgrywek</li>
                    <li>Kody mogƒÖ siƒô powtarzaƒá</li>
                </ul>
                <p><strong>Proces weryfikacji:</strong></p>
                <ol style="padding-left: 20px;">
                    <li>Wybierz graczy do meczu</li>
                    <li>Kliknij przycisk z wynikiem</li>
                    <li>Wprowad≈∫ kod dla Gracza A</li>
                    <li>Wprowad≈∫ kod dla Gracza B</li>
                    <li>Mecz zostanie zapisany po poprawnej weryfikacji obu kod√≥w</li>
                </ol>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #4CAF50;">üìä O SYSTEMIE ELO</h4>
                <p>System Elo s≈Çu≈ºy do obliczania wzglƒôdnej si≈Çy graczy na podstawie wynik√≥w mecz√≥w.</p>
                <ul style="padding-left: 20px;">
                    <li><strong>K = 32</strong> - wsp√≥≈Çczynnik zmiany dla darta</li>
                    <li><strong>ELO poczƒÖtkowe:</strong> 1500 punkt√≥w</li>
                    <li><strong>Wz√≥r:</strong> 1 / (1 + 10^((R_B - R_A)/400))</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #2196F3;">üîê POZIOMY DOSTƒòPU</h4>
                <ul style="padding-left: 20px;">
                    <li><strong>PrzeglƒÖdanie:</strong> PrzeglƒÖdanie rankingu, ukryte nazwiska (zawsze dostƒôpne)</li>
                    <li><strong>U≈ºytkownik:</strong> Rozgrywanie mecz√≥w, pe≈Çne nazwiska (do w≈ÇƒÖczenia)</li>
                    <li><strong>Premium:</strong> Dodawanie/Usuwanie graczy (do w≈ÇƒÖczenia)</li>
                </ul>
                <p style="margin-top: 10px; font-size: 13px; color: #aaa;">
                    Dostƒôpy U≈ºytkownika i Premium mogƒÖ byƒá w≈ÇƒÖczane/wy≈ÇƒÖczane przez administratora systemu.
                </p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // KONFIGURACJA FIREBASE - UKRYTA W KODZIE
        // ============================================
        
        // Metoda 1: Konfiguracja zakodowana w Base64 (najbezpieczniejsza)
        const encodedFirebaseConfig = "ewogICAgYXBpS2V5OiAiWVpZU3lYaVIxYS15eDczTnVJVXYwS3NvQmF2NTdUWGFFek0yNCIsCiAgICBhdXRoRG9tYWluOiAiR2FyY3RjYXBsaWthY2phcnN5cGUuZmlyZWJhc2VhcHAuY29tIiwKICAgIHByb2plY3RJZDogIkdhcmN0Y2FwbGlrYWNqYXJzeXBlIiwKICAgIHN0b3JhZ2VCdWNrZXQ6ICJHYXJjdGNhcGxpa2FjamFyc3lwZS5maXJlYmFzZXN0b3JhZ2UuYXBwIiwKICAgIG1lc3NhZ2luZ1NlbmRlcklkOiAiMTE5ODQyOTY2Njg3IiwKICAgIGFwcElkOiAiMToxMTk4NDI5NjY2ODc6d2ViOjIwNDRmNmM1N2Q4MzYxNTAiCn0=";
        
        // Metoda 2: Bezpo≈õrednia konfiguracja (≈Çatwiejsza do edycji)
        const firebaseConfig = {
            // ‚ö†Ô∏è ZASTƒÑP TYMI DANMI Z TWOJEGO FIREBASE CONSOLE!
            // 1. Wejd≈∫ na: https://console.firebase.google.com/
            // 2. Wybierz projekt ‚Üí ‚öôÔ∏è ‚Üí Project settings
            // 3. W sekcji "Your apps" znajd≈∫ te warto≈õci:
            
            apiKey: "AIzaSyAiRim-yx73MLHlUvOKsoBav57TXaEzN24",
			authDomain: "dartteaplikacjaszypra.firebaseapp.com",
			projectId: "dartteaplikacjaszypra",
			storageBucket: "dartteaplikacjaszypra.firebasestorage.app",
			messagingSenderId: "461617366334",
			appId: "1:461617366334:web:4b26e73d9db79e9665586f"
        };
        
        // Funkcja do dekodowania konfiguracji z Base64
        function decodeFirebaseConfig() {
            try {
                // Je≈õli u≈ºywasz zakodowanej wersji
                const jsonStr = atob(encodedFirebaseConfig);
                const config = JSON.parse(jsonStr);
                return config;
            } catch (error) {
                console.log("U≈ºywam bezpo≈õredniej konfiguracji Firebase");
                // Zwr√≥ƒá bezpo≈õredniƒÖ konfiguracjƒô
                return firebaseConfig;
            }
        }
        
        // ============================================
        // INICJALIZACJA APLIKACJI
        // ============================================
        
        // Sprawd≈∫ czy Firebase SDK jest za≈Çadowany
        function checkFirebaseSDK() {
            if (typeof firebase === 'undefined') {
                console.error("Firebase SDK nie zosta≈Ç za≈Çadowany!");
                return false;
            }
            return true;
        }
        
        // Inicjalizuj Firebase
        function initializeFirebase() {
            if (!checkFirebaseSDK()) {
                showFirebaseError("Brak Firebase SDK. Sprawd≈∫ po≈ÇƒÖczenie internetowe.");
                return null;
            }
            
            try {
                // Uzyskaj konfiguracjƒô
                const config = decodeFirebaseConfig();
                
                // Sprawd≈∫ czy konfiguracja jest prawid≈Çowa
                if (!config.apiKey || config.apiKey.includes("TU_WPISZ")) {
                    showConfigForm();
                    return null;
                }
                
                // Inicjalizuj Firebase
                const app = firebase.initializeApp(config);
                console.log("‚úÖ Firebase zainicjalizowany pomy≈õlnie");
                
                // Zwr√≥ƒá instancje Firebase
                return {
                    app: app,
                    db: firebase.firestore(),
                    auth: firebase.auth()
                };
                
            } catch (error) {
                console.error("‚ùå B≈ÇƒÖd inicjalizacji Firebase:", error);
                
                if (error.code === 'app/duplicate-app') {
                    // Firebase ju≈º zainicjalizowany
                    console.log("Firebase ju≈º zainicjalizowany, u≈ºywam istniejƒÖcej instancji");
                    return {
                        app: firebase.app(),
                        db: firebase.firestore(),
                        auth: firebase.auth()
                    };
                }
                
                showFirebaseError("Nie mo≈ºna po≈ÇƒÖczyƒá siƒô z Firebase: " + error.message);
                return null;
            }
        }
        
        // Poka≈º formularz konfiguracji
        function showConfigForm() {
            const loginBox = document.getElementById('loginBox');
            if (!loginBox) return;
            
            loginBox.innerHTML = `
                <h3 style="color: #FF9800;">üîß KONFIGURACJA FIREBASE</h3>
                <p style="font-size: 14px; color: #aaa;">
                    Aplikacja potrzebuje danych Firebase do dzia≈Çania.
                </p>
                
                <div class="input-group">
                    <label>API Key:</label>
                    <input type="password" id="configApiKey" placeholder="AIzaSyABC123...">
                </div>
                
                <div class="input-group">
                    <label>Project ID:</label>
                    <input type="text" id="configProjectId" placeholder="twoj-projekt">
                </div>
                
                <button onclick="saveFirebaseConfig()" class="btn-login" style="width: 100%; margin-top: 15px;">
                    üíæ ZAPISZ KONFIGURACJƒò
                </button>
                
                <div style="margin-top: 15px; font-size: 12px; color: #aaa; padding: 10px; background: rgba(255,152,0,0.1); border-radius: 5px;">
                    <strong>‚ÑπÔ∏è Jak zdobyƒá te dane?</strong><br>
                    1. Wejd≈∫ na <a href="https://console.firebase.google.com/" target="_blank" style="color: #4CAF50;">Firebase Console</a><br>
                    2. Stw√≥rz projekt lub wybierz istniejƒÖcy<br>
                    3. Dodaj aplikacjƒô webowƒÖ<br>
                    4. Skopiuj konfiguracjƒô
                </div>
            `;
        }
        
        // Zapisz konfiguracjƒô w localStorage
        function saveFirebaseConfig() {
            const apiKey = document.getElementById('configApiKey').value.trim();
            const projectId = document.getElementById('configProjectId').value.trim();
            
            if (!apiKey || !projectId) {
                alert("Wype≈Çnij wszystkie pola!");
                return;
            }
            
            const config = {
                apiKey: apiKey,
                authDomain: projectId + ".firebaseapp.com",
                projectId: projectId,
                storageBucket: projectId + ".appspot.com",
                messagingSenderId: "",
                appId: ""
            };
            
            // Zapisz w localStorage
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            
            alert("‚úÖ Konfiguracja zapisana! Strona zostanie od≈õwie≈ºona.");
            setTimeout(() => {
                location.reload();
            }, 1500);
        }
        
        // Poka≈º b≈ÇƒÖd Firebase
        function showFirebaseError(message) {
            const loginBox = document.getElementById('loginBox');
            if (!loginBox) return;
            
            loginBox.innerHTML = `
                <h3 style="color: #f44336;">‚ö†Ô∏è B≈ÅƒÑD PO≈ÅƒÑCZENIA</h3>
                <p>${message}</p>
                <button onclick="showConfigForm()" class="btn-login" style="margin-top: 10px;">
                    üîß KONFIGURUJ FIREBASE
                </button>
            `;
        }
        
        // ============================================
        // G≈Å√ìWNY KOD APLIKACJI
        // ============================================
        
        // Zmienne globalne
        let db = null;
        let auth = null;
        let players = [];
        let history = [];
        let currentUserRole = 'guest';
        let unsubscribePlayers = null;
        let unsubscribeHistory = null;
        let unsubscribeSettings = null;
        let currentPage = 'elo';
        
        // Ustawienia systemu
        let systemSettings = {
            adminEnabled: false,
            userEnabled: false,
            adminPassword: '',
            userPassword: ''
        };
        
        // Zmienne do weryfikacji kodu
        let pendingMatch = null;
        let verificationPlayer = null;
        
        // Funkcje pomocnicze
        function debugPendingMatch() {
            console.log('=== DEBUG pendingMatch ===');
            console.log('Czy istnieje?:', pendingMatch ? 'TAK' : 'NIE');
            if (pendingMatch) {
                console.log('Gracz A:', pendingMatch.playerA?.name);
                console.log('Gracz B:', pendingMatch.playerB?.name);
                console.log('Score A:', pendingMatch.scoreA);
                console.log('Verification Player:', verificationPlayer);
            }
            console.log('==========================');
        }
        
        function generateRandomCode() {
            const randomCode = Math.floor(10000 + Math.random() * 90000);
            const element = document.getElementById('newPlayerCode');
            if (element) {
                element.value = randomCode;
                element.focus();
            }
        }
        
        function generateRandomCodeDev() {
            const randomCode = Math.floor(10000 + Math.random() * 90000);
            const element = document.getElementById('devNewPlayerCode');
            if (element) {
                element.value = randomCode;
                element.focus();
            }
        }
        
        // Modal weryfikacji kodu
        function showCodeModal(playerType, playerName) {
            verificationPlayer = playerType;
            const modal = document.getElementById('codeModal');
            const playerNameElement = document.getElementById('modalPlayerName');
            const message = document.getElementById('modalMessage');
            
            if (playerNameElement) playerNameElement.innerHTML = `<strong>${playerName}</strong>`;
            
            if (playerType === 'A') {
                if (message) message.innerHTML = `<p>Wprowad≈∫ kod weryfikacyjny dla <strong>Gracza A</strong>:</p>`;
            } else {
                if (message) message.innerHTML = `<p>Wprowad≈∫ kod weryfikacyjny dla <strong>Gracza B</strong>:</p>`;
            }
            
            const codeInput = document.getElementById('codeInput');
            if (codeInput) {
                codeInput.value = '';
                codeInput.focus();
            }
            
            if (modal) modal.classList.add('active');
        }
        
        function closeCodeModal() {
            const modal = document.getElementById('codeModal');
            if (modal) modal.classList.remove('active');
        }
        
        function submitCode() {
            console.log('submitCode called');
            debugPendingMatch();
            
            const codeInput = document.getElementById('codeInput');
            if (!codeInput) return;
            
            const codeValue = codeInput.value;
            
            if (codeValue.length !== 5) {
                alert('Kod musi mieƒá dok≈Çadnie 5 cyfr!');
                codeInput.focus();
                return;
            }
            
            if (!pendingMatch) {
                alert('‚ùå B≈ÇƒÖd: Brak danych meczu. Spr√≥buj ponownie.');
                closeCodeModal();
                return;
            }
            
            let playerToVerify = null;
            let playerName = '';
            
            if (verificationPlayer === 'A' && pendingMatch.playerA) {
                playerToVerify = pendingMatch.playerA;
                playerName = pendingMatch.playerA.name;
            } else if (verificationPlayer === 'B' && pendingMatch.playerB) {
                playerToVerify = pendingMatch.playerB;
                playerName = pendingMatch.playerB.name;
            }
            
            if (!playerToVerify) {
                alert('B≈ÇƒÖd weryfikacji! Spr√≥buj ponownie.');
                closeCodeModal();
                pendingMatch = null;
                return;
            }
            
            if (playerToVerify.code !== codeValue) {
                alert(`‚ùå Nieprawid≈Çowy kod weryfikacyjny dla gracza ${playerName}!`);
                codeInput.value = '';
                codeInput.focus();
                return;
            }
            
            alert(`‚úÖ Poprawny kod dla ${playerName}!`);
            
            if (verificationPlayer === 'A' && pendingMatch) {
                showCodeModal('B', pendingMatch.playerB.name);
            } else if (verificationPlayer === 'B' && pendingMatch) {
                closeCodeModal();
                calculateMatchFinal(pendingMatch.scoreA, pendingMatch.playerA, pendingMatch.playerB);
                pendingMatch = null;
                verificationPlayer = null;
            }
        }
        
        // Nawigacja
        function showPage(pageId) {
            if (pageId === 'games' && currentUserRole === 'guest') {
                alert('Zaloguj siƒô aby mieƒá dostƒôp do sekcji Gry!');
                return;
            }
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const pageElement = document.getElementById(pageId + 'Page');
            if (pageElement) pageElement.classList.add('active');
            
            const btn = document.querySelector(`.nav-btn[onclick*="${pageId}"]`);
            if (btn) btn.classList.add('active');
            
            currentPage = pageId;
        }
        
        function updateMenuForRole() {
            const gamesBtn = document.getElementById('gamesBtn');
            if (!gamesBtn) return;
            
            if (currentUserRole === 'guest') {
                gamesBtn.classList.add('disabled');
                gamesBtn.title = "Zaloguj siƒô aby mieƒá dostƒôp";
            } else {
                gamesBtn.classList.remove('disabled');
                gamesBtn.title = "";
            }
        }
        
        // Autoryzacja
        async function login() {
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            const passwordInput = document.getElementById('adminPassword');
            if (!passwordInput) return;
            
            const password = passwordInput.value;
            
            if (password === 'Dev123SP') {
                const currentDeviceId = getDeviceId();
                console.log('Twoje Device ID:', currentDeviceId);
                
                try {
                    const devicesDoc = await db.collection('system').doc('devices').get();
                    
                    if (devicesDoc.exists) {
                        const allowedDevices = devicesDoc.data().allowedDevices || [];
                        
                        if (allowedDevices.includes(currentDeviceId)) {
                            currentUserRole = 'dev';
                            updateUIForRole();
                            updateMenuForRole();
                            alert('‚úÖ Zalogowano do panelu systemowego!');
                            passwordInput.value = '';
                        } else {
                            alert('‚ùå To urzƒÖdzenie nie ma dostƒôpu systemowego!\n\nTwoje Device ID: ' + currentDeviceId + '\nSkontaktuj siƒô z administratorem aby dodaƒá to urzƒÖdzenie.');
                            passwordInput.value = '';
                        }
                    } else {
                        alert('‚ùå Brak konfiguracji systemu!');
                        passwordInput.value = '';
                    }
                } catch (error) {
                    console.error("B≈ÇƒÖd sprawdzania urzƒÖdzenia:", error);
                    alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z Firebase!\n' + error.message);
                    passwordInput.value = '';
                }
                return;
            }
            
            if (password === systemSettings.adminPassword && systemSettings.adminPassword !== '') {
                if (!systemSettings.adminEnabled) {
                    alert('‚ùå Dostƒôp Premium jest obecnie wy≈ÇƒÖczony!');
                    passwordInput.value = '';
                    return;
                }
                currentUserRole = 'admin';
                updateUIForRole();
                updateMenuForRole();
                alert('‚úÖ Zalogowano do konta Premium!');
                passwordInput.value = '';
                return;
            }
            
            if (password === systemSettings.userPassword && systemSettings.userPassword !== '') {
                if (!systemSettings.userEnabled) {
                    alert('‚ùå Dostƒôp U≈ºytkownika jest obecnie wy≈ÇƒÖczony!');
                    passwordInput.value = '';
                    return;
                }
                currentUserRole = 'user';
                updateUIForRole();
                updateMenuForRole();
                alert('‚úÖ Zalogowano do konta U≈ºytkownika!');
                passwordInput.value = '';
                return;
            }
            
            if (password === '') {
                currentUserRole = 'guest';
                updateUIForRole();
                updateMenuForRole();
                return;
            }
            
            alert('‚ùå Nieprawid≈Çowe has≈Ço!');
            passwordInput.value = '';
        }
        
        function logout() {
            currentUserRole = 'guest';
            updateUIForRole();
            updateMenuForRole();
            
            if (currentPage === 'games') {
                showPage('elo');
            }
        }
        
        function updateUIForRole() {
            const loginBox = document.getElementById('loginBox');
            const adminPanel = document.getElementById('adminPanel');
            const userPanel = document.getElementById('userPanel');
            const devPanel = document.getElementById('devPanel');
            
            if (loginBox) loginBox.classList.add('hidden');
            if (adminPanel) adminPanel.classList.add('hidden');
            if (userPanel) userPanel.classList.add('hidden');
            if (devPanel) devPanel.classList.add('hidden');
            
            if (currentUserRole === 'admin' && adminPanel) {
                adminPanel.classList.remove('hidden');
            } else if (currentUserRole === 'user' && userPanel) {
                userPanel.classList.remove('hidden');
            } else if (currentUserRole === 'dev' && devPanel) {
                devPanel.classList.remove('hidden');
            } else if (loginBox) {
                loginBox.classList.remove('hidden');
            }
            
            updateAllDisplays();
            updateRoleStatusDisplay();
        }
        
        // ≈Åadowanie ustawie≈Ñ systemu
        function loadSystemSettings() {
            if (!db) return;
            
            if (unsubscribeSettings) unsubscribeSettings();
            
            unsubscribeSettings = db.collection('system').doc('settings')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        systemSettings = doc.data();
                        
                        if (systemSettings.adminEnabled === undefined) systemSettings.adminEnabled = false;
                        if (systemSettings.userEnabled === undefined) systemSettings.userEnabled = false;
                        if (!systemSettings.adminPassword) systemSettings.adminPassword = '';
                        if (!systemSettings.userPassword) systemSettings.userPassword = '';
                        
                        console.log('Ustawienia systemowe za≈Çadowane:', systemSettings);
                        updateRoleStatusDisplay();
                    } else {
                        console.log('Brak dokumentu settings w Firebase');
                        systemSettings = {
                            adminEnabled: false,
                            userEnabled: false,
                            adminPassword: '',
                            userPassword: ''
                        };
                    }
                }, error => {
                    console.error("B≈ÇƒÖd ≈Çadowania ustawie≈Ñ:", error);
                    systemSettings = {
                        adminEnabled: false,
                        userEnabled: false,
                        adminPassword: '',
                        userPassword: ''
                    };
                });
        }
        
        function updateRoleStatusDisplay() {
            const adminStatus = document.getElementById('adminStatus');
            const userStatus = document.getElementById('userStatus');
            const currentAdminPassword = document.getElementById('currentAdminPassword');
            const currentUserPassword = document.getElementById('currentUserPassword');
            
            if (adminStatus) {
                if (systemSettings.adminEnabled && systemSettings.adminPassword) {
                    adminStatus.textContent = 'W≈ÅƒÑCZONY';
                    adminStatus.className = 'role-status status-enabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleAdminRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'WY≈ÅƒÑCZ';
                    if (currentAdminPassword) currentAdminPassword.textContent = systemSettings.adminPassword;
                } else {
                    adminStatus.textContent = 'WY≈ÅƒÑCZONY';
                    adminStatus.className = 'role-status status-disabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleAdminRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'W≈ÅƒÑCZ';
                    if (currentAdminPassword) currentAdminPassword.textContent = systemSettings.adminPassword || 'brak';
                }
            }
            
            if (userStatus) {
                if (systemSettings.userEnabled && systemSettings.userPassword) {
                    userStatus.textContent = 'W≈ÅƒÑCZONY';
                    userStatus.className = 'role-status status-enabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleUserRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'WY≈ÅƒÑCZ';
                    if (currentUserPassword) currentUserPassword.textContent = systemSettings.userPassword;
                } else {
                    userStatus.textContent = 'WY≈ÅƒÑCZONY';
                    userStatus.className = 'role-status status-disabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleUserRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'W≈ÅƒÑCZ';
                    if (currentUserPassword) currentUserPassword.textContent = systemSettings.userPassword || 'brak';
                }
            }
        }
        
        async function toggleAdminRole() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostƒôp systemowy mo≈ºe zmieniaƒá ustawienia!');
                return;
            }
            
            const passwordInput = document.getElementById('adminPasswordInput');
            if (!passwordInput) return;
            
            const newPassword = passwordInput.value;
            const newStatus = !systemSettings.adminEnabled;
            
            if (newStatus && (!newPassword || newPassword.length < 3)) {
                alert('Musisz ustawiƒá has≈Ço (minimum 3 znaki) aby w≈ÇƒÖczyƒá dostƒôp Premium!');
                passwordInput.focus();
                return;
            }
            
            if (newPassword && newPassword.length > 0) {
                systemSettings.adminPassword = newPassword;
            }
            
            systemSettings.adminEnabled = newStatus;
            
            try {
                await db.collection('system').doc('settings').update({
                    adminEnabled: newStatus,
                    adminPassword: systemSettings.adminPassword,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                passwordInput.value = '';
                updateRoleStatusDisplay();
                
                const statusText = newStatus ? 'w≈ÇƒÖczony' : 'wy≈ÇƒÖczony';
                alert(`‚úÖ Dostƒôp Premium zosta≈Ç ${statusText}!`);
            } catch (error) {
                alert('B≈ÇƒÖd aktualizacji ustawie≈Ñ: ' + error.message);
            }
        }
        
        async function toggleUserRole() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostƒôp systemowy mo≈ºe zmieniaƒá ustawienia!');
                return;
            }
            
            const passwordInput = document.getElementById('userPasswordInput');
            if (!passwordInput) return;
            
            const newPassword = passwordInput.value;
            const newStatus = !systemSettings.userEnabled;
            
            if (newStatus && (!newPassword || newPassword.length < 3)) {
                alert('Musisz ustawiƒá has≈Ço (minimum 3 znaki) aby w≈ÇƒÖczyƒá dostƒôp U≈ºytkownika!');
                passwordInput.focus();
                return;
            }
            
            if (newPassword && newPassword.length > 0) {
                systemSettings.userPassword = newPassword;
            }
            
            systemSettings.userEnabled = newStatus;
            
            try {
                await db.collection('system').doc('settings').update({
                    userEnabled: newStatus,
                    userPassword: systemSettings.userPassword,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                passwordInput.value = '';
                updateRoleStatusDisplay();
                
                const statusText = newStatus ? 'w≈ÇƒÖczony' : 'wy≈ÇƒÖczony';
                alert(`‚úÖ Dostƒôp U≈ºytkownika zosta≈Ç ${statusText}!`);
            } catch (error) {
                alert('B≈ÇƒÖd aktualizacji ustawie≈Ñ: ' + error.message);
            }
        }
        
        // Formatowanie nazwisk
        function formatPlayerName(playerName, forGuest = false) {
            if (!forGuest || currentUserRole !== 'guest') {
                return playerName;
            }
            
            const parts = playerName.trim().split(' ');
            
            if (parts.length === 1) {
                return playerName;
            } else if (parts.length >= 2) {
                const firstName = parts[0];
                const lastName = parts[parts.length - 1];
                const lastNameInitial = lastName.charAt(0).toUpperCase();
                return `${firstName} ${lastNameInitial}.`;
            }
            
            return playerName;
        }
        
        // Obs≈Çuga danych z Firestore
        function loadData() {
            if (!db) {
                console.error('Brak po≈ÇƒÖczenia z Firestore');
                return;
            }
            
            // Gracze
            if (unsubscribePlayers) unsubscribePlayers();
            unsubscribePlayers = db.collection('players')
                .orderBy('elo', 'desc')
                .onSnapshot(snapshot => {
                    players = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        players.push({
                            id: doc.id,
                            name: data.name || '',
                            elo: data.elo || 1500,
                            code: data.code || '00000',
                            createdAt: data.createdAt || new Date(),
                            createdBy: data.createdBy || 'unknown'
                        });
                    });
                    updateAllDisplays();
                }, error => {
                    console.error("B≈ÇƒÖd ≈Çadowania graczy:", error);
                });
            
            // Historia
            if (unsubscribeHistory) unsubscribeHistory();
            unsubscribeHistory = db.collection('history')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .onSnapshot(snapshot => {
                    history = [];
                    snapshot.forEach(doc => {
                        history.push(doc.data());
                    });
                    updateHistory();
                }, error => {
                    console.error("B≈ÇƒÖd ≈Çadowania historii:", error);
                });
            
            loadSystemSettings();
        }
        
        // Operacje na graczach
        async function addNewPlayer() {
            if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
                alert('Tylko dostƒôp Premium lub systemowy mo≈ºe dodawaƒá graczy!');
                return;
            }
            
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            const nameInput = document.getElementById('newPlayerName');
            const eloInput = document.getElementById('newPlayerElo');
            const codeInput = document.getElementById('newPlayerCode');
            
            if (!nameInput || !eloInput || !codeInput) return;
            
            const name = nameInput.value.trim();
            const elo = parseInt(eloInput.value) || 1500;
            const code = codeInput.value;
            
            if (!name) {
                alert('Wpisz imiƒô gracza!');
                nameInput.focus();
                return;
            }
            
            if (!code || code.length !== 5) {
                alert('Kod musi mieƒá dok≈Çadnie 5 cyfr!');
                codeInput.focus();
                return;
            }
            
            if (!/^\d{5}$/.test(code)) {
                alert('Kod mo≈ºe zawieraƒá tylko cyfry!');
                codeInput.focus();
                return;
            }
            
            const existingPlayer = players.find(p => 
                p.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingPlayer) {
                alert(`Gracz "${name}" ju≈º istnieje!`);
                return;
            }
            
            try {
                await db.collection('players').add({
                    name: name,
                    elo: elo,
                    code: code,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUserRole
                });
                
                nameInput.value = '';
                eloInput.value = 1500;
                codeInput.value = '';
                
                generateRandomCode();
                
                alert(`‚úÖ Dodano gracza: ${name}\nELO: ${elo}\nKod: ${code}`);
            } catch (error) {
                alert('B≈ÇƒÖd dodawania gracza: ' + error.message);
            }
        }
        
        async function addNewPlayerDev() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostƒôp systemowy mo≈ºe dodawaƒá graczy z tego panelu!');
                return;
            }
            
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            const nameInput = document.getElementById('devNewPlayerName');
            const eloInput = document.getElementById('devNewPlayerElo');
            const codeInput = document.getElementById('devNewPlayerCode');
            
            if (!nameInput || !eloInput || !codeInput) return;
            
            const name = nameInput.value.trim();
            const elo = parseInt(eloInput.value) || 1500;
            const code = codeInput.value;
            
            if (!name) {
                alert('Wpisz imiƒô gracza!');
                nameInput.focus();
                return;
            }
            
            if (!code || code.length !== 5) {
                alert('Kod musi mieƒá dok≈Çadnie 5 cyfr!');
                codeInput.focus();
                return;
            }
            
            if (!/^\d{5}$/.test(code)) {
                alert('Kod mo≈ºe zawieraƒá tylko cyfry!');
                codeInput.focus();
                return;
            }
            
            const existingPlayer = players.find(p => 
                p.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingPlayer) {
                alert(`Gracz "${name}" ju≈º istnieje!`);
                return;
            }
            
            try {
                await db.collection('players').add({
                    name: name,
                    elo: elo,
                    code: code,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUserRole
                });
                
                nameInput.value = '';
                eloInput.value = 1500;
                codeInput.value = '';
                
                generateRandomCodeDev();
                
                alert(`‚úÖ Dodano gracza: ${name}\nELO: ${elo}\nKod: ${code}`);
            } catch (error) {
                alert('B≈ÇƒÖd dodawania gracza: ' + error.message);
            }
        }
        
        async function deletePlayer(playerId) {
            if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
                alert('Tylko dostƒôp Premium lub systemowy mo≈ºe usuwaƒá graczy!');
                return;
            }
            
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            if (confirm('Czy na pewno chcesz usunƒÖƒá tego gracza?')) {
                try {
                    await db.collection('players').doc(playerId).delete();
                    alert('Gracz usuniƒôty!');
                } catch (error) {
                    alert('B≈ÇƒÖd usuwania gracza: ' + error.message);
                }
            }
        }
        
        // Zamiana graczy
        function swapPlayers() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            const swapBtn = document.getElementById('swapBtn');
            
            if (!selectA || !selectB) return;
            
            const playerAId = selectA.value;
            const playerBId = selectB.value;
            
            if (!playerAId || !playerBId) {
                return;
            }
            
            if (playerAId === playerBId) {
                return;
            }
            
            const temp = playerAId;
            selectA.value = playerBId;
            selectB.value = temp;
            
            updateButtons();
            updateChanceDisplay();
            
            if (swapBtn) {
                swapBtn.style.transform = 'rotate(180deg)';
                swapBtn.style.transition = 'transform 0.3s';
                
                setTimeout(() => {
                    swapBtn.style.transform = 'rotate(0deg)';
                }, 300);
            }
        }
        
        // Event listeners dla select√≥w
        function onPlayerSelectChange() {
            updateButtons();
            updateChanceDisplay();
            updateSwapButton();
        }
        
        // Funkcje przycisk√≥w meczu
        function playerAWins() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz r√≥≈ºnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 1
            };
            
            showCodeModal('A', playerA.name);
        }
        
        function playerBWins() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz r√≥≈ºnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 0
            };
            
            showCodeModal('A', playerA.name);
        }
        
        function draw() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz r√≥≈ºnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 0.5
            };
            
            showCodeModal('A', playerA.name);
        }
        
        // Calculate match final
        async function calculateMatchFinal(scoreA, playerA, playerB) {
            console.log('calculateMatchFinal called:', { scoreA, playerA: playerA.name, playerB: playerB.name });
            
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            const expectedA = 1 / (1 + Math.pow(10, (playerB.elo - playerA.elo) / 400));
            const change = Math.round(32 * (scoreA - expectedA));
            
            const newEloA = playerA.elo + change;
            const newEloB = playerB.elo - change;
            
            const matchData = {
                playerA: playerA.name,
                playerB: playerB.name,
                playerAId: playerA.id,
                playerBId: playerB.id,
                result: scoreA === 1 ? 'A' : scoreA === 0 ? 'B' : 'D',
                change: change,
                eloABefore: playerA.elo,
                eloBBefore: playerB.elo,
                eloAAfter: newEloA,
                eloBAfter: newEloB,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                date: new Date().toLocaleString(),
                playedBy: currentUserRole,
                verified: true
            };
            
            console.log('Match data to save:', matchData);
            
            try {
                const batch = db.batch();
                
                const playerARef = db.collection('players').doc(playerA.id);
                batch.update(playerARef, { elo: newEloA });
                
                const playerBRef = db.collection('players').doc(playerB.id);
                batch.update(playerBRef, { elo: newEloB });
                
                const historyRef = db.collection('history').doc();
                batch.set(historyRef, matchData);
                
                await batch.commit();
                
                console.log('‚úÖ Mecz zapisany pomy≈õlnie!');
                showMatchDetails(playerA, playerB, change, scoreA);
                
                setTimeout(() => {
                    updateAllDisplays();
                }, 500);
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd zapisywania meczu:', error);
                
                if (error.code === 'permission-denied') {
                    alert('‚ùå B≈ÇƒÖd uprawnie≈Ñ Firebase!\nSprawd≈∫ czy regu≈Çy Firestore pozwalajƒÖ na zapis.\nB≈ÇƒÖd: ' + error.message);
                } else {
                    alert('B≈ÇƒÖd zapisywania meczu: ' + error.message);
                }
            }
        }
        
        function showMatchDetails(playerA, playerB, change, scoreA) {
            const resultText = scoreA === 1 ? `${playerA.name} wygra≈Ç z ${playerB.name}` :
                              scoreA === 0 ? `${playerB.name} wygra≈Ç z ${playerA.name}` :
                              `${playerA.name} zremisowa≈Ç z ${playerB.name}`;
            
            const changeText = change > 0 ? `+${change}` : change;
            const message = `
                ${resultText}
                
                ${playerA.name}: ${playerA.elo} ‚Üí ${playerA.elo + change} (${changeText})
                ${playerB.name}: ${playerB.elo} ‚Üí ${playerB.elo - change} (${-change})
                
                Data: ${new Date().toLocaleString()}
                ‚úÖ Mecz zweryfikowany kodami
            `;
            
            alert(message);
        }
        
        // Funkcje pomocnicze
        function updateAllDisplays() {
            updatePlayerSelects();
            updatePlayersList();
            updateChanceDisplay();
            updateSwapButton();
        }
        
        function updateSwapButton() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            const swapBtn = document.getElementById('swapBtn');
            
            if (!selectA || !selectB || !swapBtn) return;
            
            const playerAId = selectA.value;
            const playerBId = selectB.value;
            
            if (playerAId && playerBId && playerAId !== playerBId) {
                swapBtn.disabled = false;
                swapBtn.title = "Zamie≈Ñ graczy miejscami";
            } else {
                swapBtn.disabled = true;
                swapBtn.title = "Wybierz r√≥≈ºnych graczy aby zamieniƒá";
            }
        }
        
        function updatePlayerSelects() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            
            if (!selectA || !selectB) return;
            
            const currentA = selectA.value;
            const currentB = selectB.value;
            
            selectA.innerHTML = '<option value="">Wybierz gracza</option>';
            selectB.innerHTML = '<option value="">Wybierz gracza</option>';
            
            players.forEach(player => {
                const displayName = formatPlayerName(player.name, true);
                const option = `<option value="${player.id}">${displayName} (${player.elo})</option>`;
                selectA.innerHTML += option;
                selectB.innerHTML += option;
            });
            
            if (currentA && players.some(p => p.id === currentA)) selectA.value = currentA;
            if (currentB && players.some(p => p.id === currentB)) selectB.value = currentB;
            
            updateButtons();
            updateSwapButton();
        }
        
        function updateButtons() {
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            const btnA = document.getElementById('btnA');
            const btnB = document.getElementById('btnB');
            const btnDraw = document.getElementById('btnDraw');
            
            if (btnA) {
                if (playerA) {
                    const displayName = formatPlayerName(playerA.name, true);
                    btnA.textContent = displayName.toUpperCase() + ' WYGRYWA';
                    btnA.disabled = (currentUserRole === 'guest');
                } else {
                    btnA.textContent = 'GRACZ A wygrywa';
                    btnA.disabled = true;
                }
            }
            
            if (btnB) {
                if (playerB) {
                    const displayName = formatPlayerName(playerB.name, true);
                    btnB.textContent = displayName.toUpperCase() + ' WYGRYWA';
                    btnB.disabled = (currentUserRole === 'guest');
                } else {
                    btnB.textContent = 'GRACZ B wygrywa';
                    btnB.disabled = true;
                }
            }
            
            if (btnDraw) {
                if (playerA && playerB) {
                    btnDraw.disabled = (currentUserRole === 'guest');
                } else {
                    btnDraw.disabled = true;
                }
            }
        }
        
        function getSelectedPlayer(player) {
            const selectId = player === 'A' ? 'selectPlayerA' : 'selectPlayerB';
            const select = document.getElementById(selectId);
            if (!select) return null;
            
            const playerId = select.value;
            return players.find(p => p.id === playerId);
        }
        
        function updateChanceDisplay() {
            const chanceElement = document.getElementById('chance');
            if (!chanceElement) return;
            
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                chanceElement.textContent = 'Wybierz obu graczy aby zobaczyƒá szanse';
                return;
            }
            
            const expected = 1 / (1 + Math.pow(10, (playerB.elo - playerA.elo) / 400));
            const percent = Math.round(expected * 100);
            const displayName = formatPlayerName(playerA.name, true);
            chanceElement.textContent = `Szansa ${displayName}: ${percent}%`;
        }
        
        function updatePlayersList() {
            const listElement = document.getElementById('allPlayersList');
            if (!listElement) return;
            
            const sortedPlayers = [...players].sort((a, b) => b.elo - a.elo);
            
            if (sortedPlayers.length === 0) {
                listElement.innerHTML = '<div>Brak graczy. Dostƒôp Premium lub systemowy mo≈ºe dodaƒá pierwszego!</div>';
                return;
            }
            
            listElement.innerHTML = sortedPlayers.map((player, index) => {
                let button = '';
                
                if (currentUserRole === 'admin' || currentUserRole === 'dev') {
                    button = `<button class="delete-btn" onclick="deletePlayer('${player.id}')" title="Usu≈Ñ gracza">‚úï</button>`;
                } else {
                    button = `<div class="lock-btn" title="Tylko dostƒôp Premium mo≈ºe usuwaƒá">üîí</div>`;
                }
                
                const displayName = formatPlayerName(player.name, true);
                const emoji = player.elo > 1500 ? 'üìà' : player.elo < 1500 ? 'üìâ' : '‚ûñ';
                
                const codeDisplay = currentUserRole === 'dev' 
                    ? `<br><small>Kod: <span class="player-code">${player.code}</span></small>`
                    : '';
                
                return `
                <div class="player-item">
                    <div style="flex: 1;">
                        <strong>${index + 1}. <span class="player-name-truncate">${displayName}</span></strong><br>
                        <small>ELO: ${player.elo} ${emoji}${codeDisplay}</small>
                    </div>
                    ${button}
                </div>
                `;
            }).join('');
        }
        
        function updateHistory() {
            const historyElement = document.getElementById('historyList');
            if (!historyElement) return;
            
            if (history.length === 0) {
                historyElement.innerHTML = '-';
                return;
            }
            
            historyElement.innerHTML = history.map(match => {
                const playerADisplay = formatPlayerName(match.playerA, true);
                const playerBDisplay = formatPlayerName(match.playerB, true);
                
                const verifiedIcon = match.verified ? ' ‚úÖ' : '';
                
                return `
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #444; font-size: 14px;">
                    <div><strong>${playerADisplay} vs ${playerBDisplay}${verifiedIcon}</strong></div>
                    <div>Wynik: ${match.result === 'A' ? `üèÜ ${playerADisplay}` : match.result === 'B' ? `üèÜ ${playerBDisplay}` : 'ü§ù Remis'}</div>
                    <div>Zmiana: ${match.change > 0 ? '+' : ''}${match.change}</div>
                    <div style="font-size: 12px; color: #aaa;">${match.date}</div>
                </div>
                `;
            }).join('');
        }
        
        // Inicjalizacja
        function getDeviceId() {
            const deviceInfo = navigator.userAgent + navigator.platform + navigator.language;
            let hash = 0;
            for (let i = 0; i < deviceInfo.length; i++) {
                const char = deviceInfo.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'device_' + Math.abs(hash).toString(16);
        }
        
        // G≈Ç√≥wna inicjalizacja aplikacji
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Strona za≈Çadowana, inicjalizujƒô Firebase...');
            
            // Inicjalizuj Firebase
            const firebaseInstance = initializeFirebase();
            
            if (!firebaseInstance) {
                // Firebase nie zosta≈Ç zainicjalizowany - pokazano formularz konfiguracji
                console.log('Firebase nie zosta≈Ç zainicjalizowany, oczekujƒô na konfiguracjƒô u≈ºytkownika');
                return;
            }
            
            // Przypisz instancje Firebase do zmiennych globalnych
            db = firebaseInstance.db;
            auth = firebaseInstance.auth;
            
            console.log('Aplikacja zainicjalizowana, ≈Çadujƒô dane...');
            
            // Za≈Çaduj dane
            loadData();
            updateUIForRole();
            updateMenuForRole();
            
            // Dodaj event listeners
            setTimeout(() => {
                const selectPlayerA = document.getElementById('selectPlayerA');
                const selectPlayerB = document.getElementById('selectPlayerB');
                
                if (selectPlayerA) {
                    selectPlayerA.addEventListener('change', onPlayerSelectChange);
                }
                
                if (selectPlayerB) {
                    selectPlayerB.addEventListener('change', onPlayerSelectChange);
                }
                
                // Event listener dla Enter w polu has≈Ça
                const adminPasswordInput = document.getElementById('adminPassword');
                if (adminPasswordInput) {
                    adminPasswordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            login();
                        }
                    });
                }
                
                // Obs≈Çuga ESC w modalach
                document.addEventListener('keydown', function(event) {
                    const modal = document.getElementById('codeModal');
                    if (event.key === 'Escape' && modal && modal.classList.contains('active')) {
                        closeCodeModal();
                    }
                });
                
                // Klikniƒôcie poza modal
                const modalOverlay = document.getElementById('codeModal');
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', function(event) {
                        if (event.target === this) {
                            closeCodeModal();
                        }
                    });
                }
                
                // Generuj kody
                generateRandomCode();
                generateRandomCodeDev();
                
            }, 500);
            
            console.log('‚úÖ Aplikacja gotowa do u≈ºycia!');
        });
    </script>
</body>
</html>