<!DOCTYPE html>
<html>
<head>
    <title>Kalkulator ELO Dart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { margin: 0; padding: 0; background: #1a1a1a; color: white; }
        
        /* MENU NAWIGACYJNE - RESPONSYWNE */
        .nav-menu {
            display: flex;
            background: #2d2d2d;
            padding: 0;
            border-bottom: 2px solid #4CAF50;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
        }
        .nav-btn {
            flex: 1 0 auto;
            min-width: 120px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        @media (max-width: 480px) {
            .nav-btn {
                min-width: 90px;
                padding: 10px 5px;
                font-size: 12px;
            }
            .nav-btn span {
                font-size: 10px;
            }
        }
        @media (max-width: 360px) {
            .nav-btn {
                min-width: 80px;
                padding: 8px 4px;
                font-size: 11px;
            }
        }
        .nav-btn:hover {
            background: #3a3a3a;
            color: white;
        }
        .nav-btn.active {
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
            font-weight: bold;
            background: #333;
        }
        .nav-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .nav-btn.disabled:hover {
            background: transparent;
            color: #aaa;
        }
        .nav-icon {
            font-size: 18px;
        }
        @media (max-width: 480px) {
            .nav-icon {
                font-size: 16px;
            }
        }
        
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 15px; 
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
        }
        
        h1 { 
            text-align: center; 
            color: #4CAF50; 
            margin-bottom: 20px; 
            margin-top: 10px; 
            font-size: 22px;
        }
        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
                margin-bottom: 15px;
            }
        }
        
        /* ===== STYLE Z PIERWSZEGO KODU ===== */
        .player-box { 
            background: #2d2d2d; 
            padding: 12px; 
            margin: 12px 0; 
            border-radius: 8px; 
        }
        @media (max-width: 480px) {
            .player-box {
                padding: 10px;
                margin: 10px 0;
            }
        }
        
        .input-group { margin-bottom: 8px; }
        label { display: block; margin-bottom: 4px; color: #aaa; font-size: 14px; }
        input { 
            width: 100%; 
            padding: 10px; 
            font-size: 16px; 
            border: 1px solid #444; 
            background: #333; 
            color: white; 
            border-radius: 5px; 
        }
        @media (max-width: 480px) {
            input {
                padding: 8px;
                font-size: 15px;
            }
        }
        
        .elo-display { font-size: 22px; font-weight: bold; margin: 8px 0; }
        @media (max-width: 480px) {
            .elo-display {
                font-size: 20px;
            }
        }
        
        .chance { 
            text-align: center; 
            font-size: 16px; 
            margin: 15px 0; 
            color: #BB86FC; 
            padding: 8px;
            background: rgba(187, 134, 252, 0.1);
            border-radius: 5px;
        }
        @media (max-width: 480px) {
            .chance {
                font-size: 15px;
                margin: 12px 0;
                padding: 6px;
            }
        }
        
        .buttons { 
            display: flex; 
            gap: 8px; 
            margin: 15px 0; 
            flex-wrap: wrap;
        }
        @media (max-width: 480px) {
            .buttons {
                gap: 6px;
                margin: 12px 0;
            }
        }
        
        button { 
            flex: 1; 
            padding: 12px; 
            font-size: 14px; 
            border: none; 
            border-radius: 5px; 
            color: white; 
            cursor: pointer; 
            min-width: 100px;
        }
        @media (max-width: 480px) {
            button {
                padding: 10px 8px;
                font-size: 13px;
                min-width: 0;
            }
        }
        
        .btn-win1 { background: #4CAF50; }
        .btn-win2 { background: #F44336; }
        .btn-draw { background: #FF9800; }
        .btn-add { background: #9C27B0; }
        .btn-login { background: #2196F3; }
        .btn-logout { background: #f44336; }
        .btn-dev { background: #FFFFFF; color: #1a1a1a; }
        .btn-toggle { background: #607D8B; }
        
        .history { 
            margin-top: 25px; 
            background: #2d2d2d; 
            padding: 12px; 
            border-radius: 8px; 
        }
        .players-list { margin-top: 15px; }
        .player-item { 
            background: #333; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .player-item:nth-child(odd) { background: #3a3a3a; }
        
        /* PRZYCISKI USUWANIA */
        .delete-btn { 
            background: #f44336; 
            color: white; 
            border: none; 
            width: 30px; 
            height: 30px; 
            min-width: 30px;
            min-height: 30px;
            border-radius: 5px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 14px;
            padding: 0;
            flex-shrink: 0;
        }
        @media (max-width: 480px) {
            .delete-btn, .lock-btn {
                width: 28px;
                height: 28px;
                min-width: 28px;
                min-height: 28px;
                font-size: 13px;
            }
        }
        
        .lock-btn { 
            background: #FF9800; 
            color: white; 
            border: none; 
            width: 30px; 
            height: 30px; 
            min-width: 30px;
            min-height: 30px;
            border-radius: 5px; 
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            padding: 0;
            flex-shrink: 0;
        }
        
        select { 
            width: 100%; 
            padding: 10px; 
            background: #333; 
            color: white; 
            border: 1px solid #444; 
            border-radius: 5px; 
            font-size: 15px;
        }
        @media (max-width: 480px) {
            select {
                padding: 8px;
                font-size: 14px;
            }
        }
        
        .login-box { 
            background: #2d2d2d; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            text-align: center; 
        }
        .admin-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #FF9800; 
        }
        .user-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #2196F3; 
        }
        .dev-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #FFFFFF; 
        }
        .hidden { display: none; }
        .role-badge { 
            display: inline-block; 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: bold; 
            margin-left: 8px; 
        }
        @media (max-width: 480px) {
            .role-badge {
                font-size: 10px;
                padding: 2px 6px;
                margin-left: 6px;
            }
        }
        
        .admin-badge { background: #FF9800; color: black; }
        .user-badge { background: #2196F3; color: white; }
        .dev-badge { background: #FFFFFF; color: #1a1a1a; border: 1px solid #ccc; }
        .swap-btn { 
            background: transparent; 
            border: none; 
            color: #BB86FC; 
            cursor: pointer; 
            font-size: 22px; 
            padding: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 480px) {
            .swap-btn {
                font-size: 20px;
                padding: 0 6px;
            }
        }
        
        .swap-btn:hover { color: #ffffff; }
        .swap-btn:disabled { 
            color: #666; 
            cursor: not-allowed; 
        }
        .player-select-row {
            display: flex; 
            gap: 5px; 
            margin-bottom: 10px;
            align-items: center;
        }
        
        /* STRONY */
        .page { display: none; }
        .page.active { display: block; }
        
        /* MODAL DO WERYFIKACJI KODU - POPRAWIONY */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            border: 2px solid #4CAF50;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        
        .code-input {
            letter-spacing: 8px;
            font-size: 24px;
            text-align: center;
            font-family: monospace;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            margin: 10px 0;
            transition: all 0.3s;
        }
        
        .code-input.error {
            border-color: #f44336;
            animation: shake 0.5s;
        }
        
        .code-input.success {
            border-color: #4CAF50;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .player-name-highlight {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
            margin: 10px 0;
            text-align: center;
            padding: 8px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
        }
        
        /* PRZYCISK ANULUJ - WYŚRODKOWANY */
        .cancel-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn-cancel-modal {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-cancel-modal:hover {
            background: #d32f2f;
        }
        
        /* STRONA GRY */
        .games-page {
            padding: 15px;
        }
        
        .game-modes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .game-mode-card {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .game-mode-card:hover {
            border-color: #4CAF50;
            transform: translateY(-5px);
            background: #333;
        }
        
        .game-mode-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .game-mode-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #4CAF50;
        }
        
        .game-mode-description {
            font-size: 13px;
            color: #aaa;
        }
        
        /* Strona wyboru graczy do gry */
        .game-setup-page {
            padding: 15px;
        }
        
        /* Strona samej gry 501 */
        .game-501-page {
            padding: 15px;
        }
        
        .game-header {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .players-scoreboard {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .players-scoreboard {
                flex-direction: column;
            }
        }
        
        .player-score {
            flex: 1;
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 3px solid #444;
            transition: all 0.3s;
        }
        
        .player-score.active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .player-score.winner {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .player-name-large {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        .player-score.active .player-name-large {
            color: #FFFFFF;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .current-score {
            font-size: 60px;
            font-weight: bold;
            margin: 15px 0;
            color: #BB86FC;
        }
        
        .legs-info {
            font-size: 16px;
            color: #aaa;
            margin-top: 10px;
        }
        
        .dart-input-section {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .dart-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .dart-input-group {
            flex: 1;
            min-width: 150px;
        }
        
        .dart-input-label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 14px;
        }
        
        .dart-points-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            text-align: center;
            background: #333;
            border: 2px solid #444;
            color: white;
            border-radius: 8px;
        }
        
        .dart-points-input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .dart-multiplier {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .multiplier-btn {
            flex: 1;
            padding: 10px;
            background: #333;
            border: 2px solid #444;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .multiplier-btn:hover {
            background: #444;
        }
        
        .multiplier-btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        
        .current-turn-info {
            text-align: center;
            padding: 15px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .game-action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-submit-darts {
            flex: 2;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-submit-darts:hover {
            background: #3d8b40;
        }
        
        .btn-submit-darts:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .btn-undo {
            flex: 1;
            background: #FF9800;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .btn-undo:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .turn-history {
            margin-top: 30px;
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
        }
        
        .turn-history h3 {
            margin-top: 0;
            color: #BB86FC;
        }
        
        .turn-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #444;
            font-size: 14px;
        }
        
        .turn-item:last-child {
            border-bottom: none;
        }
        
        .dart-score {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(187, 134, 252, 0.2);
            margin-right: 5px;
        }
        
        /* Strona wyników gry */
        .game-results-page {
            padding: 15px;
            text-align: center;
        }
        
        .results-container {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 30px;
            margin: 20px auto;
            max-width: 600px;
        }
        
        .winner-celebration {
            font-size: 32px;
            color: #FFD700;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .stats-table th, .stats-table td {
            padding: 12px;
            border-bottom: 1px solid #444;
            text-align: center;
        }
        
        .stats-table th {
            background: #333;
            color: #4CAF50;
        }
        
        .stats-table tr:hover {
            background: #3a3a3a;
        }
        
        .elo-options {
            margin-top: 30px;
            background: rgba(76, 175, 80, 0.1);
            padding: 20px;
            border-radius: 10px;
        }
        
        /* STRONA INFO */
        .info-page {
            padding: 15px;
        }
        
        .info-box {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        @media (max-width: 480px) {
            .info-box {
                padding: 12px;
                font-size: 13px;
            }
        }
        
        .coming-soon {
            text-align: center;
            font-size: 22px;
            color: #BB86FC;
            margin-top: 40px;
            padding: 20px;
        }
        @media (max-width: 480px) {
            .coming-soon {
                font-size: 20px;
                margin-top: 30px;
                padding: 15px;
            }
        }
        
        /* MOBILE OPTIMIZATION */
        .mobile-only { display: none; }
        .desktop-only { display: block; }
        
        @media (max-width: 480px) {
            .mobile-only { display: block; }
            .desktop-only { display: none; }
        }
        
        /* Lepsze zarządzanie tekstem na małych ekranach */
        .player-name-truncate {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        @media (max-width: 480px) {
            .player-name-truncate {
                max-width: 120px;
            }
        }
        @media (max-width: 360px) {
            .player-name-truncate {
                max-width: 100px;
            }
        }
        
        /* KOD W LISCIE GRACZY */
        .player-code {
            background: rgba(76, 175, 80, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #4CAF50;
        }
        
        /* ADMIN PANEL IMPROVEMENTS */
        .admin-input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .admin-input-group {
            flex: 1;
        }
        
        .generate-code-btn {
            background: #607D8B;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            height: 42px;
            min-width: 80px;
        }
        
        .generate-code-btn:hover {
            background: #546E7A;
        }
        
        /* DEV PANEL STYLES */
        .role-toggle-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .role-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-enabled {
            background: #4CAF50;
            color: white;
        }
        
        .status-disabled {
            background: #f44336;
            color: white;
        }
        
        .dev-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        
        .password-input {
            flex: 2;
        }
        
        .toggle-btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* ===== NOWE STYLE DLA STRONY RANG I SEZONÓW ===== */
        .ranks-page {
            padding: 15px;
        }
        
        /* Status sezonu na górze */
        .season-status {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #4CAF50;
        }
        
        .season-status.off-season {
            border-color: #666;
        }
        
        .season-status.running {
            border-color: #4CAF50;
        }
        
        .season-status.ended {
            border-color: #FF9800;
        }
        
        .season-name {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        
        .season-dates {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .season-days-left {
            font-size: 13px;
            color: #FF9800;
            font-weight: bold;
        }
        
        /* Kontener rangi */
        .rank-container {
            background: #2d2d2d;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            border-left: 5px solid #4CAF50;
            transition: all 0.3s ease;
            flex-wrap: wrap;
        }
        
        /* SPECJALNE KOLORY DLA RANG 1 I 9 */
        .rank-1 {
            border-left-color: #2196F3 !important;
        }
        
        .rank-1 .rank-number {
            background: #2196F3 !important;
        }
        
        .rank-1 .rank-name {
            color: #2196F3 !important;
        }
        
        .rank-9 {
            border-left-color: #F44336 !important;
        }
        
        .rank-9 .rank-number {
            background: #F44336 !important;
        }
        
        .rank-9 .rank-name {
            color: #F44336 !important;
        }
        
        .rank-container:hover {
            background: #333;
            transform: translateX(5px);
        }
        
        /* Numer rangi */
        .rank-number {
            width: 40px;
            height: 40px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin-right: 15px;
        }
        
        /* Kontener obrazka */
        .rank-image-container {
            width: 80px;
            height: 80px;
            background: #1a1a1a;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 15px;
            border: 2px solid #444;
            overflow: hidden;
            position: relative;
        }
        
        @media (max-width: 480px) {
            .rank-image-container {
                width: 60px;
                height: 60px;
                margin-right: 10px;
            }
        }
        
        /* Obrazek */
        .rank-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Informacje o randze */
        .rank-info {
            flex: 1;
            min-width: 200px;
        }
        
        .rank-name {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        
        .rank-elo {
            font-size: 14px;
            color: #aaa;
        }
        
        /* Lista graczy na randze */
        .rank-players {
            flex: 2;
            min-width: 250px;
            margin-left: 30px;
        }
        
        @media (max-width: 768px) {
            .rank-container {
                flex-wrap: wrap;
            }
            .rank-players {
                margin-left: 0;
                margin-top: 15px;
                width: 100%;
            }
        }
        
        .players-on-rank {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .player-on-rank {
            background: #3a3a3a;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .player-on-rank-elo {
            color: #4CAF50;
            font-weight: bold;
            font-size: 12px;
            background: rgba(76, 175, 80, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .no-players {
            color: #777;
            font-style: italic;
            font-size: 14px;
        }
        
        /* Przyciski na dole strony rang */
        .ranks-footer {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }
        
        .ranks-footer-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        @media (max-width: 480px) {
            .ranks-footer-buttons {
                flex-direction: column;
            }
            .ranks-footer-btn {
                width: 100%;
            }
        }
        
        .ranks-footer-btn {
            padding: 12px 25px;
            background: #2d2d2d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .ranks-footer-btn:hover {
            background: #3a3a3a;
            border-color: #4CAF50;
        }
        
        .admin-season-btn {
            background: #9C27B0 !important;
            margin-top: 10px;
        }
        
        .admin-season-btn:hover {
            border-color: #9C27B0 !important;
        }
        
        .admin-season-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666 !important;
        }
        
        .admin-season-btn.disabled:hover {
            border-color: transparent !important;
            background: #666 !important;
        }
        
        .dev-end-season-btn {
            background: #F44336 !important;
            margin-top: 10px;
        }
        
        .dev-end-season-btn:hover {
            border-color: #F44336 !important;
        }
        
        /* Strona osiągnięć */
        .achievements-page, .seasons-page, .new-season-page {
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .achievement-container, .season-container, .new-season-form {
            background: #2d2d2d;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
        }
        
        .achievement-container {
            border-left: 5px solid #FF9800;
        }
        
        .season-container {
            border-left: 5px solid #2196F3;
            display: block;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .season-container:hover {
            border-left-color: #4CAF50;
            background: #333;
        }
        
        .season-container.expanded {
            border-left-color: #FF9800;
            background: #2d2d2d;
            margin-bottom: 20px;
            padding: 25px;
        }
        
        .new-season-form {
            border-left: 5px solid #9C27B0;
            display: block;
        }
        
        /* Kontener obrazka osiągnięcia */
        .achievement-image-container {
            width: 70px;
            height: 70px;
            background: #7bdbff !important;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 20px;
            border: 2px solid #444;
            overflow: hidden;
            position: relative;
        }
        
        @media (max-width: 480px) {
            .achievement-image-container {
                width: 50px;
                height: 50px;
                margin-right: 15px;
            }
        }
        
        /* Obrazek osiągnięcia */
        .achievement-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Kontener dla nazwy i opisu osiągnięcia */
        .achievement-text-container {
            flex: 1;
            min-width: 0;
        }
        
        .achievement-name, .season-name-in-list {
            font-size: 16px;
            font-weight: bold;
            color: #FF9800;
            margin-bottom: 5px;
        }
        
        .season-name-in-list {
            color: #2196F3;
            font-size: 18px;
            margin-top: 0;
        }
        
        .achievement-description, .season-details {
            font-size: 14px;
            color: #aaa;
            line-height: 1.4;
        }
        
        /* Licznik meczy w sezonie */
        .matches-counter {
            display: inline-block;
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        /* ROZSZERZONY WIDOK SEZONU */
        .season-expanded-content {
            display: none;
            margin-top: 20px;
            border-top: 1px solid #444;
            padding-top: 20px;
        }
        
        .season-expanded-content.show {
            display: block;
        }
        
        .season-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .season-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .season-podium {
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            width: 100%;
        }
        
        .season-player-ranking {
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            width: 100%;
        }
        
        .podium-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 5px;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: #2d2d2d;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .ranking-item:nth-child(odd) {
            background: #333;
        }
        
        .podium-place {
            width: 30px;
            height: 30px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .podium-place-1 {
            background: #FFD700 !important;
            color: #000;
        }
        
        .podium-place-2 {
            background: #C0C0C0 !important;
        }
        
        .podium-place-3 {
            background: #CD7F32 !important;
        }
        
        .ranking-place {
            width: 25px;
            height: 25px;
            background: #444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
            font-size: 12px;
        }
        
        .ranking-place-1 {
            background: #FFD700 !important;
            color: #000;
        }
        
        .ranking-place-2 {
            background: #C0C0C0 !important;
        }
        
        .ranking-place-3 {
            background: #CD7F32 !important;
        }
        
        .achievements-section {
            margin: 20px 0;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
        }
        
        .achievement-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 5px;
        }
        
        .achievement-item-image {
            width: 40px;
            height: 40px;
            background: #7bdbff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid #444;
        }
        
        .achievement-item-image img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .ranks-section {
            margin-top: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
        }
        
        .season-rank-item {
            background: #2d2d2d;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            border-left: 5px solid #4CAF50;
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        
        .season-rank-item.rank-1 {
            border-left-color: #2196F3;
        }
        
        .season-rank-item.rank-9 {
            border-left-color: #F44336;
        }
        
        .season-rank-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-basis: 100%;
        }
        
        .season-rank-number {
            width: 35px;
            height: 35px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .season-rank-item.rank-1 .season-rank-number {
            background: #2196F3;
        }
        
        .season-rank-item.rank-9 .season-rank-number {
            background: #F44336;
        }
        
        .season-rank-name {
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .season-rank-item.rank-1 .season-rank-name {
            color: #2196F3;
        }
        
        .season-rank-item.rank-9 .season-rank-name {
            color: #F44336;
        }
        
        .season-rank-elo {
            font-size: 12px;
            color: #aaa;
            margin-left: auto;
        }
        
        .season-rank-image-container {
            width: 60px;
            height: 60px;
            background: #1a1a1a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 15px;
            border: 2px solid #444;
            overflow: hidden;
            position: relative;
        }
        
        .season-rank-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .season-rank-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            flex-basis: calc(100% - 75px);
        }
        
        .season-rank-player {
            background: #3a3a3a;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .season-rank-player-elo {
            color: #4CAF50;
            font-weight: bold;
            font-size: 11px;
            background: rgba(76, 175, 80, 0.2);
            padding: 1px 5px;
            border-radius: 8px;
        }
        
        .back-to-ranks-btn {
            display: block;
            margin: 30px auto 0 auto;
            padding: 12px 30px;
            background: #2d2d2d;
            color: white;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
            text-align: center;
        }
        
        .back-to-ranks-btn:hover {
            background: #4CAF50;
        }
        
        /* Formularz nowego sezonu */
        .elo-thresholds {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .elo-threshold-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
        }
        
        .date-inputs {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (max-width: 480px) {
            .date-inputs {
                flex-direction: column;
            }
        }
        
        .season-action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-submit {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        
        /* Strona wyboru rozpoczęcia gry */
        .start-game-page {
            padding: 15px;
        }
        
        .start-game-info {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .selected-players-display {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (max-width: 480px) {
            .selected-players-display {
                flex-direction: column;
            }
        }
        
        .selected-player-card {
            flex: 1;
            background: #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .start-game-options {
            margin-top: 30px;
        }
        
        .start-option {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            border: 2px solid #444;
            transition: all 0.3s;
        }
        
        .start-option:hover {
            border-color: #4CAF50;
        }
        
        .start-option.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .start-option-title {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        
        /* ===== NOWY SYSTEM PAGINACJI (STRONICOWANIA) SEZONÓW ===== */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 10px;
            gap: 15px;
        }
        
        .page-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-indicator {
            background: #333;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            min-width: 100px;
            text-align: center;
        }
        
        .page-indicator:hover {
            background: #3a3a3a;
            border-color: #4CAF50;
        }
        
        .pagination-btn {
            background: #333;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .pagination-btn:hover {
            background: #4CAF50;
        }
        
        .pagination-btn:disabled {
            background: #444;
            color: #666;
            cursor: not-allowed;
        }
        
        .pagination-btn:disabled:hover {
            background: #444;
        }
        
        /* MODAL DO WYBORU STRONY - POPRAWIONY DLA PRZEWIJANIA */
        .page-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
        }
        
        .page-selector-modal.active {
            display: flex;
        }
        
        .page-selector-content {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            border: 2px solid #2196F3;
            text-align: center;
        }
        
        .page-selector-title {
            font-size: 20px;
            color: #2196F3;
            margin-bottom: 20px;
        }
        
        /* NOWE STYLE DLA PRZEWIJANEJ LISTY STRON */
        .page-list-container {
            height: 250px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
            border-radius: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
        }
        
        .page-list-scroll {
            height: 100%;
            overflow-y: auto;
            padding: 10px;
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 #333;
        }
        
        /* Stylizacja scrollbara dla przeglądarek WebKit */
        .page-list-scroll::-webkit-scrollbar {
            width: 8px;
        }
        
        .page-list-scroll::-webkit-scrollbar-track {
            background: #333;
            border-radius: 4px;
        }
        
        .page-list-scroll::-webkit-scrollbar-thumb {
            background: #4CAF50;
            border-radius: 4px;
        }
        
        .page-list-scroll::-webkit-scrollbar-thumb:hover {
            background: #3d8b40;
        }
        
        .page-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .page-number-btn {
            background: #333;
            border: 2px solid #444;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            text-align: center;
            width: 100%;
        }
        
        .page-number-btn:hover {
            background: #3a3a3a;
            border-color: #4CAF50;
        }
        
        .page-number-btn.active {
            background: #2196F3;
            border-color: #2196F3;
            font-weight: bold;
        }
        
        .page-selector-close {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .page-selector-close:hover {
            background: #d32f2f;
        }
        
        @media (max-width: 480px) {
            .pagination-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .page-info {
                order: 2;
            }
            
            .pagination-buttons {
                order: 1;
                display: flex;
                gap: 10px;
            }
            
            .page-list-container {
                height: 200px;
            }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- MENU NAWIGACYJNE -->
    <div class="nav-menu">
        <button class="nav-btn active" onclick="showPage('elo')">
            <span class="nav-icon">🎯</span>
            <span>Kalkulator Elo</span>
        </button>
        <button class="nav-btn" id="gamesBtn" onclick="showPage('games')">
            <span class="nav-icon">🎮</span>
            <span>Gry</span>
        </button>
        <button class="nav-btn" onclick="showPage('ranks')">
            <span class="nav-icon">⭐</span>
            <span>Rangi</span>
        </button>
        <button class="nav-btn" onclick="showPage('info')">
            <span class="nav-icon">ℹ️</span>
            <span>Info</span>
        </button>
    </div>

    <!-- MODAL DO WERYFIKACJI KODU - POPRAWIONY -->
    <div id="codeModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0; color: #4CAF50;">🔒 WERYFIKACJI KODU</h3>
            </div>
            
            <div id="modalMessage" style="text-align: center; margin-bottom: 15px;">
                <p>Wprowadź 5-cyfrowy kod weryfikacyjny dla wybranego gracza</p>
            </div>
            
            <div class="player-name-highlight" id="modalPlayerName">
                <!-- Tu pojawi się nazwa graczy -->
            </div>
            
            <div class="input-group">
                <label style="text-align: center;">5-cyfrowy kod:</label>
                <input type="text" 
                       id="codeInput" 
                       class="code-input" 
                       maxlength="5" 
                       placeholder="00000"
                       oninput="handleCodeInput(this)">
                <div id="codeError" style="color: #f44336; text-align: center; margin-top: 5px; font-size: 12px; min-height: 18px;"></div>
            </div>
            
            <div class="cancel-btn-container">
                <button class="btn-cancel-modal" onclick="closeCodeModal()">ANULUJ</button>
            </div>
            
            <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #aaa;">
                Naciśnij ESC lub kliknij poza modal aby zamknąć
            </div>
        </div>
    </div>

    <!-- MODAL DO WYBORU STRONY SEZONÓW - ZAKTUALIZOWANY -->
    <div id="pageSelectorModal" class="page-selector-modal">
        <div class="page-selector-content">
            <div class="page-selector-title">📄 Wybierz stronę sezonów</div>
            
            <div class="page-list-container">
                <div id="pageSelectorList" class="page-list-scroll">
                    <!-- Lista przycisków stron pojawi się tutaj -->
                </div>
            </div>
            
            <div id="pageSelectorInfo" style="margin-bottom: 15px; color: #aaa; font-size: 13px;">
                <!-- Informacja o ilości stron -->
            </div>
            
            <button class="page-selector-close" onclick="closePageSelectorModal()">Zamknij</button>
        </div>
    </div>

    <!-- STRONA KALKULATORA ELO -->
    <div class="container page active" id="eloPage">
        <!-- LOGO STRONY - USUNIĘTE ZGODNIE Z ŻYCZENIEM -->
        <h1 style="margin-top: 10px;">🎯 KALKULATOR ELO DART</h1>
        
        <!-- Panel logowania -->
        <div class="login-box" id="loginBox">
            <h3>ZALOGUJ SIĘ</h3>
            <p style="font-size: 14px; color: #aaa;">Dane synchronizowane w chmurze Firebase</p>
            <div class="input-group">
                <input type="password" id="adminPassword" placeholder="Wprowadź hasło...">
            </div>
            <button class="btn-login" onclick="login()">ZALOGUJ</button>
            <div style="margin-top: 10px; font-size: 12px; color: #aaa;">
                <span class="desktop-only">Bez logowania: tylko przeglądanie<br>
                Z logowaniem: dostęp do pełnych funkcji</span>
                <span class="mobile-only">Gość: przeglądanie<br>
                Zalogowany: pełny dostęp</span>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div class="admin-panel hidden" id="adminPanel">
            <h3 style="margin-top: 0;">👑 KONTO PREMIUM <span class="role-badge admin-badge">PREMIUM</span></h3>
            
            <div class="input-group">
                <label>Imię nowego gracza:</label>
                <input type="text" id="newPlayerName" placeholder="np. Jan Kowalski">
            </div>
            
            <div class="input-group">
                <label>Początkowe ELO:</label>
                <input type="number" id="newPlayerElo" value="1500" placeholder="1500">
            </div>
            
            <div class="admin-input-row">
                <div class="admin-input-group">
                    <label>5-cyfrowy kod weryfikacyjny:</label>
                    <input type="text" 
                           id="newPlayerCode" 
                           maxlength="5" 
                           placeholder="12345"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5)">
                </div>
                <button onclick="generateRandomCode()" class="generate-code-btn">
                    Losuj
                </button>
            </div>
            
            <small style="color: #aaa; font-size: 12px; display: block; margin-top: 5px;">
                Możesz wpisać własny kod lub użyć przycisku "Losuj". Kody mogą się powtarzać.
            </small>
            
            <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button class="btn-add" onclick="addNewPlayer()" style="flex: 2;">➕ DODAJ GRACZA</button>
                <button class="btn-logout" onclick="logout()" style="flex: 1;">WYLOGUJ</button>
            </div>
        </div>
        
        <!-- User Panel -->
        <div class="user-panel hidden" id="userPanel">
            <h3 style="margin-top: 0;">👤 KONTO UŻYTKOWNIKA <span class="role-badge user-badge">USER</span></h3>
            <button class="btn-logout" onclick="logout()" style="width: 100%;">WYLOGUJ</button>
        </div>
        
        <!-- Dev Panel -->
        <div class="dev-panel hidden" id="devPanel">
            <h3 style="margin-top: 0;">⚙️ PANEL SYSTEMOWY <span class="role-badge dev-badge">SYSTEM</span></h3>
            
            <!-- Status rang -->
            <div class="role-toggle-section">
                <h4 style="margin-top: 0; color: #FFFFFF;">🎮 ZARZĄDZANIE DOSTĘPAMI</h4>
                
                <div style="margin-bottom: 15px;">
                    <strong>Dostęp Premium:</strong> 
                    <span id="adminStatus" class="role-status status-disabled">WYŁĄCZONY</span>
                    <div class="dev-controls">
                        <input type="password" 
                               id="adminPasswordInput" 
                               class="password-input" 
                               placeholder="Ustaw hasło dla dostępu Premium...">
                        <button class="btn-toggle toggle-btn" onclick="toggleAdminRole()">
                            WŁĄCZ
                        </button>
                    </div>
                    <small style="color: #aaa; display: block; margin-top: 5px;">
                        Aktualne hasło: <span id="currentAdminPassword">brak</span>
                    </small>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Dostęp Użytkownika:</strong> 
                    <span id="userStatus" class="role-status status-disabled">WYŁĄCZONY</span>
                    <div class="dev-controls">
                        <input type="password" 
                               id="userPasswordInput" 
                               class="password-input" 
                               placeholder="Ustaw hasło dla dostępu Użytkownika...">
                        <button class="btn-toggle toggle-btn" onclick="toggleUserRole()">
                            WŁĄCZ
                        </button>
                    </div>
                    <small style="color: #aaa; display: block; margin-top: 5px;">
                        Aktualne hasło: <span id="currentUserPassword">brak</span>
                    </small>
                </div>
                
                <div style="font-size: 12px; color: #aaa; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                    <strong>⚠️ Uwaga:</strong> Gdy dostęp jest wyłączony, nikt nie może się na niego zalogować.<br>
                    Przeglądanie bez logowania jest zawsze dostępne.
                </div>
            </div>
            
            <!-- Dodawanie graczy -->
            <div style="margin-top: 20px;">
                <h4 style="margin-top: 0; color: #FFFFFF;">➕ DODAWANIE GRACZY</h4>
                
                <div class="input-group">
                    <label>Imię nowego gracza:</label>
                    <input type="text" id="devNewPlayerName" placeholder="np. Jan Kowalski">
                </div>
                
                <div class="input-group">
                    <label>Początkowe ELO:</label>
                    <input type="number" id="devNewPlayerElo" value="1500" placeholder="1500">
                </div>
                
                <div class="admin-input-row">
                    <div class="admin-input-group">
                        <label>5-cyfrowy kod weryfikacyjny:</label>
                        <input type="text" 
                               id="devNewPlayerCode" 
                               maxlength="5" 
                               placeholder="12345"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5)">
                    </div>
                    <button onclick="generateRandomCodeDev()" class="generate-code-btn">
                        Losuj
                    </button>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 15px;">
                    <button class="btn-add" onclick="addNewPlayerDev()" style="flex: 2;">➕ DODAJ GRACZA</button>
                    <button class="btn-logout" onclick="logout()" style="flex: 1;">WYLOGUJ</button>
                </div>
            </div>
        </div>
        
        <!-- Wybór graczy do meczu -->
        <div class="player-box">
            <h3 style="margin-top: 0;">WYBIERZ GRACZY DO MECZU</h3>
            
            <div class="player-select-row">
                <div style="flex: 1;">
                    <label>Gracz A:</label>
                    <select id="selectPlayerA">
                        <option value="">Wybierz gracza</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: center; min-height: 60px;">
                    <button class="swap-btn" onclick="swapPlayers()" id="swapBtn" title="Zamień graczy miejscami">
                        🔄
                    </button>
                </div>
                
                <div style="flex: 1;">
                    <label>Gracz B:</label>
                    <select id="selectPlayerB">
                        <option value="">Wybierz gracza</option>
                    </select>
                </div>
            </div>
            
            <div class="chance" id="chance">Wybierz graczy aby zobaczyć szanse</div>
            
            <div class="buttons">
                <button class="btn-win1" onclick="playerAWins()" id="btnA">GRACZ A wygrywa</button>
                <button class="btn-draw" onclick="draw()" id="btnDraw">REMIS</button>
                <button class="btn-win2" onclick="playerBWins()" id="btnB">GRACz B wygrywa</button>
            </div>
            
            <div style="text-align: center; margin-top: 10px; color: #aaa; font-size: 12px;">
                ⚠️ Po kliknięciu przycisku będzie wymagane podanie kodu weryfikacyjnego dla obu graczy
            </div>
        </div>
        
        <!-- Lista wszystkich graczy -->
        <div class="players-list">
            <h3 style="margin-top: 0;" id="rankingTitle">🏆 SEZONOWY RANKING GRACZY</h3>
            <div id="allPlayersList">Ładowanie z chmury...</div>
        </div>
        
        <!-- Historia zmian -->
        <div class="history">
            <h3 style="margin-top: 0;" id="historyTitle">📜 OSTATNIE MECZE W SEZONIE</h3>
            <div id="historyList">-</div>
        </div>
        
        <!-- Info o synchronizacji -->
        <div style="text-align: center; margin-top: 20px; color: #777; font-size: 11px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
            <span class="desktop-only">
                🔄 Synchronizacja z Firebase | 💾 Auto-zapis | 👥 Wielu użytkowników | ☁️ Chmura
            </span>
            <span class="mobile-only">
                🔄 Synchronizacja | 💾 Auto-zapis | ☁️ Chmura
            </span>
        </div>
    </div>

    <!-- STRONA GŁÓWNA GIER -->
    <div class="container page" id="gamesPage">
        <div class="games-page">
            <h1 style="margin-top: 10px;">🎮 GRY I TURNIEJE</h1>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <p style="color: #aaa; font-size: 16px;">Wybierz tryb gry</p>
            </div>
            
            <div class="game-modes">
                <div class="game-mode-card" onclick="selectGameMode('501')">
                    <div class="game-mode-icon">🎯</div>
                    <div class="game-mode-title">501 to 0</div>
                    <div class="game-mode-description">
                        Klasyczny darter. Rozpocznij z 501 punktami i zredukuj do zera.
                        Wygrywa ten, kto pierwszy wyrzuci dokładnie 0.
                    </div>
                </div>
                
                <div class="game-mode-card" onclick="showComingSoon()">
                    <div class="game-mode-icon">⚔️</div>
                    <div class="game-mode-title">Cricket</div>
                    <div class="game-mode-description">
                        (Wkrótce) Popularna gra w kryketa darta. Zamknij wszystkie numery 15-20 i bullseye.
                    </div>
                </div>
                
                <div class="game-mode-card" onclick="showComingSoon()">
                    <div class="game-mode-icon">🏆</div>
                    <div class="game-mode-title">Around the Clock</div>
                    <div class="game-mode-description">
                        (Wkrótce) Rzuć w każdy sektor od 1 do 20. Wygrywa ten, kto pierwszy ukończy rundę.
                    </div>
                </div>
                
                <div class="game-mode-card" onclick="showComingSoon()">
                    <div class="game-mode-icon">🎲</div>
                    <div class="game-mode-title">Random Practice</div>
                    <div class="game-mode-title">(Wkrótce)</div>
                    <div class="game-mode-description">
                        Losowe wyzwania do treningu. Doskonal swoje umiejętności.
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="back-to-ranks-btn" onclick="showPage('elo')">
                    ← Powrót do Kalkulatora
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA WYBORU GRACZY DO GRY -->
    <div class="container page" id="gameSetupPage">
        <div class="game-setup-page">
            <h1>🎯 501 TO 0 - WYBÓR GRACZY</h1>
            
            <div class="start-game-info">
                <h3>Wybierz dwóch graczy do rozgrywki</h3>
                <p style="color: #aaa; font-size: 14px;">Gra polega na redukcji punktów z 501 do 0. Wygrywa gracz, który pierwszy osiągnie dokładnie 0 punktów.</p>
            </div>
            
            <div class="player-box">
                <h3 style="margin-top: 0;">WYBIERZ GRACZY DO ROZGRYWKI</h3>
                
                <div class="player-select-row">
                    <div style="flex: 1;">
                        <label>Gracz 1 (Będzie zaczynał):</label>
                        <select id="gameSelectPlayer1">
                            <option value="">Wybierz gracza</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 60px;">
                        <button class="swap-btn" onclick="swapGamePlayers()" id="gameSwapBtn" title="Zamień graczy miejscami">
                            🔄
                        </button>
                    </div>
                    
                    <div style="flex: 1;">
                        <label>Gracz 2:</label>
                        <select id="gameSelectPlayer2">
                            <option value="">Wybierz gracza</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn-win1" onclick="start501Game()" id="startGameBtn" style="padding: 15px 30px; font-size: 16px;">
                        ROZPOCZNIJ GRĘ
                    </button>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-to-ranks-btn" onclick="showPage('games')">
                    ← Wróć do wyboru gry
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA GRY 501 -->
    <div class="container page" id="game501Page">
        <div class="game-501-page">
            <div class="game-header">
                <h1>🎯 501 TO 0</h1>
                <div id="gameInfo">Rozgrywka: Gracz 1 vs Gracz 2</div>
                <div id="currentTurnInfo" class="current-turn-info">
                    Kolejka: <span id="currentPlayerName">Gracz 1</span> | Rzuty: <span id="dartsThrown">0/3</span>
                </div>
            </div>
            
            <div class="players-scoreboard">
                <div class="player-score" id="player1Score">
                    <div class="player-name-large" id="player1Name">Gracz 1</div>
                    <div class="current-score" id="player1Points">501</div>
                    <div class="legs-info">
                        Legi: <span id="player1Legs">0</span> |
                        Średnia: <span id="player1Average">0.0</span>
                    </div>
                    <div id="player1Checkout" style="margin-top: 10px; color: #FF9800; font-size: 14px;"></div>
                </div>
                
                <div class="player-score" id="player2Score">
                    <div class="player-name-large" id="player2Name">Gracz 2</div>
                    <div class="current-score" id="player2Points">501</div>
                    <div class="legs-info">
                        Legi: <span id="player2Legs">0</span> |
                        Średnia: <span id="player2Average">0.0</span>
                    </div>
                    <div id="player2Checkout" style="margin-top: 10px; color: #FF9800; font-size: 14px;"></div>
                </div>
            </div>
            
            <div class="dart-input-section">
                <h3>Wprowadź punkty z kolejki (3 rzuty)</h3>
                
                <div class="dart-input-row">
                    <div class="dart-input-group">
                        <label class="dart-input-label">Rzut 1:</label>
                        <input type="number" id="dart1" class="dart-points-input" min="0" max="60" value="" placeholder="0-60">
                    </div>
                    
                    <div class="dart-input-group">
                        <label class="dart-input-label">Rzut 2:</label>
                        <input type="number" id="dart2" class="dart-points-input" min="0" max="60" value="" placeholder="0-60">
                    </div>
                    
                    <div class="dart-input-group">
                        <label class="dart-input-label">Rzut 3:</label>
                        <input type="number" id="dart3" class="dart-points-input" min="0" max="60" value="" placeholder="0-60">
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; color: #aaa;">Mnożnik (podwójny/potrójny):</label>
                    <div class="dart-multiplier">
                        <button class="multiplier-btn" onclick="setMultiplier(1)">Pojedynczy (1x)</button>
                        <button class="multiplier-btn" onclick="setMultiplier(2)">Podwójny (2x)</button>
                        <button class="multiplier-btn" onclick="setMultiplier(3)">Potrójny (3x)</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                    <div>Suma kolejki: <span id="turnTotal" style="font-weight: bold; font-size: 18px;">0</span> punktów</div>
                    <div>Nowy wynik: <span id="newScore" style="font-weight: bold; font-size: 18px; color: #4CAF50;">501</span></div>
                    <div id="checkoutHint" style="margin-top: 10px; font-size: 14px; color: #FF9800;"></div>
                </div>
                
                <div class="game-action-buttons">
                    <button class="btn-undo" onclick="undoLastTurn()" id="undoBtn" disabled>Cofnij kolejkę</button>
                    <button class="btn-submit-darts" onclick="submitDarts()" id="submitDartsBtn">Zatwierdź rzuty</button>
                </div>
            </div>
            
            <div class="turn-history">
                <h3>Historia kolejek</h3>
                <div id="turnsHistory">
                    <!-- Historia kolejek będzie dodawana dynamicznie -->
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-to-ranks-btn" onclick="showPage('games')">
                    ← Zakończ grę i wróć
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA WYNIKÓW GRY -->
    <div class="container page" id="gameResultsPage">
        <div class="game-results-page">
            <h1>🏆 WYNIK ROZGRYWKI</h1>
            
            <div class="results-container">
                <div class="winner-celebration" id="winnerCelebration">
                    🎉 ZWYCIĘZCA: <span id="winnerName">Gracz 1</span> 🎉
                </div>
                
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Statystyka</th>
                            <th id="resultsPlayer1Name">Gracz 1</th>
                            <th id="resultsPlayer2Name">Gracz 2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Wynik końcowy</td>
                            <td id="resultsPlayer1Score">501</td>
                            <td id="resultsPlayer2Score">501</td>
                        </tr>
                        <tr>
                            <td>Wygrane legi</td>
                            <td id="resultsPlayer1Legs">1</td>
                            <td id="resultsPlayer2Legs">0</td>
                        </tr>
                        <tr>
                            <td>Średnia punktów/rzut</td>
                            <td id="resultsPlayer1Average">0.0</td>
                            <td id="resultsPlayer2Average">0.0</td>
                        </tr>
                        <tr>
                            <td>Liczba kolejek</td>
                            <td id="resultsPlayer1Turns">0</td>
                            <td id="resultsPlayer2Turns">0</td>
                        </tr>
                        <tr>
                            <td>Najwyższy checkout</td>
                            <td id="resultsPlayer1Checkout">0</td>
                            <td id="resultsPlayer2Checkout">0</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="elo-options">
                    <h3>🎯 Aktualizacja rankingu ELO</h3>
                    <p>Jak chcesz zaktualizować ranking ELO po tej rozgrywce?</p>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn-win1" onclick="updateEloAuto()" style="width: 100%; margin-bottom: 10px; padding: 15px;">
                            🔄 Automatycznie przez kalkulator ELO
                        </button>
                        <p style="font-size: 13px; color: #aaa; margin-bottom: 20px;">
                            System automatycznie obliczy zmianę ELO na podstawie wyniku meczu.
                            Wymagane będą kody weryfikacyjne obu graczy.
                        </p>
                        
                        <button class="btn-draw" onclick="updateEloManual()" style="width: 100%; padding: 15px;">
                            ✏️ Ręcznie (wybierz wynik samodzielnie)
                        </button>
                        <p style="font-size: 13px; color: #aaa;">
                            Sam wybierzesz kto wygrał lub czy był remis w kalkulatora ELO.
                        </p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="back-to-ranks-btn" onclick="showPage('games')">
                    ← Wróć do gier
                </button>
                <button class="back-to-ranks-btn" onclick="playAgain()" style="margin-top: 10px; background: #2196F3; border-color: #2196F3;">
                    🔄 Zagraj jeszcze raz
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA RANG -->
    <div class="container page" id="ranksPage">
        <div class="ranks-page">
            <h1 style="margin-top: 10px;">⭐ SYSTEM RANG</h1>
            
            <!-- Status sezonu -->
            <div id="seasonStatus" class="season-status off-season">
                <!-- Dynamicznie ładowane -->
            </div>
            
            <div id="ranksList">
                <!-- Tutaj zostaną wygenerowane rangi dynamicznie -->
                Ładowanie rang...
            </div>
            
            <div class="ranks-footer">
                <div class="ranks-footer-buttons">
                    <button class="ranks-footer-btn" onclick="showAchievements()">
                        🏆 Osiągnięcia
                    </button>
                    <button class="ranks-footer-btn" onclick="showPreviousSeasons()">
                        📜 Wcześniejsze sezony
                    </button>
                </div>
                
                <!-- Przycisk tylko dla admina -->
                <button id="newSeasonBtn" class="ranks-footer-btn admin-season-btn hidden" onclick="showNewSeasonForm()">
                    🚀 Zacznij nowy sezon
                </button>
                
                <!-- Przycisk tylko dla deva do zakończenia sezonu -->
                <button id="endSeasonBtn" class="ranks-footer-btn dev-end-season-btn hidden" onclick="endSeasonDev()">
                    ⏹️ Zakończ sezon (SYSTEM)
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA OSIĄGNIĘĆ -->
    <div class="container page" id="achievementsPage">
        <div class="achievements-page">
            <h1>🏆 OSIĄGNIĘCIA</h1>
            
            <div id="achievementsList">
                <!-- Tutaj zostaną wygenerowane osiągnięcia dynamicznie -->
                Ładowanie osiągnięć...
            </div>
            
            <button class="back-to-ranks-btn" onclick="showPage('ranks')">
                ← Powrót do Rang
            </button>
        </div>
    </div>

    <!-- STRONA NOWEGO SEZONU (Tylko dla admina/dev) -->
    <div class="container page" id="newSeasonPage">
        <div class="new-season-page">
            <h1>🚀 ROZPOCZNIJ NOWY SEZON</h1>
            
            <div class="new-season-form">
                <h3>Ustaw progi ELO dla rang:</h3>
                
                <div class="elo-thresholds" id="eloThresholds">
                    <!-- Dynamicznie generowane pola dla rang -->
                </div>
                
                <div class="date-inputs">
                    <div style="flex: 1;">
                        <label>Początek sezonu:</label>
                        <input type="date" id="seasonStartDate" min="" onchange="validateSeasonDates()">
                    </div>
                    
                    <div style="flex: 1;">
                        <label>Koniec sezonu:</label>
                        <input type="date" id="seasonEndDate" min="" onchange="validateSeasonDates()">
                    </div>
                </div>
                
                <div style="margin: 15px 0;">
                    <label>Nazwa sezonu (opcjonalnie):</label>
                    <input type="text" id="seasonName" placeholder="np. Sezon 1 2025/2026">
                </div>
                
                <div class="season-action-buttons">
                    <button class="btn-cancel" onclick="showPage('ranks')">
                        Anuluj
                    </button>
                    <button class="btn-submit" id="createSeasonBtn" onclick="createNewSeason()" disabled>
                        🚀 Rozpocznij sezon
                    </button>
                </div>
                
                <div style="font-size: 12px; color: #aaa; margin-top: 20px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                    <strong>⚠️ Uwaga:</strong> Po rozpoczęciu sezonu nie można go wcześniej zakończyć (oprócz panelu systemowego).<br>
                    Po zakończeniu sezonu ELO wszystkich graczy zostanie zresetowane do 1500.
                </div>
            </div>
            
            <button class="back-to-ranks-btn" onclick="showPage('ranks')" style="margin-top: 20px;">
                ← Powrót do Rang
            </button>
        </div>
    </div>

    <!-- STRONA WCZEŚNIEJSZYCH SEZONÓW -->
    <div class="container page" id="seasonsPage">
        <div class="seasons-page">
            <h1>📜 WCZEŚNIEJSZE SEZONY</h1>
            
            <div id="seasonsList">
                <!-- Tutaj zostaną wygenerowane sezony dynamicznie -->
                Ładowanie sezonów...
            </div>
            
            <!-- NOWY SYSTEM PAGINACJI (STRONICOWANIA) -->
            <div id="seasonsPagination" class="pagination-container hidden">
                <div class="pagination-buttons">
                    <button class="pagination-btn" onclick="changeSeasonsPage(-1)" id="prevPageBtn" disabled>
                        ←
                    </button>
                </div>
                
                <div class="page-info">
                    <div class="page-indicator" onclick="openPageSelectorModal()" id="pageIndicator">
                        1 z 1
                    </div>
                </div>
                
                <div class="pagination-buttons">
                    <button class="pagination-btn" onclick="changeSeasonsPage(1)" id="nextPageBtn" disabled>
                        →
                    </button>
                </div>
            </div>
            
            <button class="back-to-ranks-btn" onclick="showPage('ranks')">
                ← Powrót do Rang
            </button>
        </div>
    </div>

    <!-- STRONA INFO -->
    <div class="container page" id="infoPage">
        <div class="info-page">
            <h1 style="margin-top: 10px;">ℹ️ INFORMACJE</h1>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #4CAF50;">🔐 SYSTEM WERYFIKACJI KODÓW</h4>
                <p>Każdy gracz ma 5-cyfrowy kod weryfikacyjny. Podczas meczu wymagane jest podanie kodu gracza, aby:</p>
                <ul style="padding-left: 20px;">
                    <li>Zapobiec kradzieży ELO przez innych graczy</li>
                    <li>Potwierdzić tożsamość zawodnika</li>
                    <li>Zapewnić uczciwość rozgrywek</li>
                    <li>Kody mogą się powtarzać</li>
                </ul>
                <p><strong>Proces weryfikacji:</strong></p>
                <ol style="padding-left: 20px;">
                    <li>Wybierz graczy do meczu</li>
                    <li>Kliknij przycisk z wynikiem</li>
                    <li>Wprowadź kod dla Gracza A</li>
                    <li>Wprowadź kod dla Gracza B</li>
                    <li>Mecz zostanie zapisany po poprawnej weryfikacji obu kodów</li>
                </ol>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #4CAF50;">📊 O SYSTEMIE ELO</h4>
                <p>System Elo służy do obliczania względnej siły graczy na podstawie wyników meczów.</p>
                <ul style="padding-left: 20px;">
                    <li><strong>K = 32</strong> - współczynnik zmiany dla darta</li>
                    <li><strong>ELO początkowe:</strong> 1500 punktów</li>
                    <li><strong>Wzór:</strong> 1 / (1 + 10^((R_B - R_A)/400))</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #2196F3;">🔐 POZIOMY DOSTĘPU</h4>
                <ul style="padding-left: 20px;">
                    <li><strong>Przeglądanie:</strong> Przeglądanie rankingu, ukryte nazwiska (zawsze dostępne)</li>
                    <li><strong>Użytkownik:</strong> Rozgrywanie meczów, pełne nazwiska (do włączenia)</li>
                    <li><strong>Premium:</strong> Dodawanie/Usuwanie graczy (do włączenia)</li>
                </ul>
                <p style="margin-top: 10px; font-size: 13px; color: #aaa;">
                    Dostępy Użytkownika i Premium mogą być włączane/wyłączane przez administratora systemu.
                </p>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #9C27B0;">🏆 SYSTEM SEZONÓW</h4>
                <p>System sezonów pozwala na rozgrywanie okresowych rozgrywek z resetem rankingów.</p>
                <ul style="padding-left: 20px;">
                    <li><strong>Sezony:</strong> Okresowe rozgrywki z własnymi progami ELO</li>
                    <li><strong>Reset ELO:</strong> Po sezonie wszyscy graczy wracają do 1500 ELO</li>
                    <li><strong>Osiągnięcia:</strong> Specjalne nagrody za wyniki w sezonie</li>
                    <li><strong>Archiwum:</strong> Historia wszystkich sezonów</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #BB86FC;">🎮 GRY 501 TO 0</h4>
                <p>Klasyczna gra w darta. Każdy gracz zaczyna z 501 punktami i próbuje zredukować swój wynik do zera.</p>
                <ul style="padding-left: 20px;">
                    <li><strong>Zasady:</strong> Wygrywa gracz, który pierwszy osiągnie dokładnie 0 punktów</li>
                    <li><strong>Checkout:</strong> Ostatni rzut musi być podwójnym lub bulleye</li>
                    <li><strong>Bust:</strong> Jeśli rzut przekroczy aktualny wynik, kolejka jest nieważna</li>
                    <li><strong>Kolejki:</strong> Gracze wykonują na zmianę po 3 rzuty</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // KONFIGURACJA FIREBASE
        // ============================================
        
         const firebaseConfig = {
            apiKey: "AIzaSyAiRim-yx73MLHlUvOKsoBav57TXaEzN24",
            authDomain: "dartteaplikacjaszypra.firebaseapp.com",
            projectId: "dartteaplikacjaszypra",
            storageBucket: "dartteaplikacjaszypra.firebasestorage.app",
            messagingSenderId: "461617366334",
            appId: "1:461617366334:web:4b26e73d9db79e9665586f"
        };

        // ============================================
        // INICJALIZACJA APLIKACJI
        // ============================================
        
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                return {
                    app: firebase.app(),
                    db: firebase.firestore(),
                    auth: firebase.auth()
                };
            } catch (error) {
                console.error("Błąd inicjalizacji Firebase:", error);
                return null;
            }
        }
        
        // ============================================
        // GŁÓWNY KOD APLIKACJI - KOMPLETNY
        // ============================================
        
        // Zmienne globalne
        let db = null;
        let auth = null;
        let players = [];
        let history = [];
        let offSeasonHistory = [];
        let currentUserRole = 'guest';
        let unsubscribePlayers = null;
        let unsubscribeHistory = null;
        let unsubscribeOffSeasonHistory = null;
        let unsubscribeSettings = null;
        let currentPage = 'elo';
        
        // Ustawienia systemu
        let systemSettings = {
            adminEnabled: false,
            userEnabled: false,
            adminPassword: '',
            userPassword: ''
        };
        
        // Zmienne do weryfikacji kodu
        let pendingMatch = null;
        let verificationState = {
            currentPlayer: null,
            playerName: '',
            playerCode: '',
            verifiedPlayerA: false,
            verifiedPlayerB: false
        };
        
        // Zmienne z drugiego kodu (sezony)
        let currentSeason = null;
        let previousSeasons = [];
        let expandedSeasonId = null;
        
        // NOWE ZMIENNE DO PAGINACJI SEZONÓW
        let seasonsPagination = {
            currentPage: 1,
            totalPages: 1,
            itemsPerPage: 10,
            allSeasons: [],  // Wszystkie zakończone sezony
            // ZMIANA: Nowy system przechowywania sezonów - ostatnia strona pełna, pierwsza częściowo
            seasonsPerPageReversed: true // Flaga dla odwróconej paginacji
        };
        
        // Zmienne do gry 501
        let currentGame = {
            mode: '501',
            player1: null,
            player2: null,
            startingPlayer: 1,
            currentPlayer: 1,
            scores: {
                player1: 501,
                player2: 501
            },
            legs: {
                player1: 0,
                player2: 0
            },
            turns: [],
            dartsThrown: 0,
            gameOver: false,
            winner: null,
            gameId: null,
            stats: {
                player1: {
                    totalPoints: 0,
                    dartsThrown: 0,
                    average: 0,
                    highestCheckout: 0,
                    turns: 0
                },
                player2: {
                    totalPoints: 0,
                    dartsThrown: 0,
                    average: 0,
                    highestCheckout: 0,
                    turns: 0
                }
            }
        };
        
        let currentMultiplier = 1;
        let gameHistory = [];
        
        // ============================================
        // NOWY SYSTEM WERYFIKACJI KODÓW
        // ============================================
        
        function handleCodeInput(inputElement) {
            const codeError = document.getElementById('codeError');
            if (codeError) codeError.textContent = '';
            
            inputElement.value = inputElement.value.replace(/[^0-9]/g, '').slice(0, 5);
            
            if (inputElement.value.length === 5) {
                verifyCode(inputElement.value);
            }
        }
        
        function verifyCode(enteredCode) {
            if (!pendingMatch || !verificationState.currentPlayer) {
                closeCodeModal();
                return;
            }
            
            let playerToVerify = null;
            let isCorrect = false;
            
            if (verificationState.currentPlayer === 'A') {
                playerToVerify = pendingMatch.playerA;
                isCorrect = (enteredCode === playerToVerify.code);
            } else {
                playerToVerify = pendingMatch.playerB;
                isCorrect = (enteredCode === playerToVerify.code);
            }
            
            if (!isCorrect) {
                const codeError = document.getElementById('codeError');
                if (codeError) {
                    codeError.textContent = '❌ Nieprawidłowy kod!';
                    codeError.style.color = '#f44336';
                }
                
                const codeInput = document.getElementById('codeInput');
                if (codeInput) {
                    codeInput.classList.add('error');
                    codeInput.classList.remove('success');
                    
                    setTimeout(() => {
                        codeInput.classList.remove('error');
                        codeInput.value = '';
                        codeInput.focus();
                    }, 500);
                }
                return;
            }
            
            if (verificationState.currentPlayer === 'A') {
                verificationState.verifiedPlayerA = true;
                console.log('✅ Kod gracza A poprawny');
            } else {
                verificationState.verifiedPlayerB = true;
                console.log('✅ Kod gracza B poprawny');
            }
            
            const codeError = document.getElementById('codeError');
            if (codeError) codeError.textContent = '';
            
            const codeInput = document.getElementById('codeInput');
            if (codeInput) {
                codeInput.classList.remove('error');
                codeInput.classList.add('success');
            }
            
            if (verificationState.verifiedPlayerA && verificationState.verifiedPlayerB) {
                console.log('✅ Oba kody poprawne, obliczam ELO...');
                
                setTimeout(() => {
                    closeCodeModal();
                    
                    setTimeout(() => {
                        calculateMatchFinal(pendingMatch.scoreA, pendingMatch.playerA, pendingMatch.playerB);
                    }, 300);
                }, 800);
            } else {
                setTimeout(() => {
                    proceedToNextVerification();
                }, 500);
            }
        }
        
        function proceedToNextVerification() {
            const codeInput = document.getElementById('codeInput');
            if (codeInput) {
                codeInput.value = '';
                codeInput.classList.remove('error', 'success');
                codeInput.focus();
            }
            
            const codeError = document.getElementById('codeError');
            if (codeError) codeError.textContent = '';
            
            if (!verificationState.verifiedPlayerA) {
                verificationState.currentPlayer = 'A';
                verificationState.playerName = pendingMatch.playerA.name;
                updateCodeModal();
            } else if (!verificationState.verifiedPlayerB) {
                verificationState.currentPlayer = 'B';
                verificationState.playerName = pendingMatch.playerB.name;
                updateCodeModal();
            }
        }
        
        function updateCodeModal() {
            const modalPlayerName = document.getElementById('modalPlayerName');
            const modalMessage = document.getElementById('modalMessage');
            
            if (!modalPlayerName || !modalMessage) return;
            
            if (verificationState.currentPlayer === 'A') {
                modalPlayerName.innerHTML = `<strong>${verificationState.playerName}</strong>`;
                modalMessage.innerHTML = `<p>Wprowadź kod weryfikacyjny dla <strong>Gracza A</strong>:</p>`;
            } else {
                modalPlayerName.innerHTML = `<strong>${verificationState.playerName}</strong>`;
                modalMessage.innerHTML = `<p>Wprowadź kod weryfikacyjny dla <strong>Gracza B</strong>:</p>`;
            }
            
            const modal = document.getElementById('codeModal');
            if (modal) modal.classList.add('active');
            
            setTimeout(() => {
                const codeInput = document.getElementById('codeInput');
                if (codeInput) {
                    codeInput.focus();
                    codeInput.value = '';
                    codeInput.classList.remove('error', 'success');
                }
            }, 100);
        }
        
        function showCodeModal() {
            const modal = document.getElementById('codeModal');
            if (!modal) return;
            
            verificationState = {
                currentPlayer: 'A',
                playerName: pendingMatch.playerA.name,
                playerCode: '',
                verifiedPlayerA: false,
                verifiedPlayerB: false
            };
            
            updateCodeModal();
        }
        
        function closeCodeModal() {
            const modal = document.getElementById('codeModal');
            if (modal) modal.classList.remove('active');
            
            if (!verificationState.verifiedPlayerA || !verificationState.verifiedPlayerB) {
                pendingMatch = null;
                verificationState = {
                    currentPlayer: null,
                    playerName: '',
                    playerCode: '',
                    verifiedPlayerA: false,
                    verifiedPlayerB: false
                };
            }
        }
        
        // ============================================
        // POPRAWIONE FUNKCJE DO GENEROWANIA NAZW MECZÓW
        // ============================================
        
        // ZAKTUALIZOWANA FUNKCJA: Teraz używa prawidłowego numeru meczu
        async function generateMatchId(matchData) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pl-PL').replace(/\./g, '.');
            const uniqueCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            if (currentSeason) {
                const seasonNumber = currentSeason.seasonNumber || 1;
                const seasonName = (currentSeason.name || `Sezon${seasonNumber}`).replace(/ /g, '_');
                
                // POPRAWIONE: Pobierz aktualny numer meczu w sezonie
                let matchNumber = 1;
                try {
                    // Sprawdź w systemieSettings aktualny licznik meczy dla tego sezonu
                    const seasonKey = `season${seasonNumber}_matchCounter`;
                    matchNumber = systemSettings[seasonKey] || 1;
                    
                    // Zaktualizuj licznik dla następnego meczu
                    systemSettings[seasonKey] = matchNumber + 1;
                    
                    // Zapisz zaktualizowane ustawienia
                    await updateMatchCounterInSettings(seasonKey, matchNumber + 1);
                    
                } catch (error) {
                    console.error("Błąd pobierania numeru meczu:", error);
                }
                
                return `${seasonNumber}S_${seasonName}_Game_${matchNumber}_Date_${dateStr}_${uniqueCode}`;
            } else {
                // Tryb poza sezonem
                const offSeasonMatchCount = (systemSettings.offSeasonMatchCount || 0) + 1;
                
                return `OffSeason_Game_${offSeasonMatchCount}_Date_${dateStr}_${uniqueCode}`;
            }
        }
        
        // NOWA FUNKCJA: Aktualizuj licznik meczy w ustawieniach systemu
        async function updateMatchCounterInSettings(seasonKey, newValue) {
            if (!db) return;
            
            try {
                await db.collection('system').doc('settings').update({
                    [seasonKey]: newValue,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                systemSettings[seasonKey] = newValue;
            } catch (error) {
                console.error("Błąd aktualizacji licznika meczy:", error);
            }
        }
        
        async function updateOffSeasonMatchCount() {
            if (!db) return;
            
            try {
                const currentCount = systemSettings.offSeasonMatchCount || 0;
                await db.collection('system').doc('settings').update({
                    offSeasonMatchCount: currentCount + 1,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                systemSettings.offSeasonMatchCount = currentCount + 1;
            } catch (error) {
                console.error("Błąd aktualizacji licznika meczy poza sezonem:", error);
            }
        }
        
        // ============================================
        // POPRAWIONE OBLICZANIE ELO
        // ============================================
        
        async function calculateMatchFinal(scoreA, playerA, playerB) {
            console.log('🔍 Rozpoczynam obliczanie ELO:', {
                playerA: playerA.name,
                playerB: playerB.name,
                scoreA: scoreA
            });
            
            if (!db) {
                alert('❌ Brak połączenia z bazą danych!');
                return;
            }
            
            const expectedA = 1 / (1 + Math.pow(10, (playerB.elo - playerA.elo) / 400));
            const change = Math.round(32 * (scoreA - expectedA));
            
            const newEloA = playerA.elo + change;
            const newEloB = playerB.elo - change;
            
            console.log('📊 Wyniki obliczeń:', {
                expectedA: expectedA.toFixed(3),
                change: change,
                newEloA: newEloA,
                newEloB: newEloB
            });
            
            // Generuj czytelną nazwę dokumentu Z POPRAWIONYM NUMEREM MECZU
            const matchId = await generateMatchId();
            
            const matchData = {
                playerA: playerA.name,
                playerB: playerB.name,
                playerAId: playerA.id,
                playerBId: playerB.id,
                result: scoreA === 1 ? 'A' : scoreA === 0 ? 'B' : 'D',
                change: change,
                eloABefore: playerA.elo,
                eloBBefore: playerB.elo,
                eloAAfter: newEloA,
                eloBAfter: newEloB,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                date: new Date().toLocaleString('pl-PL'),
                playedBy: currentUserRole,
                verified: true,
                seasonId: currentSeason ? currentSeason.id : null,
                seasonNumber: currentSeason ? currentSeason.seasonNumber : 0,
                readableId: matchId,
                isOffSeason: !currentSeason
            };
            
            console.log('💾 Zapisuję mecz do Firebase:', matchData);
            
            try {
                const playerARef = db.collection('players').doc(playerA.id);
                const playerBRef = db.collection('players').doc(playerB.id);
                
                const batch = db.batch();
                
                batch.update(playerARef, { 
                    elo: newEloA,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                batch.update(playerBRef, { 
                    elo: newEloB,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Jeśli jest sezon, zapisz do historii i zaktualizuj licznik meczy
                if (currentSeason) {
                    const historyRef = db.collection('history').doc(matchId);
                    batch.set(historyRef, matchData);
                    
                    // Aktualizuj licznik meczy w sezonie
                    if (currentSeason.id) {
                        const seasonRef = db.collection('seasons').doc(currentSeason.id);
                        const currentMatches = currentSeason.matchesPlayed || 0;
                        batch.update(seasonRef, {
                            matchesPlayed: currentMatches + 1
                        });
                    }
                } else {
                    // Tryb poza sezonem - zapisz do OffSeasonMatchesArchive
                    const offSeasonRef = db.collection('OffSeasonMatchesArchive').doc(matchId);
                    batch.set(offSeasonRef, matchData);
                    
                    // Zaktualizuj licznik meczy poza sezonem
                    await updateOffSeasonMatchCount();
                }
                
                await batch.commit();
                
                console.log('✅ Mecz zapisany pomyślnie! ID:', matchId);
                
                let resultText = '';
                if (scoreA === 1) {
                    resultText = `${playerA.name} wygrał z ${playerB.name}`;
                } else if (scoreA === 0) {
                    resultText = `${playerB.name} wygrał z ${playerA.name}`;
                } else {
                    resultText = `${playerA.name} zremisował z ${playerA.name}`;
                }
                
                const changeA = change > 0 ? `+${change}` : change;
                const changeB = -change > 0 ? `+${-change}` : -change;
                
                const message = `🎯 ${resultText}\n\n` +
                               `${playerA.name}: ${playerA.elo} → ${newEloA} (${changeA})\n` +
                               `${playerB.name}: ${playerB.elo} → ${newEloB} (${changeB})\n\n` +
                               `📅 ${new Date().toLocaleString('pl-PL')}\n` +
                               `✅ ELO zaktualizowane pomyślnie!\n` +
                               `📁 ID meczu: ${matchId}`;
                
                alert(message);
                
                updateLocalPlayersAfterMatch(playerA.id, newEloA, playerB.id, newEloB);
                updateAllDisplays();
                
                pendingMatch = null;
                verificationState = {
                    currentPlayer: null,
                    playerName: '',
                    playerCode: '',
                    verifiedPlayerA: false,
                    verifiedPlayerB: false
                };
                
            } catch (error) {
                console.error('❌ Błąd zapisywania meczu:', error);
                
                let errorMessage = '❌ Błąd zapisywania meczu!\n\n';
                
                if (error.code === 'permission-denied') {
                    errorMessage += 'Błąd uprawnień Firebase.\nSprawdź reguły Firestore.';
                } else if (error.code === 'not-found') {
                    errorMessage += 'Nie znaleziono graczy w bazie danych.';
                } else {
                    errorMessage += `Kod błędu: ${error.code}\n${error.message}`;
                }
                
                alert(errorMessage);
            }
        }
        
        function updateLocalPlayersAfterMatch(playerAId, newEloA, playerBId, newEloB) {
            const playerAIndex = players.findIndex(p => p.id === playerAId);
            const playerBIndex = players.findIndex(p => p.id === playerBId);
            
            if (playerAIndex !== -1) {
                players[playerAIndex].elo = newEloA;
            }
            
            if (playerBIndex !== -1) {
                players[playerBIndex].elo = newEloB;
            }
            
            players.sort((a, b) => b.elo - a.elo);
        }
        
        // ============================================
        // FUNKCJE Z PIERWSZEGO KODU (Z POPRAWKAMI)
        // ============================================
        
        function generateRandomCode() {
            const randomCode = Math.floor(10000 + Math.random() * 90000);
            const element = document.getElementById('newPlayerCode');
            if (element) {
                element.value = randomCode;
                element.focus();
            }
        }
        
        function generateRandomCodeDev() {
            const randomCode = Math.floor(10000 + Math.random() * 90000);
            const element = document.getElementById('devNewPlayerCode');
            if (element) {
                element.value = randomCode;
                element.focus();
            }
        }
        
        // Nawigacja
        function showPage(pageId) {
            if (pageId === 'games' && currentUserRole === 'guest') {
                alert('Zaloguj się aby mieć dostęp do sekcji Gry!');
                return;
            }
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const pageElement = document.getElementById(pageId + 'Page');
            if (pageElement) pageElement.classList.add('active');
            
            const btn = document.querySelector(`.nav-btn[onclick*="${pageId}"]`);
            if (btn) btn.classList.add('active');
            
            currentPage = pageId;
            
            if (pageId === 'ranks') {
                setTimeout(() => {
                    generateRanksPage();
                    generateSeasonStatus();
                }, 100);
            } else if (pageId === 'achievements') {
                setTimeout(() => {
                    generateAchievementsPage();
                }, 100);
            } else if (pageId === 'newSeason') {
                setTimeout(() => {
                    generateNewSeasonForm();
                }, 100);
            } else if (pageId === 'seasons') {
                setTimeout(() => {
                    // Resetuj paginację gdy wchodzimy na stronę sezonów
                    seasonsPagination.currentPage = 1;
                    generateSeasonsPage();
                }, 100);
            } else if (pageId === 'games') {
                updateGamePlayerSelects();
            }
        }
        
        function updateMenuForRole() {
            const gamesBtn = document.getElementById('gamesBtn');
            if (!gamesBtn) return;
            
            if (currentUserRole === 'guest') {
                gamesBtn.classList.add('disabled');
                gamesBtn.title = "Zaloguj się aby mieć dostęp";
            } else {
                gamesBtn.classList.remove('disabled');
                gamesBtn.title = "";
            }
        }
        
        // Autoryzacja
        async function login() {
            if (!db) {
                alert('Brak połączenia z bazą danych!');
                return;
            }
            
            const passwordInput = document.getElementById('adminPassword');
            if (!passwordInput) return;
            
            const password = passwordInput.value;
            
            if (password === 'Dev123SP') {
                const currentDeviceId = getDeviceId();
                console.log('Twoje Device ID:', currentDeviceId);
                
                try {
                    const devicesDoc = await db.collection('system').doc('devices').get();
                    
                    if (devicesDoc.exists) {
                        const allowedDevices = devicesDoc.data().allowedDevices || [];
                        
                        if (allowedDevices.includes(currentDeviceId)) {
                            currentUserRole = 'dev';
                            updateUIForRole();
                            updateMenuForRole();
                            updateNewSeasonButton();
                            updateEndSeasonButton();
                            alert('✅ Zalogowano do panelu systemowego!');
                            passwordInput.value = '';
                        } else {
                            alert('❌ To urządzenie nie ma dostępu systemowego!\n\nTwoje Device ID: ' + currentDeviceId);
                            passwordInput.value = '';
                        }
                    } else {
                        alert('❌ Brak konfiguracji systemu!');
                        passwordInput.value = '';
                    }
                } catch (error) {
                    console.error("Błąd sprawdzania urządzenia:", error);
                    alert('❌ Błąd połączenia z Firebase!\n' + error.message);
                    passwordInput.value = '';
                }
                return;
            }
            
            if (password === systemSettings.adminPassword && systemSettings.adminPassword !== '') {
                if (!systemSettings.adminEnabled) {
                    alert('❌ Dostęp Premium jest obecnie wyłączony!');
                    passwordInput.value = '';
                    return;
                }
                currentUserRole = 'admin';
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                alert('✅ Zalogowano do konta Premium!');
                passwordInput.value = '';
                return;
            }
            
            if (password === systemSettings.userPassword && systemSettings.userPassword !== '') {
                if (!systemSettings.userEnabled) {
                    alert('❌ Dostęp Użytkownika jest obecnie wyłączony!');
                    passwordInput.value = '';
                    return;
                }
                currentUserRole = 'user';
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                alert('✅ Zalogowano do konta Użytkownika!');
                passwordInput.value = '';
                return;
            }
            
            if (password === '') {
                currentUserRole = 'guest';
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                return;
            }
            
            alert('❌ Nieprawidłowe hasło!');
            passwordInput.value = '';
        }
        
        function logout() {
            currentUserRole = 'guest';
            updateUIForRole();
            updateMenuForRole();
            updateNewSeasonButton();
            updateEndSeasonButton();
            
            if (currentPage === 'games' || currentPage === 'gameSetup' || currentPage === 'game501' || currentPage === 'gameResults') {
                showPage('elo');
            }
        }
        
        function updateUIForRole() {
            const loginBox = document.getElementById('loginBox');
            const adminPanel = document.getElementById('adminPanel');
            const userPanel = document.getElementById('userPanel');
            const devPanel = document.getElementById('devPanel');
            
            if (loginBox) loginBox.classList.add('hidden');
            if (adminPanel) adminPanel.classList.add('hidden');
            if (userPanel) userPanel.classList.add('hidden');
            if (devPanel) devPanel.classList.add('hidden');
            
            if (currentUserRole === 'admin' && adminPanel) {
                adminPanel.classList.remove('hidden');
            } else if (currentUserRole === 'user' && userPanel) {
                userPanel.classList.remove('hidden');
            } else if (currentUserRole === 'dev' && devPanel) {
                devPanel.classList.remove('hidden');
            } else if (loginBox) {
                loginBox.classList.remove('hidden');
            }
            
            updateAllDisplays();
            updateRoleStatusDisplay();
        }
        
        // Ładowanie ustawień systemu
        function loadSystemSettings() {
            if (!db) return;
            
            if (unsubscribeSettings) unsubscribeSettings();
            
            unsubscribeSettings = db.collection('system').doc('settings')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        systemSettings = doc.data();
                        
                        if (systemSettings.adminEnabled === undefined) systemSettings.adminEnabled = false;
                        if (systemSettings.userEnabled === undefined) systemSettings.userEnabled = false;
                        if (!systemSettings.adminPassword) systemSettings.adminPassword = '';
                        if (!systemSettings.userPassword) systemSettings.userPassword = '';
                        if (!systemSettings.offSeasonMatchCount) systemSettings.offSeasonMatchCount = 0;
                        
                        console.log('Ustawienia systemowe załadowane:', systemSettings);
                        updateRoleStatusDisplay();
                    } else {
                        console.log('Brak dokumentu settings w Firebase');
                        systemSettings = {
                            adminEnabled: false,
                            userEnabled: false,
                            adminPassword: '',
                            userPassword: '',
                            offSeasonMatchCount: 0
                        };
                    }
                }, error => {
                    console.error("Błąd ładowania ustawień:", error);
                    systemSettings = {
                        adminEnabled: false,
                        userEnabled: false,
                        adminPassword: '',
                        userPassword: '',
                        offSeasonMatchCount: 0
                    };
                });
        }
        
        function updateRoleStatusDisplay() {
            const adminStatus = document.getElementById('adminStatus');
            const userStatus = document.getElementById('userStatus');
            const currentAdminPassword = document.getElementById('currentAdminPassword');
            const currentUserPassword = document.getElementById('currentUserPassword');
            
            if (adminStatus) {
                if (systemSettings.adminEnabled && systemSettings.adminPassword) {
                    adminStatus.textContent = 'WŁĄCZONY';
                    adminStatus.className = 'role-status status-enabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleAdminRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'WYŁĄCZ';
                    if (currentAdminPassword) currentAdminPassword.textContent = systemSettings.adminPassword;
                } else {
                    adminStatus.textContent = 'WYŁĄCZONY';
                    adminStatus.className = 'role-status status-disabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleAdminRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'WŁĄCZ';
                    if (currentAdminPassword) currentAdminPassword.textContent = systemSettings.adminPassword || 'brak';
                }
            }
            
            if (userStatus) {
                if (systemSettings.userEnabled && systemSettings.userPassword) {
                    userStatus.textContent = 'WŁĄCZONY';
                    userStatus.className = 'role-status status-enabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleUserRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'WYŁĄCZ';
                    if (currentUserPassword) currentUserPassword.textContent = systemSettings.userPassword;
                } else {
                    userStatus.textContent = 'WYŁĄCZONY';
                    userStatus.className = 'role-status status-disabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleUserRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'WŁĄCZ';
                    if (currentUserPassword) currentUserPassword.textContent = systemSettings.userPassword || 'brak';
                }
            }
        }
        
        async function toggleAdminRole() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostęp systemowy może zmieniać ustawienia!');
                return;
            }
            
            const passwordInput = document.getElementById('adminPasswordInput');
            if (!passwordInput) return;
            
            const newPassword = passwordInput.value;
            const newStatus = !systemSettings.adminEnabled;
            
            if (newStatus && (!newPassword || newPassword.length < 3)) {
                alert('Musisz ustawić hasło (minimum 3 znaki) aby włączyć dostęp Premium!');
                passwordInput.focus();
                return;
            }
            
            if (newPassword && newPassword.length > 0) {
                systemSettings.adminPassword = newPassword;
            }
            
            systemSettings.adminEnabled = newStatus;
            
            try {
                await db.collection('system').doc('settings').update({
                    adminEnabled: newStatus,
                    adminPassword: systemSettings.adminPassword,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                passwordInput.value = '';
                updateRoleStatusDisplay();
                
                const statusText = newStatus ? 'włączony' : 'wyłączony';
                alert(`✅ Dostęp Premium został ${statusText}!`);
            } catch (error) {
                alert('Błąd aktualizacji ustawień: ' + error.message);
            }
        }
        
        async function toggleUserRole() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostęp systemowy może zmieniać ustawienia!');
                return;
            }
            
            const passwordInput = document.getElementById('userPasswordInput');
            if (!passwordInput) return;
            
            const newPassword = passwordInput.value;
            const newStatus = !systemSettings.userEnabled;
            
            if (newStatus && (!newPassword || newPassword.length < 3)) {
                alert('Musisz ustawić hasło (minimum 3 znaki) aby włączyć dostęp Użytkownika!');
                passwordInput.focus();
                return;
            }
            
            if (newPassword && newPassword.length > 0) {
                systemSettings.userPassword = newPassword;
            }
            
            systemSettings.userEnabled = newStatus;
            
            try {
                await db.collection('system').doc('settings').update({
                    userEnabled: newStatus,
                    userPassword: systemSettings.userPassword,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                passwordInput.value = '';
                updateRoleStatusDisplay();
                
                const statusText = newStatus ? 'włączony' : 'wyłączony';
                alert(`✅ Dostęp Użytkownika został ${statusText}!`);
            } catch (error) {
                alert('Błąd aktualizacji ustawień: ' + error.message);
            }
        }
        
        // Formatowanie nazwisk
        function formatPlayerName(playerName, forGuest = false) {
            if (!forGuest || currentUserRole !== 'guest') {
                return playerName;
            }
            
            const parts = playerName.trim().split(' ');
            
            if (parts.length === 1) {
                return playerName;
            } else if (parts.length >= 2) {
                const firstName = parts[0];
                const lastName = parts[parts.length - 1];
                const lastNameInitial = lastName.charAt(0).toUpperCase();
                return `${firstName} ${lastNameInitial}.`;
            }
            
            return playerName;
        }
        
        // Obsługa danych z Firestore
        function loadData() {
            if (!db) {
                console.error('Brak połączenia z Firestore');
                return;
            }
            
            // Gracze
            if (unsubscribePlayers) unsubscribePlayers();
            unsubscribePlayers = db.collection('players')
                .orderBy('elo', 'desc')
                .onSnapshot(snapshot => {
                    players = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        players.push({
                            id: doc.id,
                            name: data.name || '',
                            elo: data.elo || 1500,
                            code: data.code || '00000',
                            createdAt: data.createdAt || new Date(),
                            createdBy: data.createdBy || 'unknown'
                        });
                    });
                    updateAllDisplays();
                    updateGamePlayerSelects();
                }, error => {
                    console.error("Błąd ładowania graczy:", error);
                });
            
            // Załaduj odpowiednią historię w zależności od sezonu
            loadHistoryBasedOnSeason();
            
            loadSystemSettings();
        }
        
        // Funkcja do ładowania historii w zależności od sezonu
        function loadHistoryBasedOnSeason() {
            if (!db) return;
            
            // Zatrzymaj poprzednie subskrypcje
            if (unsubscribeHistory) unsubscribeHistory();
            if (unsubscribeOffSeasonHistory) unsubscribeOffSeasonHistory();
            
            const now = new Date();
            
            if (currentSeason) {
                const seasonStart = new Date(currentSeason.startDate);
                const seasonEnd = new Date(currentSeason.endDate);
                
                // Sprawdź czy obecnie trwa sezon
                if (now >= seasonStart && now <= seasonEnd && currentSeason.status !== 'ended') {
                    // Trwa sezon - ładuj z 'history'
                    loadSeasonHistory();
                    updateHistoryTitle(true);
                } else {
                    // Okres poza sezonem - ładuj z 'OffSeasonMatchesArchive'
                    loadOffSeasonHistory();
                    updateHistoryTitle(false);
                }
            } else {
                // Brak sezonu - okres poza sezonem
                loadOffSeasonHistory();
                updateHistoryTitle(false);
            }
        }
        
        // Ładowanie historii sezonu
        function loadSeasonHistory() {
            if (!db) return;
            
            unsubscribeHistory = db.collection('history')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .onSnapshot(snapshot => {
                    history = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        history.push({
                            ...data,
                            id: doc.id
                        });
                    });
                    updateHistory();
                }, error => {
                    console.error("Błąd ładowania historii sezonu:", error);
                });
        }
        
        // Ładowanie historii poza sezonem
        function loadOffSeasonHistory() {
            if (!db) return;
            
            unsubscribeOffSeasonHistory = db.collection('OffSeasonMatchesArchive')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .onSnapshot(snapshot => {
                    offSeasonHistory = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        offSeasonHistory.push({
                            ...data,
                            id: doc.id
                        });
                    });
                    updateHistory();
                }, error => {
                    console.error("Błąd ładowania historii poza sezonem:", error);
                });
        }
        
        // Aktualizacja tytułu historii
        function updateHistoryTitle(isSeason) {
            const historyTitle = document.getElementById('historyTitle');
            if (!historyTitle) return;
            
            if (isSeason) {
                historyTitle.textContent = '📜 OSTATNIE MECZE W SEZONIE';
            } else {
                historyTitle.textContent = '📜 OSTATNIE MECZE POZA SEZONEM';
            }
        }
        
        // Aktualizacja tytułu rankingu
        function updateRankingTitle() {
            const rankingTitle = document.getElementById('rankingTitle');
            if (!rankingTitle) return;
            
            const now = new Date();
            let isSeasonActive = false;
            
            if (currentSeason) {
                const seasonStart = new Date(currentSeason.startDate);
                const seasonEnd = new Date(currentSeason.endDate);
                
                if (now >= seasonStart && now <= seasonEnd && currentSeason.status !== 'ended') {
                    isSeasonActive = true;
                }
            }
            
            if (isSeasonActive) {
                rankingTitle.textContent = '🏆 SEZONOWY RANKING GRACZY';
            } else {
                rankingTitle.textContent = '🏆 POZASEZONOWY RANKING GRACZY';
            }
        }
        
        // Operacje na graczach
        async function addNewPlayer() {
            if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
                alert('Tylko dostęp Premium lub systemowy może dodawać graczy!');
                return;
            }
            
            if (!db) {
                alert('Brak połączenia z bazą danych!');
                return;
            }
            
            const nameInput = document.getElementById('newPlayerName');
            const eloInput = document.getElementById('newPlayerElo');
            const codeInput = document.getElementById('newPlayerCode');
            
            if (!nameInput || !eloInput || !codeInput) return;
            
            const name = nameInput.value.trim();
            const elo = parseInt(eloInput.value) || 1500;
            const code = codeInput.value;
            
            if (!name) {
                alert('Wpisz imię gracza!');
                nameInput.focus();
                return;
            }
            
            if (!code || code.length !== 5) {
                alert('Kod musi mieć dokładnie 5 cyfr!');
                codeInput.focus();
                return;
            }
            
            if (!/^\d{5}$/.test(code)) {
                alert('Kod może zawierać tylko cyfry!');
                codeInput.focus();
                return;
            }
            
            const existingPlayer = players.find(p => 
                p.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingPlayer) {
                alert(`Gracz "${name}" już istnieje!`);
                return;
            }
            
            try {
                await db.collection('players').add({
                    name: name,
                    elo: elo,
                    code: code,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUserRole
                });
                
                nameInput.value = '';
                eloInput.value = 1500;
                codeInput.value = '';
                
                generateRandomCode();
                
                alert(`✅ Dodano gracza: ${name}\nELO: ${elo}\nKod: ${code}`);
            } catch (error) {
                alert('Błąd dodawania gracza: ' + error.message);
            }
        }
        
        async function addNewPlayerDev() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostęp systemowy może dodawać graczy z tego panelu!');
                return;
            }
            
            if (!db) {
                alert('Brak połączenia z bazą danych!');
                return;
            }
            
            const nameInput = document.getElementById('devNewPlayerName');
            const eloInput = document.getElementById('devNewPlayerElo');
            const codeInput = document.getElementById('devNewPlayerCode');
            
            if (!nameInput || !eloInput || !codeInput) return;
            
            const name = nameInput.value.trim();
            const elo = parseInt(eloInput.value) || 1500;
            const code = codeInput.value;
            
            if (!name) {
                alert('Wpisz imię gracza!');
                nameInput.focus();
                return;
            }
            
            if (!code || code.length !== 5) {
                alert('Kod musi mieć dokładnie 5 cyfr!');
                codeInput.focus();
                return;
            }
            
            if (!/^\d{5}$/.test(code)) {
                alert('Kod może zawierać tylko cyfry!');
                codeInput.focus();
                return;
            }
            
            const existingPlayer = players.find(p => 
                p.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingPlayer) {
                alert(`Gracz "${name}" już istnieje!`);
                return;
            }
            
            try {
                await db.collection('players').add({
                    name: name,
                    elo: elo,
                    code: code,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUserRole
                });
                
                nameInput.value = '';
                eloInput.value = 1500;
                codeInput.value = '';
                
                generateRandomCodeDev();
                
                alert(`✅ Dodano gracza: ${name}\nELO: ${elo}\nKod: ${code}`);
            } catch (error) {
                alert('Błąd dodawania gracza: ' + error.message);
            }
        }
        
        async function deletePlayer(playerId) {
            if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
                alert('Tylko dostęp Premium lub systemowy może usuwać graczy!');
                return;
            }
            
            if (!db) {
                alert('Brak połączenia z bazą danych!');
                return;
            }
            
            if (confirm('Czy na pewno chcesz usunąć tego gracza?')) {
                try {
                    await db.collection('players').doc(playerId).delete();
                    alert('Gracz usunięty!');
                } catch (error) {
                    alert('Błąd usuwania gracza: ' + error.message);
                }
            }
        }
        
        // Zamiana graczy
        function swapPlayers() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            const swapBtn = document.getElementById('swapBtn');
            
            if (!selectA || !selectB) return;
            
            const playerAId = selectA.value;
            const playerBId = selectB.value;
            
            if (!playerAId || !playerBId) {
                return;
            }
            
            if (playerAId === playerBId) {
                return;
            }
            
            const temp = playerAId;
            selectA.value = playerBId;
            selectB.value = temp;
            
            updateButtons();
            updateChanceDisplay();
            
            if (swapBtn) {
                swapBtn.style.transform = 'rotate(180deg)';
                swapBtn.style.transition = 'transform 0.3s';
                
                setTimeout(() => {
                    swapBtn.style.transform = 'rotate(0deg)';
                }, 300);
            }
        }
        
        // Event listeners dla selectów
        function onPlayerSelectChange() {
            updateButtons();
            updateChanceDisplay();
            updateSwapButton();
        }
        
        // Funkcje przycisków meczu
        function playerAWins() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz różnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 1
            };
            
            showCodeModal();
        }
        
        function playerBWins() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz różnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 0
            };
            
            showCodeModal();
        }
        
        function draw() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz różnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 0.5
            };
            
            showCodeModal();
        }
        
        // Funkcje pomocnicze
        function updateAllDisplays() {
            updatePlayerSelects();
            updatePlayersList();
            updateChanceDisplay();
            updateSwapButton();
            updateRankingTitle();
        }
        
        function updateSwapButton() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            const swapBtn = document.getElementById('swapBtn');
            
            if (!selectA || !selectB || !swapBtn) return;
            
            const playerAId = selectA.value;
            const playerBId = selectB.value;
            
            if (playerAId && playerBId && playerAId !== playerBId) {
                swapBtn.disabled = false;
                swapBtn.title = "Zamień graczy miejscami";
            } else {
                swapBtn.disabled = true;
                swapBtn.title = "Wybierz różnych graczy aby zamienić";
            }
        }
        
        function updatePlayerSelects() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            
            if (!selectA || !selectB) return;
            
            const currentA = selectA.value;
            const currentB = selectB.value;
            
            selectA.innerHTML = '<option value="">Wybierz gracza</option>';
            selectB.innerHTML = '<option value="">Wybierz gracza</option>';
            
            players.forEach(player => {
                const displayName = formatPlayerName(player.name, true);
                const option = `<option value="${player.id}">${displayName} (${player.elo})</option>`;
                selectA.innerHTML += option;
                selectB.innerHTML += option;
            });
            
            if (currentA && players.some(p => p.id === currentA)) selectA.value = currentA;
            if (currentB && players.some(p => p.id === currentB)) selectB.value = currentB;
            
            updateButtons();
            updateSwapButton();
        }
        
        function updateButtons() {
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            const btnA = document.getElementById('btnA');
            const btnB = document.getElementById('btnB');
            const btnDraw = document.getElementById('btnDraw');
            
            if (btnA) {
                if (playerA) {
                    const displayName = formatPlayerName(playerA.name, true);
                    btnA.textContent = displayName.toUpperCase() + ' WYGRYWA';
                    btnA.disabled = (currentUserRole === 'guest');
                } else {
                    btnA.textContent = 'GRACZ A wygrywa';
                    btnA.disabled = true;
                }
            }
            
            if (btnB) {
                if (playerB) {
                    const displayName = formatPlayerName(playerB.name, true);
                    btnB.textContent = displayName.toUpperCase() + ' WYGRYWA';
                    btnB.disabled = (currentUserRole === 'guest');
                } else {
                    btnB.textContent = 'GRACZ B wygrywa';
                    btnB.disabled = true;
                }
            }
            
            if (btnDraw) {
                if (playerA && playerB) {
                    btnDraw.disabled = (currentUserRole === 'guest');
                } else {
                    btnDraw.disabled = true;
                }
            }
        }
        
        function getSelectedPlayer(player) {
            const selectId = player === 'A' ? 'selectPlayerA' : 'selectPlayerB';
            const select = document.getElementById(selectId);
            if (!select) return null;
            
            const playerId = select.value;
            return players.find(p => p.id === playerId);
        }
        
        function updateChanceDisplay() {
            const chanceElement = document.getElementById('chance');
            if (!chanceElement) return;
            
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                chanceElement.textContent = 'Wybierz obu graczy aby zobaczyć szanse';
                return;
            }
            
            const expected = 1 / (1 + Math.pow(10, (playerB.elo - playerA.elo) / 400));
            const percent = Math.round(expected * 100);
            const displayName = formatPlayerName(playerA.name, true);
            chanceElement.textContent = `Szansa ${displayName}: ${percent}%`;
        }
        
        function updatePlayersList() {
            const listElement = document.getElementById('allPlayersList');
            if (!listElement) return;
            
            const sortedPlayers = [...players].sort((a, b) => b.elo - a.elo);
            
            if (sortedPlayers.length === 0) {
                listElement.innerHTML = '<div>Brak graczy. Dostęp Premium lub systemowy może dodać pierwszego!</div>';
                return;
            }
            
            listElement.innerHTML = sortedPlayers.map((player, index) => {
                let button = '';
                
                if (currentUserRole === 'admin' || currentUserRole === 'dev') {
                    button = `<button class="delete-btn" onclick="deletePlayer('${player.id}')" title="Usuń gracza">✕</button>`;
                } else {
                    button = `<div class="lock-btn" title="Tylko dostęp Premium może usuwać">🔒</div>`;
                }
                
                const displayName = formatPlayerName(player.name, true);
                const emoji = player.elo > 1500 ? '📈' : player.elo < 1500 ? '📉' : '➖';
                
                const codeDisplay = currentUserRole === 'dev' 
                    ? `<br><small>Kod: <span class="player-code">${player.code}</span></small>`
                    : '';
                
                return `
                <div class="player-item">
                    <div style="flex: 1;">
                        <strong>${index + 1}. <span class="player-name-truncate">${displayName}</span></strong><br>
                        <small>ELO: ${player.elo} ${emoji}${codeDisplay}</small>
                    </div>
                    ${button}
                </div>
                `;
            }).join('');
        }
        
        function updateHistory() {
            const historyElement = document.getElementById('historyList');
            if (!historyElement) return;
            
            // Użyj odpowiedniej historii w zależności od sezonu
            const now = new Date();
            let currentMatches = [];
            let isSeasonActive = false;
            
            if (currentSeason) {
                const seasonStart = new Date(currentSeason.startDate);
                const seasonEnd = new Date(currentSeason.endDate);
                
                if (now >= seasonStart && now <= seasonEnd && currentSeason.status !== 'ended') {
                    currentMatches = history;
                    isSeasonActive = true;
                } else {
                    currentMatches = offSeasonHistory;
                }
            } else {
                currentMatches = offSeasonHistory;
            }
            
            if (currentMatches.length === 0) {
                historyElement.innerHTML = '-';
                return;
            }
            
            const recentHistory = currentMatches.slice(0, 10);
            
            historyElement.innerHTML = recentHistory.map(match => {
                const playerADisplay = formatPlayerName(match.playerA, true);
                const playerBDisplay = formatPlayerName(match.playerB, true);
                
                const verifiedIcon = match.verified ? ' ✅' : '';
                const idInfo = match.readableId ? `<br><small style="color: #777;">ID: ${match.readableId}</small>` : '';
                const seasonInfo = isSeasonActive ? '' : '<br><small style="color: #777;">(Mecz pozasezonowy)</small>';
                
                return `
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #444; font-size: 14px;">
                    <div><strong>${playerADisplay} vs ${playerBDisplay}${verifiedIcon}</strong></div>
                    <div>Wynik: ${match.result === 'A' ? `🏆 ${playerADisplay}` : match.result === 'B' ? `🏆 ${playerBDisplay}` : '🤝 Remis'}</div>
                    <div>Zmiana: ${match.change > 0 ? '+' : ''}${match.change}</div>
                    <div style="font-size: 12px; color: #aaa;">${match.date}${idInfo}${seasonInfo}</div>
                </div>
                `;
            }).join('');
        }
        
        // ============================================
        // FUNKCJE GIER 501
        // ============================================
        
        function selectGameMode(mode) {
            if (mode === '501') {
                resetGameState();
                showPage('gameSetup');
            }
        }
        
        function showComingSoon() {
            alert('Ten tryb gry będzie dostępny wkrótce!');
        }
        
        function updateGamePlayerSelects() {
            const select1 = document.getElementById('gameSelectPlayer1');
            const select2 = document.getElementById('gameSelectPlayer2');
            
            if (!select1 || !select2) return;
            
            const current1 = select1.value;
            const current2 = select2.value;
            
            select1.innerHTML = '<option value="">Wybierz gracza</option>';
            select2.innerHTML = '<option value="">Wybierz gracza</option>';
            
            players.forEach(player => {
                const displayName = formatPlayerName(player.name, false);
                const option = `<option value="${player.id}">${displayName} (${player.elo})</option>`;
                select1.innerHTML += option;
                select2.innerHTML += option;
            });
            
            if (current1 && players.some(p => p.id === current1)) select1.value = current1;
            if (current2 && players.some(p => p.id === current2)) select2.value = current2;
            
            updateGameSwapButton();
        }
        
        function swapGamePlayers() {
            const select1 = document.getElementById('gameSelectPlayer1');
            const select2 = document.getElementById('gameSelectPlayer2');
            const swapBtn = document.getElementById('gameSwapBtn');
            
            if (!select1 || !select2) return;
            
            const player1Id = select1.value;
            const player2Id = select2.value;
            
            if (!player1Id || !player2Id) {
                return;
            }
            
            if (player1Id === player2Id) {
                return;
            }
            
            const temp = player1Id;
            select1.value = player2Id;
            select2.value = temp;
            
            if (swapBtn) {
                swapBtn.style.transform = 'rotate(180deg)';
                swapBtn.style.transition = 'transform 0.3s';
                
                setTimeout(() => {
                    swapBtn.style.transform = 'rotate(0deg)';
                }, 300);
            }
        }
        
        function updateGameSwapButton() {
            const select1 = document.getElementById('gameSelectPlayer1');
            const select2 = document.getElementById('gameSelectPlayer2');
            const swapBtn = document.getElementById('gameSwapBtn');
            
            if (!select1 || !select2 || !swapBtn) return;
            
            const player1Id = select1.value;
            const player2Id = select2.value;
            
            if (player1Id && player2Id && player1Id !== player2Id) {
                swapBtn.disabled = false;
                swapBtn.title = "Zamień graczy miejscami";
            } else {
                swapBtn.disabled = true;
                swapBtn.title = "Wybierz różnych graczy aby zamienić";
            }
        }
        
        function start501Game() {
            const select1 = document.getElementById('gameSelectPlayer1');
            const select2 = document.getElementById('gameSelectPlayer2');
            
            if (!select1 || !select2) return;
            
            const player1Id = select1.value;
            const player2Id = select2.value;
            
            if (!player1Id || !player2Id) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (player1Id === player2Id) {
                alert('Wybierz różnych graczy!');
                return;
            }
            
            const player1 = players.find(p => p.id === player1Id);
            const player2 = players.find(p => p.id === player2Id);
            
            if (!player1 || !player2) {
                alert('Błąd: Nie znaleziono graczy!');
                return;
            }
            
            currentGame.player1 = player1;
            currentGame.player2 = player2;
            currentGame.startingPlayer = 1;
            currentGame.currentPlayer = 1;
            currentGame.scores.player1 = 501;
            currentGame.scores.player2 = 501;
            currentGame.legs.player1 = 0;
            currentGame.legs.player2 = 0;
            currentGame.turns = [];
            currentGame.dartsThrown = 0;
            currentGame.gameOver = false;
            currentGame.winner = null;
            currentGame.gameId = 'game_' + Date.now();
            
            currentGame.stats = {
                player1: {
                    totalPoints: 0,
                    dartsThrown: 0,
                    average: 0,
                    highestCheckout: 0,
                    turns: 0
                },
                player2: {
                    totalPoints: 0,
                    dartsThrown: 0,
                    average: 0,
                    highestCheckout: 0,
                    turns: 0
                }
            };
            
            gameHistory = [];
            
            showPage('game501');
            updateGameUI();
        }
        
        function updateGameUI() {
            if (!currentGame.player1 || !currentGame.player2) return;
            
            document.getElementById('player1Name').textContent = currentGame.player1.name;
            document.getElementById('player2Name').textContent = currentGame.player2.name;
            
            document.getElementById('player1Points').textContent = currentGame.scores.player1;
            document.getElementById('player2Points').textContent = currentGame.scores.player2;
            
            document.getElementById('player1Legs').textContent = currentGame.legs.player1;
            document.getElementById('player2Legs').textContent = currentGame.legs.player2;
            
            const avg1 = currentGame.stats.player1.dartsThrown > 0 
                ? (currentGame.stats.player1.totalPoints / currentGame.stats.player1.dartsThrown * 3).toFixed(2)
                : '0.00';
            const avg2 = currentGame.stats.player2.dartsThrown > 0 
                ? (currentGame.stats.player2.totalPoints / currentGame.stats.player2.dartsThrown * 3).toFixed(2)
                : '0.00';
            
            document.getElementById('player1Average').textContent = avg1;
            document.getElementById('player2Average').textContent = avg2;
            
            const currentPlayerName = currentGame.currentPlayer === 1 
                ? currentGame.player1.name 
                : currentGame.player2.name;
            
            document.getElementById('currentPlayerName').textContent = currentPlayerName;
            document.getElementById('dartsThrown').textContent = `${currentGame.dartsThrown}/3`;
            
            document.getElementById('player1Score').classList.remove('active', 'winner');
            document.getElementById('player2Score').classList.remove('active', 'winner');
            
            if (!currentGame.gameOver) {
                if (currentGame.currentPlayer === 1) {
                    document.getElementById('player1Score').classList.add('active');
                } else {
                    document.getElementById('player2Score').classList.add('active');
                }
            } else {
                if (currentGame.winner === 1) {
                    document.getElementById('player1Score').classList.add('winner');
                } else if (currentGame.winner === 2) {
                    document.getElementById('player2Score').classList.add('winner');
                }
            }
            
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.multiplier-btn')[currentMultiplier - 1].classList.add('active');
            
            calculateTurnTotal();
            updateTurnsHistory();
            updateCheckoutHints();
        }
        
        function setMultiplier(multiplier) {
            currentMultiplier = multiplier;
            updateGameUI();
            calculateTurnTotal();
        }
        
        function calculateTurnTotal() {
            const dart1 = parseInt(document.getElementById('dart1').value) || 0;
            const dart2 = parseInt(document.getElementById('dart2').value) || 0;
            const dart3 = parseInt(document.getElementById('dart3').value) || 0;
            
            const total = (dart1 + dart2 + dart3) * currentMultiplier;
            document.getElementById('turnTotal').textContent = total;
            
            const currentScore = currentGame.currentPlayer === 1 
                ? currentGame.scores.player1 
                : currentGame.scores.player2;
            
            const newScore = currentScore - total;
            document.getElementById('newScore').textContent = newScore >= 0 ? newScore : 'BUST!';
            
            if (newScore < 0) {
                document.getElementById('newScore').style.color = '#F44336';
            } else if (newScore === 0) {
                document.getElementById('newScore').style.color = '#4CAF50';
            } else {
                document.getElementById('newScore').style.color = '#4CAF50';
            }
            
            const submitBtn = document.getElementById('submitDartsBtn');
            if (submitBtn) {
                if (dart1 === 0 && dart2 === 0 && dart3 === 0) {
                    submitBtn.disabled = true;
                } else {
                    submitBtn.disabled = false;
                }
            }
        }
        
        function updateCheckoutHints() {
            const currentScore = currentGame.currentPlayer === 1 
                ? currentGame.scores.player1 
                : currentGame.scores.player2;
            
            let hint = '';
            
            if (currentScore <= 170) {
                if (currentScore === 170) hint = 'Checkout: T20 + T20 + Bull';
                else if (currentScore === 167) hint = 'Checkout: T20 + T19 + Bull';
                else if (currentScore === 164) hint = 'Checkout: T20 + T18 + Bull';
                else if (currentScore === 161) hint = 'Checkout: T20 + T17 + Bull';
                else if (currentScore === 160) hint = 'Checkout: T20 + T20 + D20';
                else if (currentScore === 158) hint = 'Checkout: T20 + T20 + D19';
                else if (currentScore === 120) hint = 'Checkout: T20 + T20 + D20 (lub T20 + 20 + D20)';
                else if (currentScore <= 40 && currentScore % 2 === 0) hint = `Checkout: D${currentScore / 2}`;
                else if (currentScore === 50) hint = 'Checkout: Bull';
                else if (currentScore === 25) hint = 'Checkout: Single Bull';
                else if (currentScore < 60) hint = 'Szukaj podwójnego!';
            }
            
            document.getElementById('checkoutHint').textContent = hint;
        }
        
        function submitDarts() {
            const dart1 = parseInt(document.getElementById('dart1').value) || 0;
            const dart2 = parseInt(document.getElementById('dart2').value) || 0;
            const dart3 = parseInt(document.getElementById('dart3').value) || 0;
            
            if (dart1 === 0 && dart2 === 0 && dart3 === 0) {
                alert('Wprowadź punkty z przynajmniej jednego rzutu!');
                return;
            }
            
            const total = (dart1 + dart2 + dart3) * currentMultiplier;
            
            const turn = {
                player: currentGame.currentPlayer,
                darts: [dart1 * currentMultiplier, dart2 * currentMultiplier, dart3 * currentMultiplier],
                total: total,
                timestamp: new Date()
            };
            
            const currentScore = currentGame.currentPlayer === 1 
                ? currentGame.scores.player1 
                : currentGame.scores.player2;
            
            const newScore = currentScore - total;
            
            if (newScore < 0 || (newScore === 1) || (newScore > 0 && newScore < 2)) {
                turn.valid = false;
                turn.result = 'BUST';
                
                currentGame.turns.push(turn);
                gameHistory.push({...turn, playerName: currentGame.currentPlayer === 1 ? currentGame.player1.name : currentGame.player2.name});
                
                currentGame.currentPlayer = currentGame.currentPlayer === 1 ? 2 : 1;
                currentGame.dartsThrown = 0;
                
                clearDartInputs();
                updateGameUI();
                
                alert(`BUST! ${currentGame.currentPlayer === 1 ? currentGame.player2.name : currentGame.player1.name} przekroczył wynik. Kolejka przechodzi do przeciwnika.`);
                return;
            }
            
            if (newScore === 0) {
                const lastDart = dart3 * currentMultiplier;
                const isDoubleFinish = lastDart % 2 === 0 && lastDart <= 40 && lastDart > 0;
                const isBull = lastDart === 50 || lastDart === 25;
                
                if (isDoubleFinish || isBull || (dart1 * currentMultiplier === 0 && dart2 * currentMultiplier === 0 && (isDoubleFinish || isBull))) {
                    turn.valid = true;
                    turn.result = 'WIN';
                    
                    currentGame.turns.push(turn);
                    gameHistory.push({...turn, playerName: currentGame.currentPlayer === 1 ? currentGame.player1.name : currentGame.player2.name});
                    
                    if (currentGame.currentPlayer === 1) {
                        currentGame.legs.player1++;
                        currentGame.stats.player1.turns++;
                        currentGame.stats.player1.totalPoints += total;
                        currentGame.stats.player1.dartsThrown += 3;
                        if (total > currentGame.stats.player1.highestCheckout) {
                            currentGame.stats.player1.highestCheckout = total;
                        }
                    } else {
                        currentGame.legs.player2++;
                        currentGame.stats.player2.turns++;
                        currentGame.stats.player2.totalPoints += total;
                        currentGame.stats.player2.dartsThrown += 3;
                        if (total > currentGame.stats.player2.highestCheckout) {
                            currentGame.stats.player2.highestCheckout = total;
                        }
                    }
                    
                    currentGame.gameOver = true;
                    currentGame.winner = currentGame.currentPlayer;
                    
                    clearDartInputs();
                    updateGameUI();
                    
                    setTimeout(() => {
                        showGameResults();
                    }, 1500);
                    
                    return;
                } else {
                    turn.valid = false;
                    turn.result = 'BUST (no double)';
                    
                    currentGame.turns.push(turn);
                    gameHistory.push({...turn, playerName: currentGame.currentPlayer === 1 ? currentGame.player1.name : currentGame.player2.name});
                    
                    currentGame.currentPlayer = currentGame.currentPlayer === 1 ? 2 : 1;
                    currentGame.dartsThrown = 0;
                    
                    clearDartInputs();
                    updateGameUI();
                    
                    alert('BUST! Ostatni rzut musi być podwójnym (lub bulleye) aby wygrać!');
                    return;
                }
            }
            
            turn.valid = true;
            turn.result = 'OK';
            
            currentGame.turns.push(turn);
            gameHistory.push({...turn, playerName: currentGame.currentPlayer === 1 ? currentGame.player1.name : currentGame.player2.name});
            
            if (currentGame.currentPlayer === 1) {
                currentGame.scores.player1 = newScore;
                currentGame.stats.player1.turns++;
                currentGame.stats.player1.totalPoints += total;
                currentGame.stats.player1.dartsThrown += 3;
            } else {
                currentGame.scores.player2 = newScore;
                currentGame.stats.player2.turns++;
                currentGame.stats.player2.totalPoints += total;
                currentGame.stats.player2.dartsThrown += 3;
            }
            
            currentGame.currentPlayer = currentGame.currentPlayer === 1 ? 2 : 1;
            currentGame.dartsThrown = 0;
            
            clearDartInputs();
            updateGameUI();
        }
        
        function clearDartInputs() {
            document.getElementById('dart1').value = '';
            document.getElementById('dart2').value = '';
            document.getElementById('dart3').value = '';
            currentMultiplier = 1;
            calculateTurnTotal();
        }
        
        function undoLastTurn() {
            if (currentGame.turns.length === 0) {
                alert('Brak kolejek do cofnięcia!');
                return;
            }
            
            if (currentGame.gameOver) {
                alert('Nie można cofnąć po zakończeniu gry!');
                return;
            }
            
            const lastTurn = currentGame.turns.pop();
            gameHistory.pop();
            
            if (!lastTurn) return;
            
            if (lastTurn.player === 1) {
                if (lastTurn.valid && lastTurn.result !== 'WIN') {
                    currentGame.scores.player1 += lastTurn.total;
                }
                currentGame.stats.player1.turns--;
                currentGame.stats.player1.totalPoints -= lastTurn.total;
                currentGame.stats.player1.dartsThrown -= 3;
            } else {
                if (lastTurn.valid && lastTurn.result !== 'WIN') {
                    currentGame.scores.player2 += lastTurn.total;
                }
                currentGame.stats.player2.turns--;
                currentGame.stats.player2.totalPoints -= lastTurn.total;
                currentGame.stats.player2.dartsThrown -= 3;
            }
            
            if (lastTurn.result === 'WIN') {
                if (lastTurn.player === 1) {
                    currentGame.legs.player1--;
                    currentGame.gameOver = false;
                    currentGame.winner = null;
                } else {
                    currentGame.legs.player2--;
                    currentGame.gameOver = false;
                    currentGame.winner = null;
                }
            }
            
            currentGame.currentPlayer = lastTurn.player;
            updateGameUI();
            updateUndoButton();
        }
        
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                undoBtn.disabled = currentGame.turns.length === 0 || currentGame.gameOver;
            }
        }
        
        function updateTurnsHistory() {
            const historyElement = document.getElementById('turnsHistory');
            if (!historyElement) return;
            
            if (gameHistory.length === 0) {
                historyElement.innerHTML = '<div style="text-align: center; color: #777; padding: 20px;">Brak kolejek</div>';
                return;
            }
            
            let historyHTML = '';
            
            const recentTurns = gameHistory.slice(-10).reverse();
            
            recentTurns.forEach(turn => {
                const dartsHTML = turn.darts.map(dart => 
                    `<span class="dart-score">${dart > 0 ? dart : '0'}</span>`
                ).join(' ');
                
                const resultClass = turn.result === 'WIN' ? 'style="color: #4CAF50; font-weight: bold;"' : 
                                  turn.result === 'BUST' ? 'style="color: #F44336;"' : 
                                  '';
                
                historyHTML += `
                    <div class="turn-item">
                        <div>
                            <strong>${turn.playerName}</strong><br>
                            ${dartsHTML}
                        </div>
                        <div>
                            <span ${resultClass}>${turn.total}</span><br>
                            <small style="color: #aaa;">${turn.result || 'OK'}</small>
                        </div>
                    </div>
                `;
            });
            
            historyElement.innerHTML = historyHTML;
            updateUndoButton();
        }
        
        function showGameResults() {
            showPage('gameResults');
            
            document.getElementById('winnerName').textContent = currentGame.winner === 1 
                ? currentGame.player1.name 
                : currentGame.player2.name;
            
            document.getElementById('resultsPlayer1Name').textContent = currentGame.player1.name;
            document.getElementById('resultsPlayer2Name').textContent = currentGame.player2.name;
            
            document.getElementById('resultsPlayer1Score').textContent = currentGame.scores.player1;
            document.getElementById('resultsPlayer2Score').textContent = currentGame.scores.player2;
            
            document.getElementById('resultsPlayer1Legs').textContent = currentGame.legs.player1;
            document.getElementById('resultsPlayer2Legs').textContent = currentGame.legs.player2;
            
            const avg1 = currentGame.stats.player1.dartsThrown > 0 
                ? (currentGame.stats.player1.totalPoints / currentGame.stats.player1.dartsThrown * 3).toFixed(2)
                : '0.00';
            const avg2 = currentGame.stats.player2.dartsThrown > 0 
                ? (currentGame.stats.player2.totalPoints / currentGame.stats.player2.dartsThrown * 3).toFixed(2)
                : '0.00';
            
            document.getElementById('resultsPlayer1Average').textContent = avg1;
            document.getElementById('resultsPlayer2Average').textContent = avg2;
            
            document.getElementById('resultsPlayer1Turns').textContent = currentGame.stats.player1.turns;
            document.getElementById('resultsPlayer2Turns').textContent = currentGame.stats.player2.turns;
            
            document.getElementById('resultsPlayer1Checkout').textContent = currentGame.stats.player1.highestCheckout;
            document.getElementById('resultsPlayer2Checkout').textContent = currentGame.stats.player2.highestCheckout;
        }
        
        function updateEloAuto() {
            if (!currentGame.player1 || !currentGame.player2 || !currentGame.winner) {
                alert('Błąd: Brak danych gry!');
                return;
            }
            
            const scoreA = currentGame.winner === 1 ? 1 : 0;
            
            pendingMatch = {
                playerA: currentGame.player1,
                playerB: currentGame.player2,
                scoreA: scoreA
            };
            
            showCodeModal();
        }
        
        function updateEloManual() {
            showPage('elo');
            
            setTimeout(() => {
                const selectA = document.getElementById('selectPlayerA');
                const selectB = document.getElementById('selectPlayerB');
                
                if (selectA && selectB && currentGame.player1 && currentGame.player2) {
                    selectA.value = currentGame.player1.id;
                    selectB.value = currentGame.player2.id;
                    
                    onPlayerSelectChange();
                    
                    alert('Przejdź teraz do kalkulatora ELO i wybierz wynik meczu ręcznie.');
                }
            }, 500);
        }
        
        function playAgain() {
            const player1 = currentGame.player1;
            const player2 = currentGame.player2;
            
            resetGameState();
            
            currentGame.player1 = player1;
            currentGame.player2 = player2;
            
            showPage('game501');
            updateGameUI();
        }
        
        function resetGameState() {
            currentGame = {
                mode: '501',
                player1: null,
                player2: null,
                startingPlayer: 1,
                currentPlayer: 1,
                scores: {
                    player1: 501,
                    player2: 501
                },
                legs: {
                    player1: 0,
                    player2: 0
                },
                turns: [],
                dartsThrown: 0,
                gameOver: false,
                winner: null,
                gameId: null,
                stats: {
                    player1: {
                        totalPoints: 0,
                        dartsThrown: 0,
                        average: 0,
                        highestCheckout: 0,
                        turns: 0
                    },
                    player2: {
                        totalPoints: 0,
                        dartsThrown: 0,
                        average: 0,
                        highestCheckout: 0,
                        turns: 0
                    }
                }
            };
            
            currentMultiplier = 1;
            gameHistory = [];
        }
        
        // ============================================
        // FUNKCJE GENERUJĄCE STRONY Z ZDJĘCIAMI
        // ============================================
        
        const ranks = [
            { 
                id: 1, 
                name: "Bez rangi", 
                minElo: 0, 
                maxElo: 1000, 
                image: "https://i.ibb.co/hRRPxjDg/Dart-ranga1.png" 
            },
            { 
                id: 2, 
                name: "Rekrut", 
                minElo: 1001, 
                maxElo: 1200, 
                image: "https://i.ibb.co/W49qFwy8/Dart-ranga2.png"
            },
            { 
                id: 3, 
                name: "Nowicjusz", 
                minElo: 1201, 
                maxElo: 1400, 
                image: "https://i.ibb.co/qYQmkn1q/Dart-ranga3.png"
            },
            { 
                id: 4, 
                name: "Amator", 
                minElo: 1401, 
                maxElo: 1600, 
                image: "https://i.ibb.co/Hp4PpQNh/Dart-ranga4.png"
            },
            { 
                id: 5, 
                name: "Srebro", 
                minElo: 1601, 
                maxElo: 1800, 
                image: "https://i.ibb.co/jP1w7ppc/Dart-ranga5.png"
            },
            { 
                id: 6, 
                name: "Złoto", 
                minElo: 1801, 
                maxElo: 2000, 
                image: "https://i.ibb.co/S7XJ9Nw7/Dart-ranga6.png"
            },
            { 
                id: 7, 
                name: "Diamentowa liga", 
                minElo: 2001, 
                maxElo: 2200, 
                image: "https://i.ibb.co/Mk58SMnk/Dart-ranga7.png"
            },
            { 
                id: 8, 
                name: "Liga królewska", 
                minElo: 2201, 
                maxElo: 2400, 
                image: "https://i.ibb.co/pjtv4xp9/Dart-ranga8.png"
            },
            { 
                id: 9, 
                name: "Liga mistrzowska", 
                minElo: 2401, 
                maxElo: 9999, 
                image: "https://i.ibb.co/qbGLk8C/Dart-ranga9.png"
            }
        ];
        
        const achievements = [
            { 
                id: 1, 
                name: "None", 
                description: "Jest to informacja, że użytkownik nie posiada żadnych osiągnięć.",
                image: "https://i.ibb.co/gFSgGXvG/Dart-Place-none.png"
            },
            { 
                id: 2, 
                name: "Top 3 of season", 
                description: "To osiągnięcie zdobywa się za uzyskanie trzeciego miejsca w sezonowym rankingu graczy. Jeżeli jednak dodatkowo użytkownik będzie miał rangę 'Liga mistrzowska', zamiast tego osiągnięcia dostaje osiągnięcie 'RANK9 of season'.",
                image: "https://i.ibb.co/pjG8FvxJ/Dart-Place-third.png"
            },
            { 
                id: 3, 
                name: "Top 2 of season", 
                description: "Użytkownik może otrzymać tą rangę za uzyskanie drugiego miejsca w sezonowym rankingu graczy. Jeżeli jednak dodatkowo użytkownik będzie miał rangę 'Liga mistrzowska', zamiast tego osiągnięcia dostaje osiągnięcie 'RANK9 of season'.",
                image: "https://i.ibb.co/mCh27KL0/Dart-Place-second.png"
            },
            { 
                id: 4, 
                name: "Top 1 of season", 
                description: "Gdy użytkownik osiągnie pierwsze miejsce w sezonowym rankingu graczy, to osiągnięcie zostaje przypisane do jego konta. Jeżeli jednak dodatkowo użytkownik będzie miał rangę 'Liga mistrzowska', zamiast tego osiągnięcia dostaje osiągnięcie 'RANK9 of season'.",
                image: "https://i.ibb.co/1DjXWyg/Dart-Place-first.png"
            },
            { 
                id: 5, 
                name: "RANK9 of season", 
                description: "Osiągnięcie to można zdobyć za ukończenie sezonu z rangą dziewiątą.",
                image: "https://i.ibb.co/PsbcMpb5/Dart-Place-rank9.png"
            },
            { 
                id: 6, 
                name: "Top 1 of season [RANK9]", 
                description: "Jeżeli jesteś pierwszy w sezonowym rankingu graczy oraz zakończyłeś sezon z rangą dziewiątą, to omawiane osiągnięcie jest twoje!",
                image: "https://i.ibb.co/99W5Lgc8/Dart-Place-rank9-first.png"
            }
        ];
        
        // Funkcja do generowania statusu sezonu
        function generateSeasonStatus() {
            const seasonStatusElement = document.getElementById('seasonStatus');
            if (!seasonStatusElement) return;
            
            if (!currentSeason) {
                seasonStatusElement.className = 'season-status off-season';
                seasonStatusElement.innerHTML = `
                    <div class="season-name">🏁 OKRES POZASEZONOWY</div>
                    <div class="season-dates">Brak aktywnych sezonów</div>
                    <div class="season-days-left">Możesz przygotować nowy sezon</div>
                `;
                return;
            }
            
            const now = new Date();
            const startDate = new Date(currentSeason.startDate);
            const endDate = new Date(currentSeason.endDate);
            
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const seasonStart = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const seasonEnd = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            
            const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            
            if (today < seasonStart) {
                const daysToStart = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                seasonStatusElement.className = 'season-status off-season';
                seasonStatusElement.innerHTML = `
                    <div class="season-name">⏳ SEZON WKRÓTCE</div>
                    <div class="season-dates">${currentSeason.name || `Sezon ${currentSeason.seasonNumber}`}</div>
                    <div class="season-dates">Rozpocznie się: ${formatDate(startDate)}</div>
                    <div class="season-days-left">Za ${daysToStart} ${daysToStart === 1 ? 'dzień' : 'dni'}</div>
                `;
            } else if (today > seasonEnd) {
                seasonStatusElement.className = 'season-status ended';
                seasonStatusElement.innerHTML = `
                    <div class="season-name">🏁 SEZON ZAKOŃCZONY</div>
                    <div class="season-dates">${currentSeason.name || `Sezon ${currentSeason.seasonNumber}`}</div>
                    <div class="season-dates">${formatDate(startDate)} - ${formatDate(endDate)}</div>
                    <div class="season-days-left">Zakończył się ${Math.abs(daysLeft)} ${Math.abs(daysLeft) === 1 ? 'dzień' : 'dni'} temu</div>
                `;
            } else {
                seasonStatusElement.className = 'season-status running';
                seasonStatusElement.innerHTML = `
                    <div class="season-name">🏆 TRWA SEZON!</div>
                    <div class="season-dates">${currentSeason.name || `Sezon ${currentSeason.seasonNumber}`}</div>
                    <div class="season-dates">${formatDate(startDate)} - ${formatDate(endDate)}</div>
                    <div class="season-days-left">Pozostało ${daysLeft} ${daysLeft === 1 ? 'dzień' : 'dni'}</div>
                `;
            }
        }
        
        // Funkcja do generowania strony rang Z ZDJĘCIAMI
        function generateRanksPage() {
            const ranksListElement = document.getElementById('ranksList');
            if (!ranksListElement) return;
            
            const rankThresholds = currentSeason ? currentSeason.rankThresholds : {};
            
            const playersByRank = {};
            ranks.forEach(rank => {
                const minElo = rankThresholds[rank.id] || rank.minElo;
                const maxElo = rankThresholds[rank.id + 1] ? rankThresholds[rank.id + 1] - 1 : rank.maxElo;
                
                playersByRank[rank.id] = players.filter(player => 
                    player.elo >= minElo && player.elo <= maxElo
                );
            });
            
            ranks.forEach(rank => {
                playersByRank[rank.id].sort((a, b) => b.elo - a.elo);
            });
            
            let ranksHTML = '';
            
            ranks.forEach(rank => {
                const playersInRank = playersByRank[rank.id];
                const playersCount = playersInRank.length;
                
                const minElo = rankThresholds[rank.id] || rank.minElo;
                let maxElo = rank.maxElo;
                
                if (rank.id < 9) {
                    maxElo = rankThresholds[rank.id + 1] ? rankThresholds[rank.id + 1] - 1 : rank.maxElo;
                }
                
                let eloRange = '';
                if (rank.id === 1) {
                    eloRange = `Wymagane ELO: ${minElo}-${maxElo}`;
                } else if (rank.id === ranks.length) {
                    eloRange = `Wymagane ELO: ${minElo}+`;
                } else {
                    eloRange = `Wymagane ELO: ${minElo}`;
                }
                
                let playersHTML = '';
                if (playersCount > 0) {
                    playersHTML = '<div class="players-on-rank">';
                    const playersToShow = playersInRank.slice(0, 8);
                    
                    playersToShow.forEach(player => {
                        const displayName = formatPlayerName(player.name, true);
                        playersHTML += `
                            <div class="player-on-rank" title="${displayName} - ELO: ${player.elo}">
                                <span class="player-name-truncate">${displayName}</span>
                                <span class="player-on-rank-elo">${player.elo}</span>
                            </div>
                        `;
                    });
                    
                    if (playersCount > 8) {
                        playersHTML += `<div class="player-on-rank" style="background: #444;">+${playersCount - 8} więcej</div>`;
                    }
                    
                    playersHTML += '</div>';
                } else {
                    playersHTML = '<div class="no-players">Brak graczy na tej randze</div>';
                }
                
                const rankClass = rank.id === 1 ? 'rank-1' : (rank.id === 9 ? 'rank-9' : '');
                
                ranksHTML += `
                    <div class="rank-container ${rankClass}">
                        <div class="rank-number">${rank.id}</div>
                        
                        <div class="rank-image-container">
                            ${rank.image ? 
                                `<img src="${rank.image}" alt="${rank.name}" class="rank-image">` : 
                                `<div style="color: #777; font-size: 12px; text-align: center; padding: 10px;">
                                    Ranga ${rank.id}<br>
                                    (brak obrazka)
                                 </div>`
                            }
                        </div>
                        
                        <div class="rank-info">
                            <div class="rank-name">${rank.name}</div>
                            <div class="rank-elo">${eloRange}</div>
                            <div class="rank-elo" style="margin-top: 5px;">Graczy: ${playersCount}</div>
                        </div>
                        
                        <div class="rank-players">
                            <div style="font-size: 13px; color: #aaa; margin-bottom: 8px;">Gracze na tej randze:</div>
                            ${playersHTML}
                        </div>
                    </div>
                `;
            });
            
            ranksListElement.innerHTML = ranksHTML;
            
            updateNewSeasonButton();
            updateEndSeasonButton();
        }
        
        // Funkcja do generowania strony osiągnięć Z ZDJĘCIAMI
        function generateAchievementsPage() {
            const achievementsListElement = document.getElementById('achievementsList');
            if (!achievementsListElement) return;
            
            let achievementsHTML = '';
            
            achievements.forEach(achievement => {
                const isNoneAchievement = achievement.id === 1;
                const borderColor = isNoneAchievement ? '#666' : '#FF9800';
                const nameColor = isNoneAchievement ? '#666' : '#FF9800';
                
                achievementsHTML += `
                    <div class="achievement-container" style="border-left-color: ${borderColor};">
                        <div class="achievement-image-container" style="border-color: ${borderColor};">
                            ${achievement.image ? 
                                `<img src="${achievement.image}" alt="${achievement.name}" class="achievement-image">` : 
                                `<div style="color: #777; font-size: 11px; text-align: center; padding: 5px;">
                                    Osiągnięcie ${achievement.id}
                                 </div>`
                            }
                        </div>
                        
                        <div class="achievement-text-container">
                            <div class="achievement-name" style="color: ${nameColor};">${achievement.name}</div>
                            <div class="achievement-description">
                                ${achievement.description}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            achievementsListElement.innerHTML = achievementsHTML;
        }
        
        // Aktualizuj przycisk nowego sezonu
        function updateNewSeasonButton() {
            const newSeasonBtn = document.getElementById('newSeasonBtn');
            if (!newSeasonBtn) return;
            
            if (currentUserRole === 'admin' || currentUserRole === 'dev') {
                newSeasonBtn.classList.remove('hidden');
                
                const now = new Date();
                let canStartNewSeason = true;
                
                if (currentSeason) {
                    const endDate = new Date(currentSeason.endDate);
                    if (now <= endDate) {
                        canStartNewSeason = false;
                        newSeasonBtn.disabled = true;
                        newSeasonBtn.classList.add('disabled');
                        newSeasonBtn.innerHTML = '🚫 Sezon w trakcie';
                    } else {
                        newSeasonBtn.disabled = false;
                        newSeasonBtn.classList.remove('disabled');
                        newSeasonBtn.innerHTML = '🚀 Zacznij nowy sezon';
                    }
                } else {
                    newSeasonBtn.disabled = false;
                    newSeasonBtn.classList.remove('disabled');
                    newSeasonBtn.innerHTML = '🚀 Zacznij nowy sezon';
                }
            } else {
                newSeasonBtn.classList.add('hidden');
            }
        }
        
        // Aktualizuj przycisk zakończenia sezonu (tylko dla DEV)
        function updateEndSeasonButton() {
            const endSeasonBtn = document.getElementById('endSeasonBtn');
            if (!endSeasonBtn) return;
            
            if (currentUserRole === 'dev') {
                endSeasonBtn.classList.remove('hidden');
                
                if (currentSeason) {
                    const now = new Date();
                    const startDate = new Date(currentSeason.startDate);
                    
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const seasonStart = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    
                    if (today >= seasonStart) {
                        endSeasonBtn.disabled = false;
                        endSeasonBtn.classList.remove('disabled');
                        endSeasonBtn.innerHTML = '⏹️ Zakończ sezon (SYSTEM)';
                    } else {
                        endSeasonBtn.disabled = true;
                        endSeasonBtn.classList.add('disabled');
                        endSeasonBtn.innerHTML = '⏳ Sezon jeszcze się nie rozpoczął';
                    }
                } else {
                    endSeasonBtn.disabled = true;
                    endSeasonBtn.classList.add('disabled');
                    endSeasonBtn.innerHTML = '🚫 Brak aktywnego sezonu';
                }
            } else {
                endSeasonBtn.classList.add('hidden');
            }
        }
        
        // ============================================
        // NOWY SYSTEM PAGINACJI (STRONICOWANIA) SEZONÓW
        // ============================================
        
        // NOWA FUNKCJA: Obliczanie ilości sezonów na stronę z odwróconą logiką
        function calculateSeasonsPerPage() {
            const totalSeasons = seasonsPagination.allSeasons.length;
            
            if (totalSeasons === 0) return { pages: 1, seasonsPerPage: [] };
            
            let pages = 1;
            const seasonsPerPage = [];
            
            // ODWRÓCONA LOGIKA: Ostatnia strona pełna, pierwsza częściowo
            if (totalSeasons <= 10) {
                pages = 1;
                seasonsPerPage.push(totalSeasons);
            } else {
                // Oblicz ile pełnych stron można mieć
                const fullPages = Math.floor(totalSeasons / 10);
                const remainingSeasons = totalSeasons % 10;
                
                if (remainingSeasons > 0) {
                    pages = fullPages + 1;
                    // Pierwsza strona ma pozostałe sezony (1-9)
                    seasonsPerPage.push(remainingSeasons);
                    // Kolejne strony po 10 sezonów
                    for (let i = 1; i < pages; i++) {
                        seasonsPerPage.push(10);
                    }
                } else {
                    pages = fullPages;
                    // Wszystkie strony po 10 sezonów
                    for (let i = 0; i < pages; i++) {
                        seasonsPerPage.push(10);
                    }
                }
            }
            
            return { pages, seasonsPerPage };
        }
        
        // ZMIENIONA FUNKCJA: Generowanie strony wcześniejszych sezonów z odwróconą paginacją
        async function generateSeasonsPage() {
            const seasonsListElement = document.getElementById('seasonsList');
            const seasonsPaginationElement = document.getElementById('seasonsPagination');
            
            if (!seasonsListElement || !seasonsPaginationElement) return;
            
            // Załaduj wszystkie sezony
            await loadAllSeasons();
            
            // Oblicz paginację z odwróconą logiką
            const paginationInfo = calculateSeasonsPerPage();
            seasonsPagination.totalPages = paginationInfo.pages;
            const seasonsPerPage = paginationInfo.seasonsPerPage;
            
            if (seasonsPagination.allSeasons.length === 0) {
                seasonsListElement.innerHTML = `
                    <div class="season-container">
                        <div class="season-info">
                            <div class="season-name-in-list">Brak wcześniejszych sezonów</div>
                            <div class="season-details">Jeszcze nie rozegrano żadnego sezonu.</div>
                        </div>
                    </div>
                `;
                seasonsPaginationElement.classList.add('hidden');
                return;
            }
            
            // Pokaż kontener paginacji
            seasonsPaginationElement.classList.remove('hidden');
            
            // Oblicz zakres sezonów do wyświetlenia (ODWRÓCONA LOGIKA)
            let startIndex = 0;
            let endIndex = 0;
            
            // Ponieważ pierwsza strona ma mniej sezonów, musimy obliczyć indeksy inaczej
            if (seasonsPagination.currentPage === 1) {
                // Pierwsza strona: 0 do seasonsPerPage[0]
                endIndex = seasonsPerPage[0];
            } else {
                // Kolejne strony: sumujemy sezony z poprzednich stron
                for (let i = 0; i < seasonsPagination.currentPage - 1; i++) {
                    startIndex += seasonsPerPage[i];
                }
                endIndex = startIndex + seasonsPerPage[seasonsPagination.currentPage - 1];
            }
            
            const seasonsToShow = seasonsPagination.allSeasons.slice(startIndex, endIndex);
            
            let seasonsHTML = '';
            
            seasonsToShow.forEach(season => {
                const isExpanded = expandedSeasonId === season.id;
                const expandedClass = isExpanded ? 'expanded' : '';
                
                const startDate = new Date(season.startDate);
                const endDate = new Date(season.endDate);
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                
                const matchesPlayed = season.matchesPlayed || 0;
                const matchesCounter = matchesPlayed > 0 ? 
                    `<span class="matches-counter" title="Rozegrane mecze">🎯 ${matchesPlayed}</span>` : '';
                
                seasonsHTML += `
                    <div class="season-container ${expandedClass}" onclick="toggleSeasonExpansion('${season.id}')">
                        <div class="season-info">
                            <div class="season-name-in-list">${season.name || `Sezon ${season.seasonNumber}`} ${matchesCounter}</div>
                            <div class="season-details">
                                <strong>Okres:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}<br>
                                <strong>Długość:</strong> ${days} dni<br>
                                <strong>Uczestników:</strong> ${season.participants || 0}<br>
                                <strong>Rozegrane mecze:</strong> ${matchesPlayed}
                            </div>
                            
                            <div class="season-expanded-content ${isExpanded ? 'show' : ''}">
                                ${generateSeasonExpandedContent(season)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            seasonsListElement.innerHTML = seasonsHTML;
            
            // Aktualizuj paginację
            updatePaginationControls();
        }
        
        // Funkcja do ładowania wszystkich sezonów (nie tylko 10)
        async function loadAllSeasons() {
            if (!db) return;
            
            try {
                const seasonsSnapshot = await db.collection('seasons')
                    .orderBy('seasonNumber', 'desc')
                    .get();
                
                seasonsPagination.allSeasons = [];
                seasonsSnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    if (data.status === 'ended') {
                        seasonsPagination.allSeasons.push(data);
                    }
                });
                
                console.log(`Załadowano ${seasonsPagination.allSeasons.length} zakończonych sezonów`);
                
            } catch (error) {
                console.error("Błąd ładowania wszystkich sezonów:", error);
                seasonsPagination.allSeasons = [];
            }
        }
        
        // NOWA FUNKCJA: Otwieranie modala wyboru strony z przewijaną listą
        function openPageSelectorModal() {
            const modal = document.getElementById('pageSelectorModal');
            const pageSelectorList = document.getElementById('pageSelectorList');
            const pageSelectorInfo = document.getElementById('pageSelectorInfo');
            
            if (!modal || !pageSelectorList || !pageSelectorInfo) return;
            
            // Wyczyść poprzednią listę
            pageSelectorList.innerHTML = '';
            
            // Utwórz kontener dla listy
            const listContainer = document.createElement('div');
            listContainer.className = 'page-list';
            
            // Dodaj przyciski dla każdej strony
            for (let i = 1; i <= seasonsPagination.totalPages; i++) {
                const button = document.createElement('button');
                button.className = 'page-number-btn';
                if (i === seasonsPagination.currentPage) {
                    button.classList.add('active');
                }
                button.textContent = `Strona ${i}`;
                button.onclick = () => {
                    seasonsPagination.currentPage = i;
                    generateSeasonsPage();
                    closePageSelectorModal();
                };
                listContainer.appendChild(button);
            }
            
            pageSelectorList.appendChild(listContainer);
            
            // Ustaw informację o ilości stron
            const totalSeasons = seasonsPagination.allSeasons.length;
            const seasonsOnCurrentPage = getSeasonsOnCurrentPage();
            
            pageSelectorInfo.innerHTML = `
                Łącznie: ${totalSeasons} sezonów<br>
                Stron: ${seasonsPagination.totalPages}<br>
                Na bieżącej stronie: ${seasonsOnCurrentPage} sezonów
            `;
            
            // Pokaż modal
            modal.classList.add('active');
        }
        
        // NOWA FUNKCJA: Pobierz ilość sezonów na bieżącej stronie
        function getSeasonsOnCurrentPage() {
            const paginationInfo = calculateSeasonsPerPage();
            const seasonsPerPage = paginationInfo.seasonsPerPage;
            
            if (seasonsPagination.currentPage === 1) {
                return seasonsPerPage[0];
            } else {
                return seasonsPerPage[seasonsPagination.currentPage - 1] || 10;
            }
        }
        
        // Funkcja do zmiany strony sezonów
        function changeSeasonsPage(direction) {
            const newPage = seasonsPagination.currentPage + direction;
            
            if (newPage < 1 || newPage > seasonsPagination.totalPages) {
                return;
            }
            
            seasonsPagination.currentPage = newPage;
            generateSeasonsPage();
        }
        
        // Funkcja do aktualizacji kontrolek paginacji
        function updatePaginationControls() {
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageIndicator = document.getElementById('pageIndicator');
            
            if (!prevPageBtn || !nextPageBtn || !pageIndicator) return;
            
            // Aktualizuj przyciski strzałek
            prevPageBtn.disabled = seasonsPagination.currentPage <= 1;
            nextPageBtn.disabled = seasonsPagination.currentPage >= seasonsPagination.totalPages;
            
            // Pokaż/ukryj strzałki w zależności od liczby stron
            if (seasonsPagination.totalPages <= 1) {
                prevPageBtn.style.display = 'none';
                nextPageBtn.style.display = 'none';
            } else {
                prevPageBtn.style.display = 'flex';
                nextPageBtn.style.display = 'flex';
            }
            
            // Aktualizuj wskaźnik strony
            const seasonsOnCurrentPage = getSeasonsOnCurrentPage();
            pageIndicator.textContent = `${seasonsPagination.currentPage} z ${seasonsPagination.totalPages} (${seasonsOnCurrentPage} sezonów)`;
            pageIndicator.title = `Kliknij aby wybrać stronę`;
        }
        
        // Funkcja do zamykania modala wyboru strony
        function closePageSelectorModal() {
            const modal = document.getElementById('pageSelectorModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // Funkcja do generowania rozszerzonej zawartości sezonu
        function generateSeasonExpandedContent(season) {
            const startDate = new Date(season.startDate);
            const endDate = new Date(season.endDate);
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const matchesPlayed = season.matchesPlayed || 0;
            
            let contentHTML = `
                <div class="season-stats-grid">
                    <div class="season-podium">
                        <h4>🏆 Podium sezonu:</h4>
            `;
            
            if (season.podium && season.podium.length > 0) {
                season.podium.forEach((player, index) => {
                    contentHTML += `
                        <div class="podium-item">
                            <div class="podium-place podium-place-${index + 1}">${index + 1}</div>
                            <div>
                                <strong>${player.name}</strong><br>
                                <small>ELO: ${player.elo}</small>
                            </div>
                        </div>
                    `;
                });
            } else {
                contentHTML += `<p style="color: #777; text-align: center;">Brak danych podium</p>`;
            }
            
            contentHTML += `
                    </div>
                    
                    <div class="season-player-ranking">
                        <h4>📊 Ranking sezonu:</h4>
            `;
            
            if (season.finalEloStats && season.finalEloStats.length > 0) {
                const sortedPlayers = season.finalEloStats.sort((a, b) => b.finalElo - a.finalElo);
                const playersToShow = sortedPlayers.slice(0, 10);
                
                playersToShow.forEach((player, index) => {
                    const placeClass = index < 3 ? `ranking-place-${index + 1}` : '';
                    contentHTML += `
                        <div class="ranking-item">
                            <div class="ranking-place ${placeClass}">${index + 1}</div>
                            <div>
                                <strong>${player.name}</strong><br>
                                <small>ELO: ${player.finalElo}</small>
                            </div>
                        </div>
                    `;
                });
                
                if (sortedPlayers.length > 10) {
                    contentHTML += `<p style="text-align: center; color: #aaa; font-size: 12px;">... i ${sortedPlayers.length - 10} więcej</p>`;
                }
            } else {
                contentHTML += `<p style="color: #777; text-align: center;">Brak danych rankingu</p>`;
            }
            
            contentHTML += `
                    </div>
                </div>
                
                <div style="background: #1a1a1a; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4>📈 Podsumowanie sezonu:</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: #2d2d2d; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${season.participants || 0}</div>
                            <div style="font-size: 12px; color: #aaa;">Uczestników</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #2d2d2d; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${matchesPlayed}</div>
                            <div style="font-size: 12px; color: #aaa;">Rozegranych meczy</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #2d2d2d; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${days}</div>
                            <div style="font-size: 12px; color: #aaa;">Dni trwania</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #2d2d2d; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${season.achievements ? season.achievements.length : 0}</div>
                            <div style="font-size: 12px; color: #aaa;">Przyznanych osiągnięć</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Osiągnięcia
            if (season.achievements && season.achievements.length > 0) {
                contentHTML += `
                    <div class="achievements-section">
                        <h4>🏅 Osiągnięcia sezonu:</h4>
                `;
                
                season.achievements.forEach(achievement => {
                    if (achievement.type !== 'None') {
                        const achievementData = achievements.find(a => a.name === achievement.type);
                        const achievementImage = achievementData ? achievementData.image : '';
                        
                        contentHTML += `
                            <div class="achievement-item">
                                <div class="achievement-item-image">
                                    ${achievementImage ? `<img src="${achievementImage}" alt="${achievement.type}">` : '🏅'}
                                </div>
                                <div>
                                    <strong>${achievement.playerName}</strong><br>
                                    <small>${achievement.type}</small>
                                </div>
                            </div>
                        `;
                    }
                });
                
                if (season.achievements.filter(a => a.type === 'None').length > 0) {
                    contentHTML += `<p style="color: #777; font-size: 12px; text-align: center;">Osiągnięcie "None" nie jest wyświetlane</p>`;
                }
                
                contentHTML += `</div>`;
            }
            
            // System rang sezonu - Z ZDJĘCIAMI
            if (season.rankThresholds) {
                contentHTML += `
                    <div class="ranks-section">
                        <h4>⭐ System rang w sezonie:</h4>
                `;
                
                ranks.forEach(rank => {
                    const minElo = season.rankThresholds[rank.id] || rank.minElo;
                    let maxElo = rank.maxElo;
                    
                    if (rank.id < 9) {
                        maxElo = season.rankThresholds[rank.id + 1] ? season.rankThresholds[rank.id + 1] - 1 : rank.maxElo;
                    }
                    
                    let eloRange = '';
                    if (rank.id === 1) {
                        eloRange = `ELO: ${minElo}-${maxElo}`;
                    } else if (rank.id === ranks.length) {
                        eloRange = `ELO: ${minElo}+`;
                    } else {
                        eloRange = `ELO: ${minElo}`;
                    }
                    
                    const rankClass = rank.id === 1 ? 'rank-1' : (rank.id === 9 ? 'rank-9' : '');
                    
                    contentHTML += `
                        <div class="season-rank-item ${rankClass}">
                            <div class="season-rank-header">
                                <div class="season-rank-number">${rank.id}</div>
                                <div class="season-rank-name">${rank.name}</div>
                                <div class="season-rank-elo">${eloRange}</div>
                            </div>
                            
                            <div class="season-rank-image-container">
                                ${rank.image ? 
                                    `<img src="${rank.image}" alt="${rank.name}" class="season-rank-image">` : 
                                    `<div style="color: #777; font-size: 10px; text-align: center; padding: 5px;">
                                        Ranga ${rank.id}
                                     </div>`
                                }
                            </div>
                    `;
                    
                    if (season.finalEloStats) {
                        const playersInRank = season.finalEloStats.filter(player => 
                            player.finalElo >= minElo && player.finalElo <= maxElo
                        );
                        
                        if (playersInRank.length > 0) {
                            contentHTML += `<div class="season-rank-players">`;
                            const playersToShow = playersInRank.slice(0, 5);
                            
                            playersToShow.forEach(player => {
                                contentHTML += `
                                    <div class="season-rank-player">
                                        <span>${player.name}</span>
                                        <span class="season-rank-player-elo">${player.finalElo}</span>
                                    </div>
                                `;
                            });
                            
                            if (playersInRank.length > 5) {
                                contentHTML += `<div class="season-rank-player" style="background: #444;">+${playersInRank.length - 5} więcej</div>`;
                            }
                            
                            contentHTML += `</div>`;
                        } else {
                            contentHTML += `<p style="color: #777; font-size: 12px; text-align: center;">Brak graczy na tej randze</p>`;
                        }
                    } else {
                        contentHTML += `<p style="color: #777; font-size: 12px; text-align: center;">Brak danych graczy</p>`;
                    }
                    
                    contentHTML += `</div>`;
                });
                
                contentHTML += `</div>`;
            }
            
            return contentHTML;
        }
        
        // Funkcja do rozwijania/zwijania sezonu
        function toggleSeasonExpansion(seasonId) {
            if (expandedSeasonId === seasonId) {
                expandedSeasonId = null;
            } else {
                expandedSeasonId = seasonId;
            }
            generateSeasonsPage();
        }
        
        // Funkcja do generowania formularza nowego sezonu
        function generateNewSeasonForm() {
            const eloThresholdsElement = document.getElementById('eloThresholds');
            if (!eloThresholdsElement) return;
            
            let thresholdsHTML = '';
            
            for (let i = 1; i <= 8; i++) {
                const rank = ranks.find(r => r.id === i);
                if (!rank) continue;
                
                thresholdsHTML += `
                    <div class="elo-threshold-item">
                        <label>${rank.name} (Ranga ${i}):</label>
                        <input type="number" 
                               id="rankThreshold${i}" 
                               class="rank-threshold-input"
                               min="${i === 1 ? 0 : 1}" 
                               value="${rank.minElo}"
                               onchange="validateThresholds()">
                        <small style="color: #aaa; font-size: 12px;">Minimalne ELO</small>
                    </div>
                `;
            }
            
            thresholdsHTML += `
                <div class="elo-threshold-item">
                    <label>${ranks[8].name} (Ranga 9):</label>
                    <input type="number" 
                           id="rankThreshold9" 
                           class="rank-threshold-input"
                           min="1" 
                           value="${ranks[8].minElo}"
                           onchange="validateThresholds()">
                    <small style="color: #aaa; font-size: 12px;">Minimalne ELO</small>
                </div>
            `;
            
            eloThresholdsElement.innerHTML = thresholdsHTML;
            
            const today = new Date().toISOString().split('T')[0];
            const startDateInput = document.getElementById('seasonStartDate');
            const endDateInput = document.getElementById('seasonEndDate');
            
            if (startDateInput) {
                startDateInput.min = today;
                if (!startDateInput.value) {
                    startDateInput.value = today;
                }
            }
            
            if (endDateInput) {
                endDateInput.min = today;
                if (!endDateInput.value) {
                    const defaultEndDate = new Date();
                    defaultEndDate.setDate(defaultEndDate.getDate() + 30);
                    endDateInput.value = defaultEndDate.toISOString().split('T')[0];
                }
            }
            
            validateThresholds();
            validateSeasonDates();
        }
        
        // Walidacja progów ELO
        function validateThresholds() {
            let isValid = true;
            let previousValue = 0;
            
            for (let i = 1; i <= 9; i++) {
                const input = document.getElementById(`rankThreshold${i}`);
                if (!input) continue;
                
                const value = parseInt(input.value) || 0;
                
                if (i === 1) {
                    if (value < 0) {
                        input.style.borderColor = '#f44336';
                        isValid = false;
                    } else {
                        input.style.borderColor = '#444';
                    }
                } else {
                    if (value <= previousValue) {
                        input.style.borderColor = '#f44336';
                        isValid = false;
                    } else {
                        input.style.borderColor = '#444';
                    }
                }
                
                previousValue = value;
            }
            
            return isValid;
        }
        
        // Walidacja dat sezonu
        function validateSeasonDates() {
            const startDateInput = document.getElementById('seasonStartDate');
            const endDateInput = document.getElementById('seasonEndDate');
            const createBtn = document.getElementById('createSeasonBtn');
            
            if (!startDateInput || !endDateInput || !createBtn) return;
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (startDateInput.value) {
                const minEndDate = new Date(startDate);
                minEndDate.setDate(minEndDate.getDate() + 1);
                const minEndDateStr = minEndDate.toISOString().split('T')[0];
                if (endDateInput.min !== minEndDateStr) {
                    endDateInput.min = minEndDateStr;
                }
            }
            
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            const startDateOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            
            const isValid = startDateOnly >= now && 
                           endDate > startDate && 
                           validateThresholds();
            
            createBtn.disabled = !isValid;
            
            return isValid;
        }
        
        // ============================================
        // POPRAWIONA FUNKCJA: ARCHIWIZACJA HISTORII MECZÓW
        // ============================================
        
        async function archiveOldMatches(seasonNumber) {
            if (!db) {
                console.error('Brak połączenia z Firebase');
                return;
            }
            
            console.log(`🔍 Archiwizacja meczów dla sezonu ${seasonNumber}...`);
            
            try {
                const historySnapshot = await db.collection('history').get();
                
                if (historySnapshot.empty) {
                    console.log('Brak meczów do archiwizacji');
                    return;
                }
                
                const batch = db.batch();
                let archivedCount = 0;
                
                historySnapshot.forEach(doc => {
                    const matchData = doc.data();
                    
                    // ZACHOWUJEMY ORYGINALNY readableId
                    const archivedMatch = {
                        ...matchData,
                        archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        archivedSeason: seasonNumber,
                        originalId: doc.id,
                        // WAŻNE: Zachowujemy oryginalny readableId
                        readableId: matchData.readableId || doc.id
                    };
                    
                    // Używamy ORYGINALNEGO readableId jako ID dokumentu w archiwum
                    const archiveId = matchData.readableId || doc.id;
                    const archiveRef = db.collection('matchesArchive').doc(archiveId);
                    batch.set(archiveRef, archivedMatch);
                    
                    batch.delete(doc.ref);
                    
                    archivedCount++;
                });
                
                await batch.commit();
                console.log(`✅ Zarchiwizowano ${archivedCount} meczów do archiwum dla sezonu ${seasonNumber}`);
                return archivedCount;
                
            } catch (error) {
                console.error('Błąd archiwizacji meczów:', error);
                throw error;
            }
        }
        
        // ============================================
        // POPRAWIONA FUNKCJA: ROZPOCZNIJ NOWY SEZON
        // ============================================
        
        async function createNewSeason() {
            if (!db) {
                alert('Brak połączenia z Firebase!');
                return;
            }
            
            if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
                alert('Tylko administrator może rozpocząć nowy sezon!');
                return;
            }
            
            const now = new Date();
            if (currentSeason) {
                const endDate = new Date(currentSeason.endDate);
                if (now <= endDate) {
                    alert('Nie można rozpocząć nowego sezonu podczas trwania obecnego!');
                    return;
                }
            }
            
            const rankThresholds = {};
            for (let i = 1; i <= 9; i++) {
                const input = document.getElementById(`rankThreshold${i}`);
                if (input) {
                    rankThresholds[i] = parseInt(input.value) || 0;
                }
            }
            
            const startDate = document.getElementById('seasonStartDate').value;
            const endDate = document.getElementById('seasonEndDate').value;
            const seasonName = document.getElementById('seasonName').value.trim();
            
            if (!startDate || !endDate) {
                alert('Wybierz datę początku i końca sezonu!');
                return;
            }
            
            if (!validateThresholds()) {
                alert('Progi ELO muszą rosnąć dla każdej kolejnej rangi!');
                return;
            }
            
            let seasonNumber = 1;
            try {
                const seasonsSnapshot = await db.collection('seasons').get();
                let maxSeasonNumber = 0;
                
                seasonsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.seasonNumber > maxSeasonNumber) {
                        maxSeasonNumber = data.seasonNumber;
                    }
                });
                
                if (maxSeasonNumber > 0) {
                    seasonNumber = maxSeasonNumber + 1;
                }
            } catch (error) {
                console.error("Błąd pobierania numeru sezonu:", error);
            }
            
            // ARCHIWIZACJA: Przenieś stare mecze do archiwum, ZACHOWUJĄC ORYGINALNE ID
            try {
                await archiveOldMatches(seasonNumber);
            } catch (error) {
                console.error("Błąd archiwizacji, kontynuuję tworzenie sezonu:", error);
            }
            
            // RESET ELO WSZYSTKICH GRACZY DO 1500 PRZED ROZPOCZĘCIEM SEZONU
            try {
                console.log('🔄 Resetowanie ELO wszystkich graczy do 1500...');
                const playersSnapshot = await db.collection('players').get();
                const batch = db.batch();
                
                playersSnapshot.forEach(doc => {
                    batch.update(doc.ref, { elo: 1500 });
                });
                
                await batch.commit();
                console.log('✅ ELO wszystkich graczy zresetowane do 1500');
            } catch (error) {
                console.error('Błąd resetowania ELO:', error);
                alert('Błąd resetowania ELO graczy: ' + error.message);
                return;
            }
            
            const seasonData = {
                seasonNumber: seasonNumber,
                name: seasonName || `Sezon ${seasonNumber} ${new Date().getFullYear()}/${new Date().getFullYear() + 1}`,
                startDate: startDate,
                endDate: endDate,
                rankThresholds: rankThresholds,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUserRole,
                participants: players.length,
                matchesPlayed: 0
            };
            
            try {
                const seasonId = `season_${seasonNumber}`;
                
                await db.collection('seasons').doc(seasonId).set(seasonData);
                
                await db.collection('system').doc('currentSeason').set({
                    seasonId: seasonId,
                    seasonNumber: seasonNumber,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Ustaw licznik meczy dla nowego sezonu
                const seasonKey = `season${seasonNumber}_matchCounter`;
                await updateMatchCounterInSettings(seasonKey, 1);
                
                alert(`✅ Rozpoczęto nowy sezon: ${seasonData.name}\nNumer sezonu: ${seasonNumber}\nRozegrane mecze: 0\nELO wszystkich graczy zostało zresetowane do 1500.\nStare mecze zostały zarchiwizowane z zachowaniem oryginalnych nazw.`);
                
                await loadCurrentSeason();
                loadData(); // Przeładuj dane graczy
                showPage('ranks');
                
            } catch (error) {
                console.error('Błąd tworzenia sezonu:', error);
                alert('Błąd tworzenia sezonu: ' + error.message);
            }
        }
        
        // ============================================
        // POPRAWIONA FUNKCJA: ZAKOŃCZ SEZON
        // ============================================
        
        async function endSeasonDev() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostęp systemowy może zakończyć sezon!');
                return;
            }
            
            if (!currentSeason) {
                alert('Brak aktywnego sezonu do zakończenia!');
                return;
            }
            
            if (!confirm('Czy na pewno chcesz ZAKOŃCZYĆ aktualny sezon?\n\n⚠️ Ta operacja jest nieodwracalna:\n- Zresetuje ELO wszystkich graczy do 1500\n- Utworzy archiwum sezonu\n- Rozliczy osiągnięcia')) {
                return;
            }
            
            try {
                const sortedPlayers = players.sort((a, b) => b.elo - a.elo);
                const podium = sortedPlayers.slice(0, 3).map((player, index) => ({
                    name: player.name,
                    elo: player.elo,
                    achievement: getAchievementForPosition(index + 1, player.elo, currentSeason.rankThresholds)
                }));
                
                const achievements = calculateAchievements(sortedPlayers, currentSeason.rankThresholds);
                
                const seasonStart = new Date(currentSeason.startDate);
                const seasonEnd = new Date(currentSeason.endDate);
                seasonEnd.setHours(23, 59, 59, 999);
                
                const matchesQuery = await db.collection('history')
                    .where('seasonNumber', '==', currentSeason.seasonNumber)
                    .get();
                
                const matchesPlayed = matchesQuery.size;
                
                const batch = db.batch();
                const playersSnapshot = await db.collection('players').get();
                
                // RESET ELO WSZYSTKICH GRACZY DO 1500
                playersSnapshot.forEach(doc => {
                    batch.update(doc.ref, { elo: 1500 });
                });
                
                const seasonRef = db.collection('seasons').doc(currentSeason.id);
                
                const updates = {
                    status: 'ended',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: players.length,
                    podium: podium,
                    achievements: achievements,
                    finalEloStats: players.map(p => ({ name: p.name, finalElo: p.elo })),
                    matchesPlayed: matchesPlayed,
                    endedBy: 'dev',
                    endedManually: true
                };
                
                batch.update(seasonRef, updates);
                
                const currentSeasonRef = db.collection('system').doc('currentSeason');
                batch.delete(currentSeasonRef);
                
                // ARCHIWIZACJA: Przenieś mecze z tego sezonu do archiwum ZACHOWUJĄC ORYGINALNE ID
                if (matchesPlayed > 0) {
                    matchesQuery.forEach(doc => {
                        const matchData = doc.data();
                        const archivedMatch = {
                            ...matchData,
                            archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            archivedSeason: currentSeason.seasonNumber,
                            originalId: doc.id,
                            seasonId: currentSeason.id,
                            // ZACHOWUJEMY ORYGINALNY readableId
                            readableId: matchData.readableId || doc.id
                        };
                        
                        // Używamy oryginalnego readableId jako ID w archiwum
                        const archiveId = matchData.readableId || doc.id;
                        const archiveRef = db.collection('matchesArchive').doc(archiveId);
                        batch.set(archiveRef, archivedMatch);
                        
                        batch.delete(doc.ref);
                    });
                }
                
                await batch.commit();
                
                alert(`✅ Sezon został zakończony!\nELO wszystkich graczy zresetowane do 1500.\nRozegrano ${matchesPlayed} meczy (tylko z tego sezonu!).\nSezon został dodany do archiwum z zachowaniem oryginalnych nazw meczów.`);
                
                loadData();
                await loadCurrentSeason();
                await loadAllSeasons(); // Załaduj wszystkie sezony po zakończeniu
                showPage('ranks');
                
            } catch (error) {
                console.error('Błąd kończenia sezonu:', error);
                alert('Błąd kończenia sezonu: ' + error.message);
            }
        }
        
        // ============================================
        // POPRAWIONA FUNKCJA: AUTOMATYCZNE KOŃCZENIE SEZONU
        // ============================================
        
        async function endSeasonAutomatically() {
            if (!db || !currentSeason || currentSeason.status === 'ended') return;
            
            try {
                console.log("Automatyczne kończenie sezonu:", currentSeason.name);
                
                const sortedPlayers = players.sort((a, b) => b.elo - a.elo);
                const podium = sortedPlayers.slice(0, 3).map((player, index) => ({
                    name: player.name,
                    elo: player.elo,
                    achievement: getAchievementForPosition(index + 1, player.elo, currentSeason.rankThresholds)
                }));
                
                const achievements = calculateAchievements(sortedPlayers, currentSeason.rankThresholds);
                
                const seasonStart = new Date(currentSeason.startDate);
                const seasonEnd = new Date(currentSeason.endDate);
                seasonEnd.setHours(23, 59, 59, 999);
                
                const matchesQuery = await db.collection('history')
                    .where('seasonNumber', '==', currentSeason.seasonNumber)
                    .get();
                
                const matchesPlayed = matchesQuery.size;
                
                const batch = db.batch();
                const playersSnapshot = await db.collection('players').get();
                
                // RESET ELO WSZYSTKICH GRACZY DO 1500
                playersSnapshot.forEach(doc => {
                    batch.update(doc.ref, { elo: 1500 });
                });
                
                const seasonRef = db.collection('seasons').doc(currentSeason.id);
                
                const updates = {
                    status: 'ended',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: players.length,
                    podium: podium,
                    achievements: achievements,
                    finalEloStats: players.map(p => ({ name: p.name, finalElo: p.elo })),
                    matchesPlayed: matchesPlayed,
                    endedBy: 'auto',
                    endedManually: false
                };
                
                batch.update(seasonRef, updates);
                
                const currentSeasonRef = db.collection('system').doc('currentSeason');
                batch.delete(currentSeasonRef);
                
                if (matchesPlayed > 0) {
                    matchesQuery.forEach(doc => {
                        const matchData = doc.data();
                        const archivedMatch = {
                            ...matchData,
                            archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            archivedSeason: currentSeason.seasonNumber,
                            originalId: doc.id,
                            seasonId: currentSeason.id,
                            // ZACHOWUJEMY ORYGINALNY readableId
                            readableId: matchData.readableId || doc.id
                        };
                        
                        // Używamy oryginalnego readableId jako ID w archiwum
                        const archiveId = matchData.readableId || doc.id;
                        const archiveRef = db.collection('matchesArchive').doc(archiveId);
                        batch.set(archiveRef, archivedMatch);
                        
                        batch.delete(doc.ref);
                    });
                }
                
                await batch.commit();
                
                console.log(`✅ Sezon zakończony automatycznie. Rozegrano ${matchesPlayed} meczy (tylko z tego sezonu).`);
                
                loadData();
                await loadCurrentSeason();
                await loadAllSeasons(); // Załaduj wszystkie sezony
                
            } catch (error) {
                console.error("Błąd automatycznego kończenia sezonu:", error);
            }
        }
        
        // Funkcja obliczająca osiągnięcia
        function calculateAchievements(players, rankThresholds) {
            const achievements = [];
            const rank9Threshold = rankThresholds ? rankThresholds[9] : 2401;
            
            players.forEach((player, index) => {
                let achievementType = 'None';
                
                const hasRank9 = rankThresholds ? player.elo >= rank9Threshold : player.elo >= 2401;
                
                if (hasRank9) {
                    if (index === 0) {
                        achievementType = 'Top 1 of season [RANK9]';
                    } else {
                        achievementType = 'RANK9 of season';
                    }
                } else {
                    if (index === 0) {
                        achievementType = 'Top 1 of season';
                    } else if (index === 1) {
                        achievementType = 'Top 2 of season';
                    } else if (index === 2) {
                        achievementType = 'Top 3 of season';
                    }
                }
                
                if (achievementType !== 'None') {
                    achievements.push({
                        playerName: player.name,
                        playerId: player.id,
                        type: achievementType,
                        position: index + 1,
                        elo: player.elo
                    });
                }
            });
            
            return achievements;
        }
        
        // Funkcje pomocnicze
        function formatDate(date) {
            return date.toLocaleDateString('pl-PL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function showAchievements() {
            showPage('achievements');
        }
        
        function showNewSeasonForm() {
            showPage('newSeason');
        }
        
        function showPreviousSeasons() {
            showPage('seasons');
        }
        
        // Ładowanie danych sezonu
        async function loadCurrentSeason() {
            if (!db) return;
            
            try {
                const seasonDoc = await db.collection('system').doc('currentSeason').get();
                
                if (seasonDoc.exists) {
                    const currentSeasonData = seasonDoc.data();
                    const seasonId = currentSeasonData.seasonId;
                    
                    if (seasonId) {
                        const seasonDocData = await db.collection('seasons').doc(seasonId).get();
                        
                        if (seasonDocData.exists) {
                            currentSeason = seasonDocData.data();
                            currentSeason.id = seasonDocData.id;
                            
                            const now = new Date();
                            const endDate = new Date(currentSeason.endDate);
                            
                            if (now > endDate && currentSeason.status !== 'ended') {
                                await endSeasonAutomatically();
                            }
                        } else {
                            console.error("Dokument sezonu nie istnieje:", seasonId);
                            currentSeason = null;
                        }
                    } else {
                        currentSeason = null;
                    }
                } else {
                    currentSeason = null;
                }
                
                generateSeasonStatus();
                updateNewSeasonButton();
                updateEndSeasonButton();
                updateRankingTitle();
                loadHistoryBasedOnSeason(); // Załaduj odpowiednią historię
                
            } catch (error) {
                console.error("Błąd ładowania sezonu:", error);
                currentSeason = null;
            }
        }
        
        // Funkcje pomocnicze do paginacji
        function getAchievementForPosition(position, elo, rankThresholds) {
            const rank9Threshold = rankThresholds ? rankThresholds[9] : 2401;
            const hasRank9 = elo >= rank9Threshold;
            
            if (hasRank9) {
                if (position === 1) {
                    return "Top 1 of season [RANK9]";
                } else {
                    return "RANK9 of season";
                }
            } else {
                if (position === 1) {
                    return "Top 1 of season";
                } else if (position === 2) {
                    return "Top 2 of season";
                } else if (position === 3) {
                    return "Top 3 of season";
                }
            }
            return "None";
        }
        
        // Inicjalizacja
        function getDeviceId() {
            const deviceInfo = navigator.userAgent + navigator.platform + navigator.language;
            let hash = 0;
            for (let i = 0; i < deviceInfo.length; i++) {
                const char = deviceInfo.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'device_' + Math.abs(hash).toString(16);
        }
        
        // Główna inicjalizacja aplikacji
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Strona załadowana, inicjalizuję Firebase...');
            
            const firebaseInstance = initializeFirebase();
            
            if (firebaseInstance) {
                db = firebaseInstance.db;
                auth = firebaseInstance.auth;
                
                loadData();
                await loadCurrentSeason();
                await loadAllSeasons();
                
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                updateRankingTitle();
                
            } else {
                console.log('Tryb offline - pokazuję dane demo');
                
                players = [
                    { id: '1', name: 'Jan Kowalski', elo: 2450, code: '12345' },
                    { id: '2', name: 'Anna Nowak', elo: 2200, code: '23456' },
                    { id: '3', name: 'Piotr Wiśniewski', elo: 2100, code: '34567' },
                    { id: '4', name: 'Katarzyna Wójcik', elo: 1950, code: '45678' },
                    { id: '5', name: 'Michał Kowalczyk', elo: 1800, code: '56789' },
                    { id: '6', name: 'Agnieszka Kamińska', elo: 1650, code: '67890' },
                    { id: '7', name: 'Tomasz Lewandowski', elo: 1500, code: '78901' },
                    { id: '8', name: 'Magdalena Zielińska', elo: 1350, code: '89012' },
                    { id: '9', name: 'Krzysztof Szymański', elo: 1200, code: '90123' },
                    { id: '10', name: 'Ewa Woźniak', elo: 1100, code: '01234' }
                ];
                
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                updateRankingTitle();
            }
            
            setTimeout(() => {
                const selectPlayerA = document.getElementById('selectPlayerA');
                const selectPlayerB = document.getElementById('selectPlayerB');
                
                if (selectPlayerA) {
                    selectPlayerA.addEventListener('change', onPlayerSelectChange);
                }
                
                if (selectPlayerB) {
                    selectPlayerB.addEventListener('change', onPlayerSelectChange);
                }
                
                const adminPasswordInput = document.getElementById('adminPassword');
                if (adminPasswordInput) {
                    adminPasswordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            login();
                        }
                    });
                }
                
                document.addEventListener('keydown', function(event) {
                    const modal = document.getElementById('codeModal');
                    if (event.key === 'Escape' && modal && modal.classList.contains('active')) {
                        closeCodeModal();
                    }
                    
                    const pageModal = document.getElementById('pageSelectorModal');
                    if (event.key === 'Escape' && pageModal && pageModal.classList.contains('active')) {
                        closePageSelectorModal();
                    }
                });
                
                const modalOverlay = document.getElementById('codeModal');
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', function(event) {
                        if (event.target === this) {
                            closeCodeModal();
                        }
                    });
                }
                
                const pageModalOverlay = document.getElementById('pageSelectorModal');
                if (pageModalOverlay) {
                    pageModalOverlay.addEventListener('click', function(event) {
                        if (event.target === this) {
                            closePageSelectorModal();
                        }
                    });
                }
                
                const dartInputs = ['dart1', 'dart2', 'dart3'];
                dartInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', calculateTurnTotal);
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                const currentIndex = dartInputs.indexOf(id);
                                if (currentIndex < 2) {
                                    document.getElementById(dartInputs[currentIndex + 1]).focus();
                                } else {
                                    submitDarts();
                                }
                            }
                        });
                    }
                });
                
                generateRandomCode();
                generateRandomCodeDev();
                
                generateRanksPage();
                generateAchievementsPage();
                generateSeasonStatus();
                
            }, 500);
            
            console.log('✅ Aplikacja gotowa do użycia!');
            showPage('elo');
        });
    </script>
</body>
</html>