<!DOCTYPE html>
<html>
<head>
    <title>Kalkulator ELO Dart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { margin: 0; padding: 0; background: #1a1a1a; color: white; }
        
        /* MENU NAWIGACYJNE - RESPONSYWNE */
        .nav-menu {
            display: flex;
            background: #2d2d2d;
            padding: 0;
            border-bottom: 2px solid #4CAF50;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
        }
        .nav-btn {
            flex: 1 0 auto;
            min-width: 120px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        @media (max-width: 480px) {
            .nav-btn {
                min-width: 90px;
                padding: 10px 5px;
                font-size: 12px;
            }
            .nav-btn span {
                font-size: 10px;
            }
        }
        @media (max-width: 360px) {
            .nav-btn {
                min-width: 80px;
                padding: 8px 4px;
                font-size: 11px;
            }
        }
        .nav-btn:hover {
            background: #3a3a3a;
            color: white;
        }
        .nav-btn.active {
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
            font-weight: bold;
            background: #333;
        }
        .nav-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .nav-btn.disabled:hover {
            background: transparent;
            color: #aaa;
        }
        .nav-icon {
            font-size: 18px;
        }
        @media (max-width: 480px) {
            .nav-icon {
                font-size: 16px;
            }
        }
        
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 15px; 
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
        }
        
        h1 { 
            text-align: center; 
            color: #4CAF50; 
            margin-bottom: 20px; 
            margin-top: 10px; 
            font-size: 22px;
        }
        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
                margin-bottom: 15px;
            }
        }
        
        /* ===== STYLE Z PIERWSZEGO KODU ===== */
        .player-box { 
            background: #2d2d2d; 
            padding: 12px; 
            margin: 12px 0; 
            border-radius: 8px; 
        }
        @media (max-width: 480px) {
            .player-box {
                padding: 10px;
                margin: 10px 0;
            }
        }
        
        .input-group { margin-bottom: 8px; }
        label { display: block; margin-bottom: 4px; color: #aaa; font-size: 14px; }
        input { 
            width: 100%; 
            padding: 10px; 
            font-size: 16px; 
            border: 1px solid #444; 
            background: #333; 
            color: white; 
            border-radius: 5px; 
        }
        @media (max-width: 480px) {
            input {
                padding: 8px;
                font-size: 15px;
            }
        }
        
        .elo-display { font-size: 22px; font-weight: bold; margin: 8px 0; }
        @media (max-width: 480px) {
            .elo-display {
                font-size: 20px;
            }
        }
        
        .chance { 
            text-align: center; 
            font-size: 16px; 
            margin: 15px 0; 
            color: #BB86FC; 
            padding: 8px;
            background: rgba(187, 134, 252, 0.1);
            border-radius: 5px;
        }
        @media (max-width: 480px) {
            .chance {
                font-size: 15px;
                margin: 12px 0;
                padding: 6px;
            }
        }
        
        .buttons { 
            display: flex; 
            gap: 8px; 
            margin: 15px 0; 
            flex-wrap: wrap;
        }
        @media (max-width: 480px) {
            .buttons {
                gap: 6px;
                margin: 12px 0;
            }
        }
        
        button { 
            flex: 1; 
            padding: 12px; 
            font-size: 14px; 
            border: none; 
            border-radius: 5px; 
            color: white; 
            cursor: pointer; 
            min-width: 100px;
        }
        @media (max-width: 480px) {
            button {
                padding: 10px 8px;
                font-size: 13px;
                min-width: 0;
            }
        }
        
        .btn-win1 { background: #4CAF50; }
        .btn-win2 { background: #F44336; }
        .btn-draw { background: #FF9800; }
        .btn-add { background: #9C27B0; }
        .btn-login { background: #2196F3; }
        .btn-logout { background: #f44336; }
        .btn-dev { background: #FFFFFF; color: #1a1a1a; }
        .btn-toggle { background: #607D8B; }
        
        .history { 
            margin-top: 25px; 
            background: #2d2d2d; 
            padding: 12px; 
            border-radius: 8px; 
        }
        .players-list { margin-top: 15px; }
        .player-item { 
            background: #333; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .player-item:nth-child(odd) { background: #3a3a3a; }
        
        /* PRZYCISKI USUWANIA */
        .delete-btn { 
            background: #f44336; 
            color: white; 
            border: none; 
            width: 30px; 
            height: 30px; 
            min-width: 30px;
            min-height: 30px;
            border-radius: 5px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 14px;
            padding: 0;
            flex-shrink: 0;
        }
        @media (max-width: 480px) {
            .delete-btn, .lock-btn {
                width: 28px;
                height: 28px;
                min-width: 28px;
                min-height: 28px;
                font-size: 13px;
            }
        }
        
        .lock-btn { 
            background: #FF9800; 
            color: white; 
            border: none; 
            width: 30px; 
            height: 30px; 
            min-width: 30px;
            min-height: 30px;
            border-radius: 5px; 
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            padding: 0;
            flex-shrink: 0;
        }
        
        select { 
            width: 100%; 
            padding: 10px; 
            background: #333; 
            color: white; 
            border: 1px solid #444; 
            border-radius: 5px; 
            font-size: 15px;
        }
        @media (max-width: 480px) {
            select {
                padding: 8px;
                font-size: 14px;
            }
        }
        
        .login-box { 
            background: #2d2d2d; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            text-align: center; 
        }
        .admin-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #FF9800; 
        }
        .user-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #2196F3; 
        }
        .dev-panel { 
            background: #1a1a1a; 
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 2px solid #FFFFFF; 
        }
        .hidden { display: none; }
        .role-badge { 
            display: inline-block; 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: bold; 
            margin-left: 8px; 
        }
        @media (max-width: 480px) {
            .role-badge {
                font-size: 10px;
                padding: 2px 6px;
                margin-left: 6px;
            }
        }
        
        .admin-badge { background: #FF9800; color: black; }
        .user-badge { background: #2196F3; color: white; }
        .dev-badge { background: #FFFFFF; color: #1a1a1a; border: 1px solid #ccc; }
        .swap-btn { 
            background: transparent; 
            border: none; 
            color: #BB86FC; 
            cursor: pointer; 
            font-size: 22px; 
            padding: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 480px) {
            .swap-btn {
                font-size: 20px;
                padding: 0 6px;
            }
        }
        
        .swap-btn:hover { color: #ffffff; }
        .swap-btn:disabled { 
            color: #666; 
            cursor: not-allowed; 
        }
        .player-select-row {
            display: flex; 
            gap: 5px; 
            margin-bottom: 10px;
            align-items: center;
        }
        
        /* STRONY */
        .page { display: none; }
        .page.active { display: block; }
        
        /* MODAL DO WERYFIKACJI KODU - POPRAWIONY */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            border: 2px solid #4CAF50;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        
        .close-modal {
            background: #f44336;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .close-modal:hover {
            background: #d32f2f;
        }
        
        .code-input {
            letter-spacing: 8px;
            font-size: 24px;
            text-align: center;
            font-family: monospace;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .player-name-highlight {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
            margin: 10px 0;
            text-align: center;
            padding: 8px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
        }
        
        /* STRONA GRY - NOWE STYLE */
        .games-page {
            padding: 15px;
        }
        
        .game-modes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .game-mode-card {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .game-mode-card:hover {
            border-color: #4CAF50;
            transform: translateY(-5px);
            background: #333;
        }
        
        .game-mode-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .game-mode-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #4CAF50;
        }
        
        .game-mode-description {
            font-size: 13px;
            color: #aaa;
        }
        
        /* Strona wyboru graczy do gry */
        .game-setup-page {
            padding: 15px;
        }
        
        /* Strona samej gry 501 */
        .game-501-page {
            padding: 15px;
        }
        
        .game-header {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .players-scoreboard {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .players-scoreboard {
                flex-direction: column;
            }
        }
        
        .player-score {
            flex: 1;
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 3px solid #444;
            transition: all 0.3s;
        }
        
        .player-score.active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .player-score.winner {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .player-name-large {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        .player-score.active .player-name-large {
            color: #FFFFFF;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .current-score {
            font-size: 60px;
            font-weight: bold;
            margin: 15px 0;
            color: #BB86FC;
        }
        
        .legs-info {
            font-size: 16px;
            color: #aaa;
            margin-top: 10px;
        }
        
        .dart-input-section {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .dart-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .dart-input-group {
            flex: 1;
            min-width: 150px;
        }
        
        .dart-input-label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 14px;
        }
        
        .dart-points-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            text-align: center;
            background: #333;
            border: 2px solid #444;
            color: white;
            border-radius: 8px;
        }
        
        .dart-points-input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .dart-multiplier {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .multiplier-btn {
            flex: 1;
            padding: 10px;
            background: #333;
            border: 2px solid #444;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .multiplier-btn:hover {
            background: #444;
        }
        
        .multiplier-btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        
        .current-turn-info {
            text-align: center;
            padding: 15px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .game-action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-submit-darts {
            flex: 2;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-submit-darts:hover {
            background: #3d8b40;
        }
        
        .btn-submit-darts:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .btn-undo {
            flex: 1;
            background: #FF9800;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .btn-undo:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .turn-history {
            margin-top: 30px;
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
        }
        
        .turn-history h3 {
            margin-top: 0;
            color: #BB86FC;
        }
        
        .turn-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #444;
            font-size: 14px;
        }
        
        .turn-item:last-child {
            border-bottom: none;
        }
        
        .dart-score {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(187, 134, 252, 0.2);
            margin-right: 5px;
        }
        
        /* Strona wynik√≥w gry */
        .game-results-page {
            padding: 15px;
            text-align: center;
        }
        
        .results-container {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 30px;
            margin: 20px auto;
            max-width: 600px;
        }
        
        .winner-celebration {
            font-size: 32px;
            color: #FFD700;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .stats-table th, .stats-table td {
            padding: 12px;
            border-bottom: 1px solid #444;
            text-align: center;
        }
        
        .stats-table th {
            background: #333;
            color: #4CAF50;
        }
        
        .stats-table tr:hover {
            background: #3a3a3a;
        }
        
        .elo-options {
            margin-top: 30px;
            background: rgba(76, 175, 80, 0.1);
            padding: 20px;
            border-radius: 10px;
        }
        
        /* STRONA INFO */
        .info-page {
            padding: 15px;
        }
        
        .info-box {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        @media (max-width: 480px) {
            .info-box {
                padding: 12px;
                font-size: 13px;
            }
        }
        
        .coming-soon {
            text-align: center;
            font-size: 22px;
            color: #BB86FC;
            margin-top: 40px;
            padding: 20px;
        }
        @media (max-width: 480px) {
            .coming-soon {
                font-size: 20px;
                margin-top: 30px;
                padding: 15px;
            }
        }
        
        /* MOBILE OPTIMIZATION */
        .mobile-only { display: none; }
        .desktop-only { display: block; }
        
        @media (max-width: 480px) {
            .mobile-only { display: block; }
            .desktop-only { display: none; }
        }
        
        /* Lepsze zarzƒÖdzanie tekstem na ma≈Çych ekranach */
        .player-name-truncate {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        @media (max-width: 480px) {
            .player-name-truncate {
                max-width: 120px;
            }
        }
        @media (max-width: 360px) {
            .player-name-truncate {
                max-width: 100px;
            }
        }
        
        /* KOD W LISCIE GRACZY */
        .player-code {
            background: rgba(76, 175, 80, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #4CAF50;
        }
        
        /* ADMIN PANEL IMPROVEMENTS */
        .admin-input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .admin-input-group {
            flex: 1;
        }
        
        .generate-code-btn {
            background: #607D8B;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            height: 42px;
            min-width: 80px;
        }
        
        .generate-code-btn:hover {
            background: #546E7A;
        }
        
        /* DEV PANEL STYLES */
        .role-toggle-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .role-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-enabled {
            background: #4CAF50;
            color: white;
        }
        
        .status-disabled {
            background: #f44336;
            color: white;
        }
        
        .dev-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        
        .password-input {
            flex: 2;
        }
        
        .toggle-btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* ===== NOWE STYLE DLA STRONY RANG I SEZON√ìW ===== */
        .ranks-page {
            padding: 15px;
        }
        
        /* Status sezonu na g√≥rze */
        .season-status {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #4CAF50;
        }
        
        .season-status.off-season {
            border-color: #666;
        }
        
        .season-status.running {
            border-color: #4CAF50;
        }
        
        .season-status.ended {
            border-color: #FF9800;
        }
        
        .season-name {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        
        .season-dates {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .season-days-left {
            font-size: 13px;
            color: #FF9800;
            font-weight: bold;
        }
        
        /* Kontener rangi */
        .rank-container {
            background: #2d2d2d;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            border-left: 5px solid #4CAF50;
            transition: all 0.3s ease;
        }
        
        /* SPECJALNE KOLORY DLA RANG 1 I 9 */
        .rank-1 {
            border-left-color: #2196F3 !important; /* Niebieski dla rangi 1 */
        }
        
        .rank-1 .rank-number {
            background: #2196F3 !important;
        }
        
        .rank-1 .rank-name {
            color: #2196F3 !important;
        }
        
        .rank-9 {
            border-left-color: #F44336 !important; /* CZERWONY dla rangi 9 */
        }
        
        .rank-9 .rank-number {
            background: #F44336 !important;
        }
        
        .rank-9 .rank-name {
            color: #F44336 !important;
        }
        
        .rank-container:hover {
            background: #333;
            transform: translateX(5px);
        }
        
        /* Numer rangi */
        .rank-number {
            width: 40px;
            height: 40px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin-right: 15px;
        }
        
        /* Kontener obrazka */
        .rank-image-container {
            width: 80px;
            height: 80px;
            background: #1a1a1a;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 15px;
            border: 2px solid #444;
            overflow: hidden;
        }
        
        @media (max-width: 480px) {
            .rank-image-container {
                width: 60px;
                height: 60px;
                margin-right: 10px;
            }
        }
        
        /* Obrazek - placeholder */
        .rank-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Informacje o randze */
        .rank-info {
            flex: 1;
            min-width: 200px;
        }
        
        .rank-name {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        
        .rank-elo {
            font-size: 14px;
            color: #aaa;
        }
        
        /* Lista graczy na randze */
        .rank-players {
            flex: 2;
            min-width: 250px;
            margin-left: 30px;
        }
        
        @media (max-width: 768px) {
            .rank-container {
                flex-wrap: wrap;
            }
            .rank-players {
                margin-left: 0;
                margin-top: 15px;
                width: 100%;
            }
        }
        
        .players-on-rank {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .player-on-rank {
            background: #3a3a3a;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid #444;
        }
        
        .player-on-rank-elo {
            color: #4CAF50;
            font-weight: bold;
            font-size: 12px;
            background: rgba(76, 175, 80, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .no-players {
            color: #777;
            font-style: italic;
            font-size: 14px;
        }
        
        /* Przyciski na dole strony rang */
        .ranks-footer {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }
        
        .ranks-footer-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        @media (max-width: 480px) {
            .ranks-footer-buttons {
                flex-direction: column;
            }
            .ranks-footer-btn {
                width: 100%;
            }
        }
        
        .ranks-footer-btn {
            padding: 12px 25px;
            background: #2d2d2d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .ranks-footer-btn:hover {
            background: #3a3a3a;
            border-color: #4CAF50;
        }
        
        .admin-season-btn {
            background: #9C27B0 !important;
            margin-top: 10px;
        }
        
        .admin-season-btn:hover {
            border-color: #9C27B0 !important;
        }
        
        .admin-season-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666 !important;
        }
        
        .admin-season-btn.disabled:hover {
            border-color: transparent !important;
            background: #666 !important;
        }
        
        .dev-end-season-btn {
            background: #F44336 !important;
            margin-top: 10px;
        }
        
        .dev-end-season-btn:hover {
            border-color: #F44336 !important;
        }
        
        /* Strona osiƒÖgniƒôƒá - ZMIENIONE: osiƒÖgniƒôcia obok zdjƒôƒá */
        .achievements-page, .seasons-page, .new-season-page {
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .achievement-container, .season-container, .new-season-form {
            background: #2d2d2d;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
        }
        
        .achievement-container {
            border-left: 5px solid #FF9800;
        }
        
        .season-container {
            border-left: 5px solid #2196F3;
        }
        
        .new-season-form {
            border-left: 5px solid #9C27B0;
            display: block; /* ZMIENIONE: z powrotem na block */
        }
        
        .achievement-image-container {
            width: 70px;
            height: 70px;
            background: #1a1a1a;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 20px; /* ZWIƒòKSZONA PRZESTRZE≈É MIƒòDZY ZDJƒòCIEM A NAZWƒÑ */
            border: 2px solid #444;
            overflow: hidden;
        }
        
        @media (max-width: 480px) {
            .achievement-image-container {
                width: 50px;
                height: 50px;
                margin-right: 15px; /* ZACHOWUJEMY WIƒòKSZƒÑ PRZESTRZE≈É NA MOBILNYCH */
            }
        }
        
        /* NOWE: Kontener dla nazwy i opisu osiƒÖgniƒôcia */
        .achievement-text-container {
            flex: 1;
            min-width: 0; /* Pozwala na responsywno≈õƒá */
        }
        
        .achievement-name, .season-name-in-list {
            font-size: 16px;
            font-weight: bold;
            color: #FF9800;
            margin-bottom: 5px;
        }
        
        .season-name-in-list {
            color: #2196F3;
            font-size: 18px;
        }
        
        .achievement-description, .season-details {
            font-size: 14px;
            color: #aaa;
            line-height: 1.4;
        }
        
        .season-podium {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            width: 100%;
        }
        
        .podium-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 5px;
        }
        
        .podium-place {
            width: 30px;
            height: 30px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .podium-place-1 {
            background: #FFD700 !important;
            color: #000;
        }
        
        .podium-place-2 {
            background: #C0C0C0 !important;
        }
        
        .podium-place-3 {
            background: #CD7F32 !important;
        }
        
        .back-to-ranks-btn {
            display: block;
            margin: 30px auto 0 auto;
            padding: 12px 30px;
            background: #2d2d2d;
            color: white;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
            text-align: center;
        }
        
        .back-to-ranks-btn:hover {
            background: #4CAF50;
        }
        
        /* Formularz nowego sezonu - POPRAWIAMY UK≈ÅAD */
        .elo-thresholds {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .elo-threshold-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
        }
        
        .date-inputs {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (max-width: 480px) {
            .date-inputs {
                flex-direction: column;
            }
        }
        
        .season-action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-submit {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        
        /* Strona wyboru rozpoczƒôcia gry */
        .start-game-page {
            padding: 15px;
        }
        
        .start-game-info {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .selected-players-display {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (max-width: 480px) {
            .selected-players-display {
                flex-direction: column;
            }
        }
        
        .selected-player-card {
            flex: 1;
            background: #3a3a3a;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .start-game-options {
            margin-top: 30px;
        }
        
        .start-option {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            border: 2px solid #444;
            transition: all 0.3s;
        }
        
        .start-option:hover {
            border-color: #4CAF50;
        }
        
        .start-option.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .start-option-title {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- MENU NAWIGACYJNE - ZOPTYMALIZOWANE DLA TELEFONU -->
    <div class="nav-menu">
        <button class="nav-btn active" onclick="showPage('elo')">
            <span class="nav-icon">üéØ</span>
            <span>Kalkulator Elo</span>
        </button>
        <button class="nav-btn" id="gamesBtn" onclick="showPage('games')">
            <span class="nav-icon">üéÆ</span>
            <span>Gry</span>
        </button>
        <button class="nav-btn" onclick="showPage('ranks')">
            <span class="nav-icon">‚≠ê</span>
            <span>Rangi</span>
        </button>
        <button class="nav-btn" onclick="showPage('info')">
            <span class="nav-icon">‚ÑπÔ∏è</span>
            <span>Info</span>
        </button>
    </div>

    <!-- MODAL DO WERYFIKACJI KODU - POPRAWIONY -->
    <div id="codeModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0; color: #4CAF50;">üîí WERYFIKACJI KODU</h3>
                <button class="close-modal" onclick="closeCodeModal()">‚úï</button>
            </div>
            
            <div id="modalMessage" style="text-align: center; margin-bottom: 15px;">
                <p>Wprowad≈∫ 5-cyfrowy kod weryfikacyjny dla wybranego gracza</p>
            </div>
            
            <div class="player-name-highlight" id="modalPlayerName">
                <!-- Tu pojawi siƒô nazwa gracza -->
            </div>
            
            <div class="input-group">
                <label style="text-align: center;">5-cyfrowy kod:</label>
                <input type="text" 
                       id="codeInput" 
                       class="code-input" 
                       maxlength="5" 
                       placeholder="00000"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5)">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-logout" onclick="closeCodeModal()" style="flex: 1;">ANULUJ</button>
                <button class="btn-win1" onclick="submitCode()" style="flex: 2;">ZATWIERD≈π KOD</button>
            </div>
            
            <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #aaa;">
                Naci≈õnij ESC lub kliknij poza modal aby zamknƒÖƒá
            </div>
        </div>
    </div>

    <!-- STRONA KALKULATORA ELO -->
    <div class="container page active" id="eloPage">
        <h1>üéØ KALKULATOR ELO DART</h1>
        
        <!-- Panel logowania -->
        <div class="login-box" id="loginBox">
            <h3>ZALOGUJ SIƒò</h3>
            <p style="font-size: 14px; color: #aaa;">Dane synchronizowane w chmurze Firebase</p>
            <div class="input-group">
                <input type="password" id="adminPassword" placeholder="Wprowad≈∫ has≈Ço...">
            </div>
            <button class="btn-login" onclick="login()">ZALOGUJ</button>
            <div style="margin-top: 10px; font-size: 12px; color: #aaa;">
                <span class="desktop-only">Bez logowania: tylko przeglƒÖdanie<br>
                Z logowaniem: dostƒôp do pe≈Çnych funkcji</span>
                <span class="mobile-only">Go≈õƒá: przeglƒÖdanie<br>
                Zalogowany: pe≈Çny dostƒôp</span>
            </div>
        </div>
        
        <!-- Admin Panel (ukryty domy≈õlnie) -->
        <div class="admin-panel hidden" id="adminPanel">
            <h3 style="margin-top: 0;">üëë KONTO PREMIUM <span class="role-badge admin-badge">PREMIUM</span></h3>
            
            <div class="input-group">
                <label>Imiƒô nowego gracza:</label>
                <input type="text" id="newPlayerName" placeholder="np. Jan Kowalski">
            </div>
            
            <div class="input-group">
                <label>PoczƒÖtkowe ELO:</label>
                <input type="number" id="newPlayerElo" value="1500" placeholder="1500">
            </div>
            
            <div class="admin-input-row">
                <div class="admin-input-group">
                    <label>5-cyfrowy kod weryfikacyjny:</label>
                    <input type="text" 
                           id="newPlayerCode" 
                           maxlength="5" 
                           placeholder="12345"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5)">
                </div>
                <button onclick="generateRandomCode()" class="generate-code-btn">
                    Losuj
                </button>
            </div>
            
            <small style="color: #aaa; font-size: 12px; display: block; margin-top: 5px;">
                Mo≈ºesz wpisaƒá w≈Çasny kod lub u≈ºyƒá przycisku "Losuj". Kody mogƒÖ siƒô powtarzaƒá.
            </small>
            
            <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button class="btn-add" onclick="addNewPlayer()" style="flex: 2;">‚ûï DODAJ GRACZA</button>
                <button class="btn-logout" onclick="logout()" style="flex: 1;">WYLOGUJ</button>
            </div>
        </div>
        
        <!-- User Panel (ukryty domy≈õlnie) -->
        <div class="user-panel hidden" id="userPanel">
            <h3 style="margin-top: 0;">üë§ KONTO U≈ªYTKOWNIKA <span class="role-badge user-badge">USER</span></h3>
            <button class="btn-logout" onclick="logout()" style="width: 100%;">WYLOGUJ</button>
        </div>
        
        <!-- Dev Panel (ukryty domy≈õlnie) -->
        <div class="dev-panel hidden" id="devPanel">
            <h3 style="margin-top: 0;">‚öôÔ∏è PANEL SYSTEMOWY <span class="role-badge dev-badge">SYSTEM</span></h3>
            
            <!-- Status rang -->
            <div class="role-toggle-section">
                <h4 style="margin-top: 0; color: #FFFFFF;">üéÆ ZARZƒÑDZANIE DOSTƒòPAMI</h4>
                
                <div style="margin-bottom: 15px;">
                    <strong>Dostƒôp Premium:</strong> 
                    <span id="adminStatus" class="role-status status-disabled">WY≈ÅƒÑCZONY</span>
                    <div class="dev-controls">
                        <input type="password" 
                               id="adminPasswordInput" 
                               class="password-input" 
                               placeholder="Ustaw has≈Ço dla dostƒôpu Premium...">
                        <button class="btn-toggle toggle-btn" onclick="toggleAdminRole()">
                            W≈ÅƒÑCZ
                        </button>
                    </div>
                    <small style="color: #aaa; display: block; margin-top: 5px;">
                        Aktualne has≈Ço: <span id="currentAdminPassword">brak</span>
                    </small>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Dostƒôp U≈ºytkownika:</strong> 
                    <span id="userStatus" class="role-status status-disabled">WY≈ÅƒÑCZONY</span>
                    <div class="dev-controls">
                        <input type="password" 
                               id="userPasswordInput" 
                               class="password-input" 
                               placeholder="Ustaw has≈Ço dla dostƒôpu U≈ºytkownika...">
                        <button class="btn-toggle toggle-btn" onclick="toggleUserRole()">
                            W≈ÅƒÑCZ
                        </button>
                    </div>
                    <small style="color: #aaa; display: block; margin-top: 5px;">
                        Aktualne has≈Ço: <span id="currentUserPassword">brak</span>
                    </small>
                </div>
                
                <div style="font-size: 12px; color: #aaa; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                    <strong>‚ö†Ô∏è Uwaga:</strong> Gdy dostƒôp jest wy≈ÇƒÖczony, nikt nie mo≈ºe siƒô na niego zalogowaƒá.<br>
                    PrzeglƒÖdanie bez logowania jest zawsze dostƒôpne.
                </div>
            </div>
            
            <!-- Dodawanie graczy -->
            <div style="margin-top: 20px;">
                <h4 style="margin-top: 0; color: #FFFFFF;">‚ûï DODAWANIE GRACZY</h4>
                
                <div class="input-group">
                    <label>Imiƒô nowego gracza:</label>
                    <input type="text" id="devNewPlayerName" placeholder="np. Jan Kowalski">
                </div>
                
                <div class="input-group">
                    <label>PoczƒÖtkowe ELO:</label>
                    <input type="number" id="devNewPlayerElo" value="1500" placeholder="1500">
                </div>
                
                <div class="admin-input-row">
                    <div class="admin-input-group">
                        <label>5-cyfrowy kod weryfikacyjny:</label>
                        <input type="text" 
                               id="devNewPlayerCode" 
                               maxlength="5" 
                               placeholder="12345"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5)">
                    </div>
                    <button onclick="generateRandomCodeDev()" class="generate-code-btn">
                        Losuj
                    </button>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 15px;">
                    <button class="btn-add" onclick="addNewPlayerDev()" style="flex: 2;">‚ûï DODAJ GRACZA</button>
                    <button class="btn-logout" onclick="logout()" style="flex: 1;">WYLOGUJ</button>
                </div>
            </div>
            
            <!-- DIAGNOSTYKA -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,0,0,0.1); border-radius: 8px; border: 1px solid #f44336;">
                <h4 style="margin-top: 0; color: #f44336;">üõ†Ô∏è DIAGNOSTYKA</h4>
                <button onclick="debugSeasons()" style="background: #f44336; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; width: 100%;">
                    üîç Sprawd≈∫ sezony w Firebase
                </button>
                <small style="color: #aaa; display: block; margin-top: 5px;">
                    Sprawd≈∫ co jest zapisane w bazie danych (otw√≥rz konsolƒô F12)
                </small>
            </div>
        </div>
        
        <!-- Wyb√≥r graczy do meczu -->
        <div class="player-box">
            <h3 style="margin-top: 0;">WYBIERZ GRACZY DO MECZU</h3>
            
            <div class="player-select-row">
                <div style="flex: 1;">
                    <label>Gracz A:</label>
                    <select id="selectPlayerA">
                        <option value="">Wybierz gracza</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: center; min-height: 60px;">
                    <button class="swap-btn" onclick="swapPlayers()" id="swapBtn" title="Zamie≈Ñ graczy miejscami">
                        üîÑ
                    </button>
                </div>
                
                <div style="flex: 1;">
                    <label>Gracz B:</label>
                    <select id="selectPlayerB">
                        <option value="">Wybierz gracza</option>
                    </select>
                </div>
            </div>
            
            <div class="chance" id="chance">Wybierz graczy aby zobaczyƒá szanse</div>
            
            <div class="buttons">
                <button class="btn-win1" onclick="playerAWins()" id="btnA">GRACZ A wygrywa</button>
                <button class="btn-draw" onclick="draw()" id="btnDraw">REMIS</button>
                <button class="btn-win2" onclick="playerBWins()" id="btnB">GRACZ B wygrywa</button>
            </div>
            
            <div style="text-align: center; margin-top: 10px; color: #aaa; font-size: 12px;">
                ‚ö†Ô∏è Po klikniƒôciu przycisku bƒôdzie wymagane podanie kodu weryfikacyjnego dla obu graczy
            </div>
        </div>
        
        <!-- Lista wszystkich graczy (ZMIENIONA NAZWA) -->
        <div class="players-list">
            <h3 style="margin-top: 0;">üèÜ SEZONOWY RANKING GRACZY</h3>
            <div id="allPlayersList">≈Åadowanie z chmury...</div>
        </div>
        
        <!-- Historia zmian -->
        <div class="history">
            <h3 style="margin-top: 0;">üìú OSTATNIE MECZE</h3>
            <div id="historyList">-</div>
        </div>
        
        <!-- Info o synchronizacji -->
        <div style="text-align: center; margin-top: 20px; color: #777; font-size: 11px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
            <span class="desktop-only">
                üîÑ Synchronizacja z Firebase | üíæ Auto-zapis | üë• Wielu u≈ºytkownik√≥w | ‚òÅÔ∏è Chmura
            </span>
            <span class="mobile-only">
                üîÑ Synchronizacja | üíæ Auto-zapis | ‚òÅÔ∏è Chmura
            </span>
        </div>
    </div>

    <!-- STRONA G≈Å√ìWNA GIER -->
    <div class="container page" id="gamesPage">
        <div class="games-page">
            <h1>üéÆ GRY I TURNIEJE</h1>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <p style="color: #aaa; font-size: 16px;">Wybierz tryb gry</p>
            </div>
            
            <div class="game-modes">
                <div class="game-mode-card" onclick="selectGameMode('501')">
                    <div class="game-mode-icon">üéØ</div>
                    <div class="game-mode-title">501 to 0</div>
                    <div class="game-mode-description">
                        Klasyczny darter. Rozpocznij z 501 punktami i zredukuj do zera.
                        Wygrywa ten, kto pierwszy wyrzuci dok≈Çadnie 0.
                    </div>
                </div>
                
                <div class="game-mode-card" onclick="showComingSoon()">
                    <div class="game-mode-icon">‚öîÔ∏è</div>
                    <div class="game-mode-title">Cricket</div>
                    <div class="game-mode-description">
                        (Wkr√≥tce) Popularna gra w krykieta darta. Zamknij wszystkie numery 15-20 i bullseye.
                    </div>
                </div>
                
                <div class="game-mode-card" onclick="showComingSoon()">
                    <div class="game-mode-icon">üèÜ</div>
                    <div class="game-mode-title">Around the Clock</div>
                    <div class="game-mode-description">
                        (Wkr√≥tce) Rzuƒá w ka≈ºdy sektor od 1 do 20. Wygrywa ten, kto pierwszy uko≈Ñczy rundƒô.
                    </div>
                </div>
                
                <div class="game-mode-card" onclick="showComingSoon()">
                    <div class="game-mode-icon">üé≤</div>
                    <div class="game-mode-title">Random Practice</div>
                    <div class="game-mode-title">(Wkr√≥tce)</div>
                    <div class="game-mode-description">
                        Losowe wyzwania do treningu. Doskonal swoje umiejƒôtno≈õci.
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="back-to-ranks-btn" onclick="showPage('elo')">
                    ‚Üê Powr√≥t do Kalkulatora
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA WYBORU GRACZY DO GRY -->
    <div class="container page" id="gameSetupPage">
        <div class="game-setup-page">
            <h1>üéØ 501 TO 0 - WYB√ìR GRACZY</h1>
            
            <div class="start-game-info">
                <h3>Wybierz dw√≥ch graczy do rozgrywki</h3>
                <p style="color: #aaa; font-size: 14px;">Gra polega na redukcji punkt√≥w z 501 do 0. Wygrywa gracz, kt√≥ry pierwszy osiƒÖgnie dok≈Çadnie 0 punkt√≥w.</p>
            </div>
            
            <div class="player-box">
                <h3 style="margin-top: 0;">WYBIERZ GRACZY DO ROZGRYWKI</h3>
                
                <div class="player-select-row">
                    <div style="flex: 1;">
                        <label>Gracz 1 (Bƒôdzie zaczyna≈Ç):</label>
                        <select id="gameSelectPlayer1">
                            <option value="">Wybierz gracza</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 60px;">
                        <button class="swap-btn" onclick="swapGamePlayers()" id="gameSwapBtn" title="Zamie≈Ñ graczy miejscami">
                            üîÑ
                        </button>
                    </div>
                    
                    <div style="flex: 1;">
                        <label>Gracz 2:</label>
                        <select id="gameSelectPlayer2">
                            <option value="">Wybierz gracza</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn-win1" onclick="start501Game()" id="startGameBtn" style="padding: 15px 30px; font-size: 16px;">
                        ROZPOCZNIJ GRƒò
                    </button>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-to-ranks-btn" onclick="showPage('games')">
                    ‚Üê Wr√≥ƒá do wyboru gry
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA GRY 501 -->
    <div class="container page" id="game501Page">
        <div class="game-501-page">
            <div class="game-header">
                <h1>üéØ 501 TO 0</h1>
                <div id="gameInfo">Rozgrywka: Gracz 1 vs Gracz 2</div>
                <div id="currentTurnInfo" class="current-turn-info">
                    Kolejka: <span id="currentPlayerName">Gracz 1</span> | Rzuty: <span id="dartsThrown">0/3</span>
                </div>
            </div>
            
            <div class="players-scoreboard">
                <div class="player-score" id="player1Score">
                    <div class="player-name-large" id="player1Name">Gracz 1</div>
                    <div class="current-score" id="player1Points">501</div>
                    <div class="legs-info">
                        Legi: <span id="player1Legs">0</span> |
                        ≈örednia: <span id="player1Average">0.0</span>
                    </div>
                    <div id="player1Checkout" style="margin-top: 10px; color: #FF9800; font-size: 14px;"></div>
                </div>
                
                <div class="player-score" id="player2Score">
                    <div class="player-name-large" id="player2Name">Gracz 2</div>
                    <div class="current-score" id="player2Points">501</div>
                    <div class="legs-info">
                        Legi: <span id="player2Legs">0</span> |
                        ≈örednia: <span id="player2Average">0.0</span>
                    </div>
                    <div id="player2Checkout" style="margin-top: 10px; color: #FF9800; font-size: 14px;"></div>
                </div>
            </div>
            
            <div class="dart-input-section">
                <h3>Wprowad≈∫ punkty z kolejki (3 rzuty)</h3>
                
                <div class="dart-input-row">
                    <div class="dart-input-group">
                        <label class="dart-input-label">Rzut 1:</label>
                        <input type="number" id="dart1" class="dart-points-input" min="0" max="60" value="" placeholder="0-60">
                    </div>
                    
                    <div class="dart-input-group">
                        <label class="dart-input-label">Rzut 2:</label>
                        <input type="number" id="dart2" class="dart-points-input" min="0" max="60" value="" placeholder="0-60">
                    </div>
                    
                    <div class="dart-input-group">
                        <label class="dart-input-label">Rzut 3:</label>
                        <input type="number" id="dart3" class="dart-points-input" min="0" max="60" value="" placeholder="0-60">
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; color: #aaa;">Mno≈ºnik (podw√≥jny/potr√≥jny):</label>
                    <div class="dart-multiplier">
                        <button class="multiplier-btn" onclick="setMultiplier(1)">Pojedynczy (1x)</button>
                        <button class="multiplier-btn" onclick="setMultiplier(2)">Podw√≥jny (2x)</button>
                        <button class="multiplier-btn" onclick="setMultiplier(3)">Potr√≥jny (3x)</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                    <div>Suma kolejki: <span id="turnTotal" style="font-weight: bold; font-size: 18px;">0</span> punkt√≥w</div>
                    <div>Nowy wynik: <span id="newScore" style="font-weight: bold; font-size: 18px; color: #4CAF50;">501</span></div>
                    <div id="checkoutHint" style="margin-top: 10px; font-size: 14px; color: #FF9800;"></div>
                </div>
                
                <div class="game-action-buttons">
                    <button class="btn-undo" onclick="undoLastTurn()" id="undoBtn" disabled>Cofnij kolejkƒô</button>
                    <button class="btn-submit-darts" onclick="submitDarts()" id="submitDartsBtn">Zatwierd≈∫ rzuty</button>
                </div>
            </div>
            
            <div class="turn-history">
                <h3>Historia kolejek</h3>
                <div id="turnsHistory">
                    <!-- Historia kolejek bƒôdzie dodawana dynamicznie -->
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-to-ranks-btn" onclick="showPage('games')">
                    ‚Üê Zako≈Ñcz grƒô i wr√≥ƒá
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA WYNIK√ìW GRY -->
    <div class="container page" id="gameResultsPage">
        <div class="game-results-page">
            <h1>üèÜ WYNIK ROZGRYWKI</h1>
            
            <div class="results-container">
                <div class="winner-celebration" id="winnerCelebration">
                    üéâ ZWYCIƒòZCA: <span id="winnerName">Gracz 1</span> üéâ
                </div>
                
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Statystyka</th>
                            <th id="resultsPlayer1Name">Gracz 1</th>
                            <th id="resultsPlayer2Name">Gracz 2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Wynik ko≈Ñcowy</td>
                            <td id="resultsPlayer1Score">501</td>
                            <td id="resultsPlayer2Score">501</td>
                        </tr>
                        <tr>
                            <td>Wygrane legi</td>
                            <td id="resultsPlayer1Legs">1</td>
                            <td id="resultsPlayer2Legs">0</td>
                        </tr>
                        <tr>
                            <td>≈örednia punkt√≥w/rzut</td>
                            <td id="resultsPlayer1Average">0.0</td>
                            <td id="resultsPlayer2Average">0.0</td>
                        </tr>
                        <tr>
                            <td>Liczba kolejek</td>
                            <td id="resultsPlayer1Turns">0</td>
                            <td id="resultsPlayer2Turns">0</td>
                        </tr>
                        <tr>
                            <td>Najwy≈ºszy checkout</td>
                            <td id="resultsPlayer1Checkout">0</td>
                            <td id="resultsPlayer2Checkout">0</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="elo-options">
                    <h3>üéØ Aktualizacja rankingu ELO</h3>
                    <p>Jak chcesz zaktualizowaƒá ranking ELO po tej rozgrywce?</p>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn-win1" onclick="updateEloAuto()" style="width: 100%; margin-bottom: 10px; padding: 15px;">
                            üîÑ Automatycznie przez kalkulator ELO
                        </button>
                        <p style="font-size: 13px; color: #aaa; margin-bottom: 20px;">
                            System automatycznie obliczy zmianƒô ELO na podstawie wyniku meczu.
                            Wymagane bƒôdƒÖ kody weryfikacyjne obu graczy.
                        </p>
                        
                        <button class="btn-draw" onclick="updateEloManual()" style="width: 100%; padding: 15px;">
                            ‚úèÔ∏è Rƒôcznie (wybierz wynik samodzielnie)
                        </button>
                        <p style="font-size: 13px; color: #aaa;">
                            Sam wybierzesz kto wygra≈Ç lub czy by≈Ç remis w kalkulatorze ELO.
                        </p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="back-to-ranks-btn" onclick="showPage('games')">
                    ‚Üê Wr√≥ƒá do gier
                </button>
                <button class="back-to-ranks-btn" onclick="playAgain()" style="margin-top: 10px; background: #2196F3; border-color: #2196F3;">
                    üîÑ Zagraj jeszcze raz
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA RANG -->
    <div class="container page" id="ranksPage">
        <div class="ranks-page">
            <h1>‚≠ê SYSTEM RANG</h1>
            
            <!-- Status sezonu -->
            <div id="seasonStatus" class="season-status off-season">
                <!-- Dynamicznie ≈Çadowane -->
            </div>
            
            <div id="ranksList">
                <!-- Tutaj zostanƒÖ wygenerowane rangi dynamicznie -->
                ≈Åadowanie rang...
            </div>
            
            <div class="ranks-footer">
                <div class="ranks-footer-buttons">
                    <button class="ranks-footer-btn" onclick="showAchievements()">
                        üèÜ OsiƒÖgniƒôcia
                    </button>
                    <button class="ranks-footer-btn" onclick="showPreviousSeasons()">
                        üìú Wcze≈õniejsze sezony
                    </button>
                </div>
                
                <!-- Przycisk tylko dla admina -->
                <button id="newSeasonBtn" class="ranks-footer-btn admin-season-btn hidden" onclick="showNewSeasonForm()">
                    üöÄ Zacznij nowy sezon
                </button>
                
                <!-- NOWY: Przycisk tylko dla deva do zako≈Ñczenia sezonu -->
                <button id="endSeasonBtn" class="ranks-footer-btn dev-end-season-btn hidden" onclick="endSeasonDev()">
                    ‚èπÔ∏è Zako≈Ñcz sezon (SYSTEM)
                </button>
            </div>
        </div>
    </div>

    <!-- STRONA OSIƒÑGNIƒòƒÜ (UKRYTA, TYLKO Z POZIOMU RANG) -->
    <div class="container page" id="achievementsPage">
        <div class="achievements-page">
            <h1>üèÜ OSIƒÑGNIƒòCIA</h1>
            
            <div id="achievementsList">
                <!-- Tutaj zostanƒÖ wygenerowane osiƒÖgniƒôcia dynamicznie -->
                ≈Åadowanie osiƒÖgniƒôƒá...
            </div>
            
            <button class="back-to-ranks-btn" onclick="showPage('ranks')">
                ‚Üê Powr√≥t do Rang
            </button>
        </div>
    </div>

    <!-- STRONA NOWEGO SEZONU (Tylko dla admina/dev) -->
    <div class="container page" id="newSeasonPage">
        <div class="new-season-page">
            <h1>üöÄ ROZPOCZNIJ NOWY SEZON</h1>
            
            <div class="new-season-form">
                <h3>Ustaw progi ELO dla rang:</h3>
                
                <div class="elo-thresholds" id="eloThresholds">
                    <!-- Dynamicznie generowane pola dla rang -->
                </div>
                
                <div class="date-inputs">
                    <div style="flex: 1;">
                        <label>PoczƒÖtek sezonu:</label>
                        <input type="date" id="seasonStartDate" min="" onchange="validateSeasonDates()">
                    </div>
                    
                    <div style="flex: 1;">
                        <label>Koniec sezonu:</label>
                        <input type="date" id="seasonEndDate" min="" onchange="validateSeasonDates()">
                    </div>
                </div>
                
                <div style="margin: 15px 0;">
                    <label>Nazwa sezonu (opcjonalnie):</label>
                    <input type="text" id="seasonName" placeholder="np. Sezon 1 2025/2026">
                </div>
                
                <div class="season-action-buttons">
                    <button class="btn-cancel" onclick="showPage('ranks')">
                        Anuluj
                    </button>
                    <button class="btn-submit" id="createSeasonBtn" onclick="createNewSeason()" disabled>
                        üöÄ Rozpocznij sezon
                    </button>
                </div>
                
                <div style="font-size: 12px; color: #aaa; margin-top: 20px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                    <strong>‚ö†Ô∏è Uwaga:</strong> Po rozpoczƒôciu sezonu nie mo≈ºna go wcze≈õniej zako≈Ñczyƒá (opr√≥cz panelu systemowego).<br>
                    Po zako≈Ñczeniu sezonu ELO wszystkich graczy zostanie zresetowane do 1500.
                </div>
            </div>
            
            <button class="back-to-ranks-btn" onclick="showPage('ranks')" style="margin-top: 20px;">
                ‚Üê Powr√≥t do Rang
            </button>
        </div>
    </div>

    <!-- STRONA WCZE≈öNIEJSZYCH SEZON√ìW -->
    <div class="container page" id="seasonsPage">
        <div class="seasons-page">
            <h1>üìú WCZE≈öNIEJSZE SEZONY</h1>
            
            <div id="seasonsList">
                <!-- Tutaj zostanƒÖ wygenerowane sezony dynamicznie -->
                ≈Åadowanie sezon√≥w...
            </div>
            
            <button class="back-to-ranks-btn" onclick="showPage('ranks')">
                ‚Üê Powr√≥t do Rang
            </button>
        </div>
    </div>

    <!-- STRONA INFO -->
    <div class="container page" id="infoPage">
        <div class="info-page">
            <h1>‚ÑπÔ∏è INFORMACJE</h1>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #4CAF50;">üîê SYSTEM WERYFIKACJI KOD√ìW</h4>
                <p>Ka≈ºdy gracz ma 5-cyfrowy kod weryfikacyjny. Podczas meczu wymagane jest podanie kodu gracza, aby:</p>
                <ul style="padding-left: 20px;">
                    <li>Zapobiec kradzie≈ºy ELO przez innych graczy</li>
                    <li>Potwierdziƒá to≈ºsamo≈õƒá zawodnika</li>
                    <li>Zapewniƒá uczciwo≈õƒá rozgrywek</li>
                    <li>Kody mogƒÖ siƒô powtarzaƒá</li>
                </ul>
                <p><strong>Proces weryfikacji:</strong></p>
                <ol style="padding-left: 20px;">
                    <li>Wybierz graczy do meczu</li>
                    <li>Kliknij przycisk z wynikiem</li>
                    <li>Wprowad≈∫ kod dla Gracza A</li>
                    <li>Wprowad≈∫ kod dla Gracza B</li>
                    <li>Mecz zostanie zapisany po poprawnej weryfikacji obu kod√≥w</li>
                </ol>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #4CAF50;">üìä O SYSTEMIE ELO</h4>
                <p>System Elo s≈Çu≈ºy do obliczania wzglƒôdnej si≈Çy graczy na podstawie wynik√≥w mecz√≥w.</p>
                <ul style="padding-left: 20px;">
                    <li><strong>K = 32</strong> - wsp√≥≈Çczynnik zmiany dla darta</li>
                    <li><strong>ELO poczƒÖtkowe:</strong> 1500 punkt√≥w</li>
                    <li><strong>Wz√≥r:</strong> 1 / (1 + 10^((R_B - R_A)/400))</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #2196F3;">üîê POZIOMY DOSTƒòPU</h4>
                <ul style="padding-left: 20px;">
                    <li><strong>PrzeglƒÖdanie:</strong> PrzeglƒÖdanie rankingu, ukryte nazwiska (zawsze dostƒôpne)</li>
                    <li><strong>U≈ºytkownik:</strong> Rozgrywanie mecz√≥w, pe≈Çne nazwiska (do w≈ÇƒÖczenia)</li>
                    <li><strong>Premium:</strong> Dodawanie/Usuwanie graczy (do w≈ÇƒÖczenia)</li>
                </ul>
                <p style="margin-top: 10px; font-size: 13px; color: #aaa;">
                    Dostƒôpy U≈ºytkownika i Premium mogƒÖ byƒá w≈ÇƒÖczane/wy≈ÇƒÖczane przez administratora systemu.
                </p>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #9C27B0;">üèÜ SYSTEM SEZON√ìW</h4>
                <p>System sezon√≥w pozwala na rozgrywanie okresowych rozgrywek z resetem ranking√≥w.</p>
                <ul style="padding-left: 20px;">
                    <li><strong>Sezony:</strong> Okresowe rozgrywki z w≈Çasnymi progami ELO</li>
                    <li><strong>Reset ELO:</strong> Po sezonie wszyscy gracze wracajƒÖ do 1500 ELO</li>
                    <li><strong>OsiƒÖgniƒôcia:</strong> Specjalne nagrody za wyniki w sezonie</li>
                    <li><strong>Archiwum:</strong> Historia wszystkich sezon√≥w</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h4 style="margin-top: 0; color: #BB86FC;">üéÆ GRY 501 TO 0</h4>
                <p>Klasyczna gra w darta. Ka≈ºdy gracz zaczyna z 501 punktami i pr√≥buje zredukowaƒá sw√≥j wynik do zera.</p>
                <ul style="padding-left: 20px;">
                    <li><strong>Zasady:</strong> Wygrywa gracz, kt√≥ry pierwszy osiƒÖgnie dok≈Çadnie 0 punkt√≥w</li>
                    <li><strong>Checkout:</strong> Ostatni rzut musi byƒá podw√≥jnym lub bulleye</li>
                    <li><strong>Bust:</strong> Je≈õli rzut przekroczy aktualny wynik, kolejka jest niewa≈ºna</li>
                    <li><strong>Kolejki:</strong> Gracze wykonujƒÖ na zmianƒô po 3 rzuty</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // KONFIGURACJA FIREBASE
        // ============================================
        
        const firebaseConfig = {
			apiKey: "AIzaSyAiRim-yx73MLHlUvOKsoBav57TXaEzN24",
			authDomain: "dartteaplikacjaszypra.firebaseapp.com",
            projectId: "dartteaplikacjaszypra",
            storageBucket: "dartteaplikacjaszypra.firebasestorage.app",
            messagingSenderId: "461617366334",
            appId: "1:461617366334:web:4b26e73d9db79e9665586f"
        };
        
        // ============================================
        // INICJALIZACJA APLIKACJI
        // ============================================
        
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                return {
                    app: firebase.app(),
                    db: firebase.firestore(),
                    auth: firebase.auth()
                };
            } catch (error) {
                console.error("B≈ÇƒÖd inicjalizacji Firebase:", error);
                return null;
            }
        }
        
        // ============================================
        // G≈Å√ìWNY KOD APLIKACJI - PO≈ÅƒÑCZONY
        // ============================================
        
        // Zmienne globalne z pierwszego kodu
        let db = null;
        let auth = null;
        let players = [];
        let history = [];
        let currentUserRole = 'guest';
        let unsubscribePlayers = null;
        let unsubscribeHistory = null;
        let unsubscribeSettings = null;
        let currentPage = 'elo';
        
        // Ustawienia systemu
        let systemSettings = {
            adminEnabled: false,
            userEnabled: false,
            adminPassword: '',
            userPassword: ''
        };
        
        // Zmienne do weryfikacji kodu
        let pendingMatch = null;
        let verificationPlayer = null;
        
        // Zmienne z drugiego kodu (sezony)
        let currentSeason = null;
        let previousSeasons = [];
        
        // Zmienne do gry 501
        let currentGame = {
            mode: '501',
            player1: null,
            player2: null,
            startingPlayer: 1,
            currentPlayer: 1,
            scores: {
                player1: 501,
                player2: 501
            },
            legs: {
                player1: 0,
                player2: 0
            },
            turns: [],
            dartsThrown: 0,
            gameOver: false,
            winner: null,
            gameId: null,
            stats: {
                player1: {
                    totalPoints: 0,
                    dartsThrown: 0,
                    average: 0,
                    highestCheckout: 0,
                    turns: 0
                },
                player2: {
                    totalPoints: 0,
                    dartsThrown: 0,
                    average: 0,
                    highestCheckout: 0,
                    turns: 0
                }
            }
        };
        
        let currentMultiplier = 1;
        let gameHistory = [];
        
        // Definicja rang (mo≈ºesz tu zmieniƒá progi ELO)
        const ranks = [
            { id: 1, name: "Bez rangi", minElo: 0, maxElo: 1000, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQALiXZw7h0uRZWF1EomXOK8AaF8EmsHhY61OddiwuGKs8o?e=q13UFF" },
            { id: 2, name: "Rekrut", minElo: 1001, maxElo: 1200, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQCGYc1plt8GTopuGjsjDwChAS_AezLQp5kXt4U1G1e-L4s?e=mPuRI8" },
            { id: 3, name: "Nowicjusz", minElo: 1201, maxElo: 1400, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQB1Ctp11cJZSqdeuI2iVB1bAW9FcbYvB2FTnMw5XYamkv0?e=0eP6hX" },
            { id: 4, name: "Amator", minElo: 1401, maxElo: 1600, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQB24NZyOFr_RZs7SniyVz0nAc5SqOUCzWM_rgL7rbfKdCY?e=4cSFa8" },
            { id: 5, name: "Srebro", minElo: 1601, maxElo: 1800, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQB3SDRftdVoSY0hMKY-3cJpAUG4oVh9xskQAWAelPSGGWI?e=BKGPvu" },
            { id: 6, name: "Z≈Çoto", minElo: 1801, maxElo: 2000, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQAjklxp-5GESpMSWnipwxtRAXGp0MvG3RiKZkNK-yFdfyM?e=clcRsg" },
            { id: 7, name: "Diamentowa liga", minElo: 2001, maxElo: 2200, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQBgwUKEtWzCQbQLHEONquzEAXSnpFHMYSNbs4V4qGVKvKU?e=60zdVR" },
            { id: 8, name: "Liga kr√≥lewska", minElo: 2201, maxElo: 2400, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQCEDY1-tPATRryWICgZGD-0AXDU6mANVgDZDmN3tGvi_0M?e=1FD9di" },
            { id: 9, name: "Liga mistrzowska", minElo: 2401, maxElo: 9999, image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQCuidoPh_oAQqUrHqlr0j9FAVwfzw6uhPpdA8vFa4BkS9s?e=gZW8Wv" }
        ];
        
        // Definicja osiƒÖgniƒôƒá
        const achievements = [
            { 
                id: 1, 
                name: "None", 
                description: "Jest to informacja, ≈ºe u≈ºytkownik nie posiada ≈ºadnych osiƒÖgniƒôƒá.",
                image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQBdOvsesaR-RJQn_ILo4nQwAXacX-w5ljD6Zzt6dQkcWRE?e=SevlG1" 
            },
            { 
                id: 2, 
                name: "Top 3 of season", 
                description: "To osiƒÖgniƒôcie zdobywa siƒô za uzyskanie trzeciego miejsca w sezonowym rankingu graczy. Je≈ºeli jednak dodatkowo u≈ºytkownik bƒôdzie mia≈Ç rangƒô 'Liga mistrzowska', zamiast tego osiƒÖgniƒôcia dostaje osiƒÖgniƒôcie 'RANK9 of season'.",
                image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQBZyvFXA1ylSrgOHdPXdHOBATxSl8lA1dXfvYloLtQ135k?e=FYBAnS" 
            },
            { 
                id: 3, 
                name: "Top 2 of season", 
                description: "U≈ºytkownik mo≈ºe otrzymaƒá tƒÖ rangƒô za uzyskanie drugiego miejsca w sezonowym rankingu graczy. Je≈ºeli jednak dodatkowo u≈ºytkownik bƒôdzie mia≈Ç rangƒô 'Liga mistrzowska', zamiast tego osiƒÖgniƒôcia dostaje osiƒÖgniƒôcie 'RANK9 of season'.",
                image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQD8e67-vc-ZSZH5D29YYaLBAdTCjN_tfedbVPLcZeZuVVA?e=DfhDDC" 
            },
            { 
                id: 4, 
                name: "Top 1 of season", 
                description: "Gdy u≈ºytkownik osiƒÖgnie pierwsze miejsce w sezonowym rankingu graczy, to osiƒÖgniƒôcie zostaje przypisane do jego konta. Je≈ºeli jednak dodatkowo u≈ºytkownik bƒôdzie mia≈Ç rangƒô 'Liga mistrzowska', zamiast tego osiƒÖgniƒôcia dostaje osiƒÖgniƒôcie 'RANK9 of season'.",
                image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQB2jHZaKWqAQJ0WLoVRSyF1AQrW2yy3LXFtlYOrAwIWoU4?e=Y9YwwC" 
            },
            { 
                id: 5, 
                name: "RANK9 of season", 
                description: "OsiƒÖgniƒôcie to mo≈ºna zdobyƒá za uko≈Ñczenie sezonu z rangƒÖ dziewiƒÖtƒÖ.",
                image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQBoTZrcR9COT5pMtQev8yMYARhO_gu54bs-ccPH8dz7KmM?e=eoOibY" 
            },
            { 
                id: 6, 
                name: "Top 1 of season [RANK9]", 
                description: "Je≈ºeli jeste≈õ pierwszy w sezonowym rankingu graczy oraz zako≈Ñczy≈Çe≈õ sezon z rangƒÖ dziewiƒÖtƒÖ, to omawiane osiƒÖgniƒôcie jest twoje!",
                image: "https://1drv.ms/i/c/98fdba83fc4aac98/IQBSZHId-edhRqWj1e8zNLb8AajoYpPkzZFKiDMHXGHsCdA?e=UyRPxe" 
            }
        ];
        
        // ============================================
        // FUNKCJE Z PIERWSZEGO KODU (KALKULATOR ELO)
        // ============================================
        
        function generateRandomCode() {
            const randomCode = Math.floor(10000 + Math.random() * 90000);
            const element = document.getElementById('newPlayerCode');
            if (element) {
                element.value = randomCode;
                element.focus();
            }
        }
        
        function generateRandomCodeDev() {
            const randomCode = Math.floor(10000 + Math.random() * 90000);
            const element = document.getElementById('devNewPlayerCode');
            if (element) {
                element.value = randomCode;
                element.focus();
            }
        }
        
        // Modal weryfikacji kodu
        function showCodeModal(playerType, playerName) {
            verificationPlayer = playerType;
            const modal = document.getElementById('codeModal');
            const playerNameElement = document.getElementById('modalPlayerName');
            const message = document.getElementById('modalMessage');
            
            if (playerNameElement) playerNameElement.innerHTML = `<strong>${playerName}</strong>`;
            
            if (playerType === 'A') {
                if (message) message.innerHTML = `<p>Wprowad≈∫ kod weryfikacyjny dla <strong>Gracza A</strong>:</p>`;
            } else {
                if (message) message.innerHTML = `<p>Wprowad≈∫ kod weryfikacyjny dla <strong>Gracza B</strong>:</p>`;
            }
            
            const codeInput = document.getElementById('codeInput');
            if (codeInput) {
                codeInput.value = '';
                codeInput.focus();
            }
            
            if (modal) modal.classList.add('active');
        }
        
        function closeCodeModal() {
            const modal = document.getElementById('codeModal');
            if (modal) modal.classList.remove('active');
        }
        
        function submitCode() {
            const codeInput = document.getElementById('codeInput');
            if (!codeInput) return;
            
            const codeValue = codeInput.value;
            
            if (codeValue.length !== 5) {
                alert('Kod musi mieƒá dok≈Çadnie 5 cyfr!');
                codeInput.focus();
                return;
            }
            
            if (!pendingMatch) {
                alert('‚ùå B≈ÇƒÖd: Brak danych meczu. Spr√≥buj ponownie.');
                closeCodeModal();
                return;
            }
            
            let playerToVerify = null;
            let playerName = '';
            
            if (verificationPlayer === 'A' && pendingMatch.playerA) {
                playerToVerify = pendingMatch.playerA;
                playerName = pendingMatch.playerA.name;
            } else if (verificationPlayer === 'B' && pendingMatch.playerB) {
                playerToVerify = pendingMatch.playerB;
                playerName = pendingMatch.playerB.name;
            }
            
            if (!playerToVerify) {
                alert('B≈ÇƒÖd weryfikacji! Spr√≥buj ponownie.');
                closeCodeModal();
                pendingMatch = null;
                return;
            }
            
            if (playerToVerify.code !== codeValue) {
                alert(`‚ùå Nieprawid≈Çowy kod weryfikacyjny dla gracza ${playerName}!`);
                codeInput.value = '';
                codeInput.focus();
                return;
            }
            
            alert(`‚úÖ Poprawny kod dla ${playerName}!`);
            
            if (verificationPlayer === 'A' && pendingMatch) {
                showCodeModal('B', pendingMatch.playerB.name);
            } else if (verificationPlayer === 'B' && pendingMatch) {
                closeCodeModal();
                calculateMatchFinal(pendingMatch.scoreA, pendingMatch.playerA, pendingMatch.playerB);
                pendingMatch = null;
                verificationPlayer = null;
            }
        }
        
        // Nawigacja
        function showPage(pageId) {
            if (pageId === 'games' && currentUserRole === 'guest') {
                alert('Zaloguj siƒô aby mieƒá dostƒôp do sekcji Gry!');
                return;
            }
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const pageElement = document.getElementById(pageId + 'Page');
            if (pageElement) pageElement.classList.add('active');
            
            const btn = document.querySelector(`.nav-btn[onclick*="${pageId}"]`);
            if (btn) btn.classList.add('active');
            
            currentPage = pageId;
            
            // Aktualizuj strony gdy sƒÖ pokazywane
            if (pageId === 'ranks') {
                setTimeout(() => {
                    generateRanksPage();
                    generateSeasonStatus();
                }, 100);
            } else if (pageId === 'achievements') {
                setTimeout(() => {
                    generateAchievementsPage();
                }, 100);
            } else if (pageId === 'newSeason') {
                setTimeout(() => {
                    generateNewSeasonForm();
                }, 100);
            } else if (pageId === 'seasons') {
                setTimeout(() => {
                    generateSeasonsPage();
                }, 100);
            } else if (pageId === 'games') {
                updateGamePlayerSelects();
            }
        }
        
        function updateMenuForRole() {
            const gamesBtn = document.getElementById('gamesBtn');
            if (!gamesBtn) return;
            
            if (currentUserRole === 'guest') {
                gamesBtn.classList.add('disabled');
                gamesBtn.title = "Zaloguj siƒô aby mieƒá dostƒôp";
            } else {
                gamesBtn.classList.remove('disabled');
                gamesBtn.title = "";
            }
        }
        
        // Autoryzacja
        async function login() {
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            const passwordInput = document.getElementById('adminPassword');
            if (!passwordInput) return;
            
            const password = passwordInput.value;
            
            if (password === 'Dev123SP') {
                const currentDeviceId = getDeviceId();
                console.log('Twoje Device ID:', currentDeviceId);
                
                try {
                    const devicesDoc = await db.collection('system').doc('devices').get();
                    
                    if (devicesDoc.exists) {
                        const allowedDevices = devicesDoc.data().allowedDevices || [];
                        
                        if (allowedDevices.includes(currentDeviceId)) {
                            currentUserRole = 'dev';
                            updateUIForRole();
                            updateMenuForRole();
                            updateNewSeasonButton();
                            updateEndSeasonButton();
                            alert('‚úÖ Zalogowano do panelu systemowego!');
                            passwordInput.value = '';
                        } else {
                            alert('‚ùå To urzƒÖdzenie nie ma dostƒôpu systemowego!\n\nTwoje Device ID: ' + currentDeviceId + '\nSkontaktuj siƒô z administratorem aby dodaƒá to urzƒÖdzenie.');
                            passwordInput.value = '';
                        }
                    } else {
                        alert('‚ùå Brak konfiguracji systemu!');
                        passwordInput.value = '';
                    }
                } catch (error) {
                    console.error("B≈ÇƒÖd sprawdzania urzƒÖdzenia:", error);
                    alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z Firebase!\n' + error.message);
                    passwordInput.value = '';
                }
                return;
            }
            
            if (password === systemSettings.adminPassword && systemSettings.adminPassword !== '') {
                if (!systemSettings.adminEnabled) {
                    alert('‚ùå Dostƒôp Premium jest obecnie wy≈ÇƒÖczony!');
                    passwordInput.value = '';
                    return;
                }
                currentUserRole = 'admin';
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                alert('‚úÖ Zalogowano do konta Premium!');
                passwordInput.value = '';
                return;
            }
            
            if (password === systemSettings.userPassword && systemSettings.userPassword !== '') {
                if (!systemSettings.userEnabled) {
                    alert('‚ùå Dostƒôp U≈ºytkownika jest obecnie wy≈ÇƒÖczony!');
                    passwordInput.value = '';
                    return;
                }
                currentUserRole = 'user';
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                alert('‚úÖ Zalogowano do konta U≈ºytkownika!');
                passwordInput.value = '';
                return;
            }
            
            if (password === '') {
                currentUserRole = 'guest';
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                return;
            }
            
            alert('‚ùå Nieprawid≈Çowe has≈Ço!');
            passwordInput.value = '';
        }
        
        function logout() {
            currentUserRole = 'guest';
            updateUIForRole();
            updateMenuForRole();
            updateNewSeasonButton();
            updateEndSeasonButton();
            
            if (currentPage === 'games' || currentPage === 'gameSetup' || currentPage === 'game501' || currentPage === 'gameResults') {
                showPage('elo');
            }
        }
        
        function updateUIForRole() {
            const loginBox = document.getElementById('loginBox');
            const adminPanel = document.getElementById('adminPanel');
            const userPanel = document.getElementById('userPanel');
            const devPanel = document.getElementById('devPanel');
            
            if (loginBox) loginBox.classList.add('hidden');
            if (adminPanel) adminPanel.classList.add('hidden');
            if (userPanel) userPanel.classList.add('hidden');
            if (devPanel) devPanel.classList.add('hidden');
            
            if (currentUserRole === 'admin' && adminPanel) {
                adminPanel.classList.remove('hidden');
            } else if (currentUserRole === 'user' && userPanel) {
                userPanel.classList.remove('hidden');
            } else if (currentUserRole === 'dev' && devPanel) {
                devPanel.classList.remove('hidden');
            } else if (loginBox) {
                loginBox.classList.remove('hidden');
            }
            
            updateAllDisplays();
            updateRoleStatusDisplay();
        }
        
        // ≈Åadowanie ustawie≈Ñ systemu
        function loadSystemSettings() {
            if (!db) return;
            
            if (unsubscribeSettings) unsubscribeSettings();
            
            unsubscribeSettings = db.collection('system').doc('settings')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        systemSettings = doc.data();
                        
                        if (systemSettings.adminEnabled === undefined) systemSettings.adminEnabled = false;
                        if (systemSettings.userEnabled === undefined) systemSettings.userEnabled = false;
                        if (!systemSettings.adminPassword) systemSettings.adminPassword = '';
                        if (!systemSettings.userPassword) systemSettings.userPassword = '';
                        
                        console.log('Ustawienia systemowe za≈Çadowane:', systemSettings);
                        updateRoleStatusDisplay();
                    } else {
                        console.log('Brak dokumentu settings w Firebase');
                        systemSettings = {
                            adminEnabled: false,
                            userEnabled: false,
                            adminPassword: '',
                            userPassword: ''
                        };
                    }
                }, error => {
                    console.error("B≈ÇƒÖd ≈Çadowania ustawie≈Ñ:", error);
                    systemSettings = {
                        adminEnabled: false,
                        userEnabled: false,
                        adminPassword: '',
                        userPassword: ''
                    };
                });
        }
        
        function updateRoleStatusDisplay() {
            const adminStatus = document.getElementById('adminStatus');
            const userStatus = document.getElementById('userStatus');
            const currentAdminPassword = document.getElementById('currentAdminPassword');
            const currentUserPassword = document.getElementById('currentUserPassword');
            
            if (adminStatus) {
                if (systemSettings.adminEnabled && systemSettings.adminPassword) {
                    adminStatus.textContent = 'W≈ÅƒÑCZONY';
                    adminStatus.className = 'role-status status-enabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleAdminRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'WY≈ÅƒÑCZ';
                    if (currentAdminPassword) currentAdminPassword.textContent = systemSettings.adminPassword;
                } else {
                    adminStatus.textContent = 'WY≈ÅƒÑCZONY';
                    adminStatus.className = 'role-status status-disabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleAdminRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'W≈ÅƒÑCZ';
                    if (currentAdminPassword) currentAdminPassword.textContent = systemSettings.adminPassword || 'brak';
                }
            }
            
            if (userStatus) {
                if (systemSettings.userEnabled && systemSettings.userPassword) {
                    userStatus.textContent = 'W≈ÅƒÑCZONY';
                    userStatus.className = 'role-status status-enabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleUserRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'WY≈ÅƒÑCZ';
                    if (currentUserPassword) currentUserPassword.textContent = systemSettings.userPassword;
                } else {
                    userStatus.textContent = 'WY≈ÅƒÑCZONY';
                    userStatus.className = 'role-status status-disabled';
                    const toggleBtn = document.querySelector('button[onclick="toggleUserRole()"]');
                    if (toggleBtn) toggleBtn.textContent = 'W≈ÅƒÑCZ';
                    if (currentUserPassword) currentUserPassword.textContent = systemSettings.userPassword || 'brak';
                }
            }
        }
        
        async function toggleAdminRole() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostƒôp systemowy mo≈ºe zmieniaƒá ustawienia!');
                return;
            }
            
            const passwordInput = document.getElementById('adminPasswordInput');
            if (!passwordInput) return;
            
            const newPassword = passwordInput.value;
            const newStatus = !systemSettings.adminEnabled;
            
            if (newStatus && (!newPassword || newPassword.length < 3)) {
                alert('Musisz ustawiƒá has≈Ço (minimum 3 znaki) aby w≈ÇƒÖczyƒá dostƒôp Premium!');
                passwordInput.focus();
                return;
            }
            
            if (newPassword && newPassword.length > 0) {
                systemSettings.adminPassword = newPassword;
            }
            
            systemSettings.adminEnabled = newStatus;
            
            try {
                await db.collection('system').doc('settings').update({
                    adminEnabled: newStatus,
                    adminPassword: systemSettings.adminPassword,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                passwordInput.value = '';
                updateRoleStatusDisplay();
                
                const statusText = newStatus ? 'w≈ÇƒÖczony' : 'wy≈ÇƒÖczony';
                alert(`‚úÖ Dostƒôp Premium zosta≈Ç ${statusText}!`);
            } catch (error) {
                alert('B≈ÇƒÖd aktualizacji ustawie≈Ñ: ' + error.message);
            }
        }
        
        async function toggleUserRole() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostƒôp systemowy mo≈ºe zmieniaƒá ustawienia!');
                return;
            }
            
            const passwordInput = document.getElementById('userPasswordInput');
            if (!passwordInput) return;
            
            const newPassword = passwordInput.value;
            const newStatus = !systemSettings.userEnabled;
            
            if (newStatus && (!newPassword || newPassword.length < 3)) {
                alert('Musisz ustawiƒá has≈Ço (minimum 3 znaki) aby w≈ÇƒÖczyƒá dostƒôp U≈ºytkownika!');
                passwordInput.focus();
                return;
            }
            
            if (newPassword && newPassword.length > 0) {
                systemSettings.userPassword = newPassword;
            }
            
            systemSettings.userEnabled = newStatus;
            
            try {
                await db.collection('system').doc('settings').update({
                    userEnabled: newStatus,
                    userPassword: systemSettings.userPassword,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                passwordInput.value = '';
                updateRoleStatusDisplay();
                
                const statusText = newStatus ? 'w≈ÇƒÖczony' : 'wy≈ÇƒÖczony';
                alert(`‚úÖ Dostƒôp U≈ºytkownika zosta≈Ç ${statusText}!`);
            } catch (error) {
                alert('B≈ÇƒÖd aktualizacji ustawie≈Ñ: ' + error.message);
            }
        }
        
        // Formatowanie nazwisk
        function formatPlayerName(playerName, forGuest = false) {
            if (!forGuest || currentUserRole !== 'guest') {
                return playerName;
            }
            
            const parts = playerName.trim().split(' ');
            
            if (parts.length === 1) {
                return playerName;
            } else if (parts.length >= 2) {
                const firstName = parts[0];
                const lastName = parts[parts.length - 1];
                const lastNameInitial = lastName.charAt(0).toUpperCase();
                return `${firstName} ${lastNameInitial}.`;
            }
            
            return playerName;
        }
        
        // Obs≈Çuga danych z Firestore
        function loadData() {
            if (!db) {
                console.error('Brak po≈ÇƒÖczenia z Firestore');
                return;
            }
            
            // Gracze
            if (unsubscribePlayers) unsubscribePlayers();
            unsubscribePlayers = db.collection('players')
                .orderBy('elo', 'desc')
                .onSnapshot(snapshot => {
                    players = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        players.push({
                            id: doc.id,
                            name: data.name || '',
                            elo: data.elo || 1500,
                            code: data.code || '00000',
                            createdAt: data.createdAt || new Date(),
                            createdBy: data.createdBy || 'unknown'
                        });
                    });
                    updateAllDisplays();
                    updateGamePlayerSelects();
                }, error => {
                    console.error("B≈ÇƒÖd ≈Çadowania graczy:", error);
                });
            
            // Historia
            if (unsubscribeHistory) unsubscribeHistory();
            unsubscribeHistory = db.collection('history')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .onSnapshot(snapshot => {
                    history = [];
                    snapshot.forEach(doc => {
                        history.push(doc.data());
                    });
                    updateHistory();
                }, error => {
                    console.error("B≈ÇƒÖd ≈Çadowania historii:", error);
                });
            
            loadSystemSettings();
        }
        
        // Operacje na graczach
        async function addNewPlayer() {
            if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
                alert('Tylko dostƒôp Premium lub systemowy mo≈ºe dodawaƒá graczy!');
                return;
            }
            
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            const nameInput = document.getElementById('newPlayerName');
            const eloInput = document.getElementById('newPlayerElo');
            const codeInput = document.getElementById('newPlayerCode');
            
            if (!nameInput || !eloInput || !codeInput) return;
            
            const name = nameInput.value.trim();
            const elo = parseInt(eloInput.value) || 1500;
            const code = codeInput.value;
            
            if (!name) {
                alert('Wpisz imiƒô gracza!');
                nameInput.focus();
                return;
            }
            
            if (!code || code.length !== 5) {
                alert('Kod musi mieƒá dok≈Çadnie 5 cyfr!');
                codeInput.focus();
                return;
            }
            
            if (!/^\d{5}$/.test(code)) {
                alert('Kod mo≈ºe zawieraƒá tylko cyfry!');
                codeInput.focus();
                return;
            }
            
            const existingPlayer = players.find(p => 
                p.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingPlayer) {
                alert(`Gracz "${name}" ju≈º istnieje!`);
                return;
            }
            
            try {
                await db.collection('players').add({
                    name: name,
                    elo: elo,
                    code: code,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUserRole
                });
                
                nameInput.value = '';
                eloInput.value = 1500;
                codeInput.value = '';
                
                generateRandomCode();
                
                alert(`‚úÖ Dodano gracza: ${name}\nELO: ${elo}\nKod: ${code}`);
            } catch (error) {
                alert('B≈ÇƒÖd dodawania gracza: ' + error.message);
            }
        }
        
        async function addNewPlayerDev() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostƒôp systemowy mo≈ºe dodawaƒá graczy z tego panelu!');
                return;
            }
            
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            const nameInput = document.getElementById('devNewPlayerName');
            const eloInput = document.getElementById('devNewPlayerElo');
            const codeInput = document.getElementById('devNewPlayerCode');
            
            if (!nameInput || !eloInput || !codeInput) return;
            
            const name = nameInput.value.trim();
            const elo = parseInt(eloInput.value) || 1500;
            const code = codeInput.value;
            
            if (!name) {
                alert('Wpisz imiƒô gracza!');
                nameInput.focus();
                return;
            }
            
            if (!code || code.length !== 5) {
                alert('Kod musi mieƒá dok≈Çadnie 5 cyfr!');
                codeInput.focus();
                return;
            }
            
            if (!/^\d{5}$/.test(code)) {
                alert('Kod mo≈ºe zawieraƒá tylko cyfry!');
                codeInput.focus();
                return;
            }
            
            const existingPlayer = players.find(p => 
                p.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingPlayer) {
                alert(`Gracz "${name}" ju≈º istnieje!`);
                return;
            }
            
            try {
                await db.collection('players').add({
                    name: name,
                    elo: elo,
                    code: code,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUserRole
                });
                
                nameInput.value = '';
                eloInput.value = 1500;
                codeInput.value = '';
                
                generateRandomCodeDev();
                
                alert(`‚úÖ Dodano gracza: ${name}\nELO: ${elo}\nKod: ${code}`);
            } catch (error) {
                alert('B≈ÇƒÖd dodawania gracza: ' + error.message);
            }
        }
        
        async function deletePlayer(playerId) {
            if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
                alert('Tylko dostƒôp Premium lub systemowy mo≈ºe usuwaƒá graczy!');
                return;
            }
            
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            if (confirm('Czy na pewno chcesz usunƒÖƒá tego gracza?')) {
                try {
                    await db.collection('players').doc(playerId).delete();
                    alert('Gracz usuniƒôty!');
                } catch (error) {
                    alert('B≈ÇƒÖd usuwania gracza: ' + error.message);
                }
            }
        }
        
        // Zamiana graczy
        function swapPlayers() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            const swapBtn = document.getElementById('swapBtn');
            
            if (!selectA || !selectB) return;
            
            const playerAId = selectA.value;
            const playerBId = selectB.value;
            
            if (!playerAId || !playerBId) {
                return;
            }
            
            if (playerAId === playerBId) {
                return;
            }
            
            const temp = playerAId;
            selectA.value = playerBId;
            selectB.value = temp;
            
            updateButtons();
            updateChanceDisplay();
            
            if (swapBtn) {
                swapBtn.style.transform = 'rotate(180deg)';
                swapBtn.style.transition = 'transform 0.3s';
                
                setTimeout(() => {
                    swapBtn.style.transform = 'rotate(0deg)';
                }, 300);
            }
        }
        
        // Event listeners dla select√≥w
        function onPlayerSelectChange() {
            updateButtons();
            updateChanceDisplay();
            updateSwapButton();
        }
        
        // Funkcje przycisk√≥w meczu
        function playerAWins() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz r√≥≈ºnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 1
            };
            
            showCodeModal('A', playerA.name);
        }
        
        function playerBWins() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz r√≥≈ºnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 0
            };
            
            showCodeModal('A', playerA.name);
        }
        
        function draw() { 
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (playerA.id === playerB.id) {
                alert('Wybierz r√≥≈ºnych graczy!');
                return;
            }
            
            pendingMatch = {
                playerA: playerA,
                playerB: playerB,
                scoreA: 0.5
            };
            
            showCodeModal('A', playerA.name);
        }
        
        // Calculate match final
        async function calculateMatchFinal(scoreA, playerA, playerB) {
            console.log('calculateMatchFinal called:', { scoreA, playerA: playerA.name, playerB: playerB.name });
            
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z bazƒÖ danych!');
                return;
            }
            
            const expectedA = 1 / (1 + Math.pow(10, (playerB.elo - playerA.elo) / 400));
            const change = Math.round(32 * (scoreA - expectedA));
            
            const newEloA = playerA.elo + change;
            const newEloB = playerB.elo - change;
            
            const matchData = {
                playerA: playerA.name,
                playerB: playerB.name,
                playerAId: playerA.id,
                playerBId: playerB.id,
                result: scoreA === 1 ? 'A' : scoreA === 0 ? 'B' : 'D',
                change: change,
                eloABefore: playerA.elo,
                eloBBefore: playerB.elo,
                eloAAfter: newEloA,
                eloBAfter: newEloB,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                date: new Date().toLocaleString(),
                playedBy: currentUserRole,
                verified: true
            };
            
            console.log('Match data to save:', matchData);
            
            try {
                const batch = db.batch();
                
                const playerARef = db.collection('players').doc(playerA.id);
                batch.update(playerARef, { elo: newEloA });
                
                const playerBRef = db.collection('players').doc(playerB.id);
                batch.update(playerBRef, { elo: newEloB });
                
                const historyRef = db.collection('history').doc();
                batch.set(historyRef, matchData);
                
                await batch.commit();
                
                console.log('‚úÖ Mecz zapisany pomy≈õlnie!');
                showMatchDetails(playerA, playerB, change, scoreA);
                
                setTimeout(() => {
                    updateAllDisplays();
                }, 500);
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd zapisywania meczu:', error);
                
                if (error.code === 'permission-denied') {
                    alert('‚ùå B≈ÇƒÖd uprawnie≈Ñ Firebase!\nSprawd≈∫ czy regu≈Çy Firestore pozwalajƒÖ na zapis.\nB≈ÇƒÖd: ' + error.message);
                } else {
                    alert('B≈ÇƒÖd zapisywania meczu: ' + error.message);
                }
            }
        }
        
        function showMatchDetails(playerA, playerB, change, scoreA) {
            const resultText = scoreA === 1 ? `${playerA.name} wygra≈Ç z ${playerB.name}` :
                              scoreA === 0 ? `${playerB.name} wygra≈Ç z ${playerA.name}` :
                              `${playerA.name} zremisowa≈Ç z ${playerB.name}`;
            
            const changeText = change > 0 ? `+${change}` : change;
            const message = `
                ${resultText}
                
                ${playerA.name}: ${playerA.elo} ‚Üí ${playerA.elo + change} (${changeText})
                ${playerB.name}: ${playerB.elo} ‚Üí ${playerB.elo - change} (${-change})
                
                Data: ${new Date().toLocaleString()}
                ‚úÖ Mecz zweryfikowany kodami
            `;
            
            alert(message);
        }
        
        // Funkcje pomocnicze
        function updateAllDisplays() {
            updatePlayerSelects();
            updatePlayersList();
            updateChanceDisplay();
            updateSwapButton();
        }
        
        function updateSwapButton() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            const swapBtn = document.getElementById('swapBtn');
            
            if (!selectA || !selectB || !swapBtn) return;
            
            const playerAId = selectA.value;
            const playerBId = selectB.value;
            
            if (playerAId && playerBId && playerAId !== playerBId) {
                swapBtn.disabled = false;
                swapBtn.title = "Zamie≈Ñ graczy miejscami";
            } else {
                swapBtn.disabled = true;
                swapBtn.title = "Wybierz r√≥≈ºnych graczy aby zamieniƒá";
            }
        }
        
        function updatePlayerSelects() {
            const selectA = document.getElementById('selectPlayerA');
            const selectB = document.getElementById('selectPlayerB');
            
            if (!selectA || !selectB) return;
            
            const currentA = selectA.value;
            const currentB = selectB.value;
            
            selectA.innerHTML = '<option value="">Wybierz gracza</option>';
            selectB.innerHTML = '<option value="">Wybierz gracza</option>';
            
            players.forEach(player => {
                const displayName = formatPlayerName(player.name, true);
                const option = `<option value="${player.id}">${displayName} (${player.elo})</option>`;
                selectA.innerHTML += option;
                selectB.innerHTML += option;
            });
            
            if (currentA && players.some(p => p.id === currentA)) selectA.value = currentA;
            if (currentB && players.some(p => p.id === currentB)) selectB.value = currentB;
            
            updateButtons();
            updateSwapButton();
        }
        
        function updateButtons() {
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            const btnA = document.getElementById('btnA');
            const btnB = document.getElementById('btnB');
            const btnDraw = document.getElementById('btnDraw');
            
            if (btnA) {
                if (playerA) {
                    const displayName = formatPlayerName(playerA.name, true);
                    btnA.textContent = displayName.toUpperCase() + ' WYGRYWA';
                    btnA.disabled = (currentUserRole === 'guest');
                } else {
                    btnA.textContent = 'GRACZ A wygrywa';
                    btnA.disabled = true;
                }
            }
            
            if (btnB) {
                if (playerB) {
                    const displayName = formatPlayerName(playerB.name, true);
                    btnB.textContent = displayName.toUpperCase() + ' WYGRYWA';
                    btnB.disabled = (currentUserRole === 'guest');
                } else {
                    btnB.textContent = 'GRACZ B wygrywa';
                    btnB.disabled = true;
                }
            }
            
            if (btnDraw) {
                if (playerA && playerB) {
                    btnDraw.disabled = (currentUserRole === 'guest');
                } else {
                    btnDraw.disabled = true;
                }
            }
        }
        
        function getSelectedPlayer(player) {
            const selectId = player === 'A' ? 'selectPlayerA' : 'selectPlayerB';
            const select = document.getElementById(selectId);
            if (!select) return null;
            
            const playerId = select.value;
            return players.find(p => p.id === playerId);
        }
        
        function updateChanceDisplay() {
            const chanceElement = document.getElementById('chance');
            if (!chanceElement) return;
            
            const playerA = getSelectedPlayer('A');
            const playerB = getSelectedPlayer('B');
            
            if (!playerA || !playerB) {
                chanceElement.textContent = 'Wybierz obu graczy aby zobaczyƒá szanse';
                return;
            }
            
            const expected = 1 / (1 + Math.pow(10, (playerB.elo - playerA.elo) / 400));
            const percent = Math.round(expected * 100);
            const displayName = formatPlayerName(playerA.name, true);
            chanceElement.textContent = `Szansa ${displayName}: ${percent}%`;
        }
        
        function updatePlayersList() {
            const listElement = document.getElementById('allPlayersList');
            if (!listElement) return;
            
            const sortedPlayers = [...players].sort((a, b) => b.elo - a.elo);
            
            if (sortedPlayers.length === 0) {
                listElement.innerHTML = '<div>Brak graczy. Dostƒôp Premium lub systemowy mo≈ºe dodaƒá pierwszego!</div>';
                return;
            }
            
            listElement.innerHTML = sortedPlayers.map((player, index) => {
                let button = '';
                
                if (currentUserRole === 'admin' || currentUserRole === 'dev') {
                    button = `<button class="delete-btn" onclick="deletePlayer('${player.id}')" title="Usu≈Ñ gracza">‚úï</button>`;
                } else {
                    button = `<div class="lock-btn" title="Tylko dostƒôp Premium mo≈ºe usuwaƒá">üîí</div>`;
                }
                
                const displayName = formatPlayerName(player.name, true);
                const emoji = player.elo > 1500 ? 'üìà' : player.elo < 1500 ? 'üìâ' : '‚ûñ';
                
                const codeDisplay = currentUserRole === 'dev' 
                    ? `<br><small>Kod: <span class="player-code">${player.code}</span></small>`
                    : '';
                
                return `
                <div class="player-item">
                    <div style="flex: 1;">
                        <strong>${index + 1}. <span class="player-name-truncate">${displayName}</span></strong><br>
                        <small>ELO: ${player.elo} ${emoji}${codeDisplay}</small>
                    </div>
                    ${button}
                </div>
                `;
            }).join('');
        }
        
        function updateHistory() {
            const historyElement = document.getElementById('historyList');
            if (!historyElement) return;
            
            if (history.length === 0) {
                historyElement.innerHTML = '-';
                return;
            }
            
            historyElement.innerHTML = history.map(match => {
                const playerADisplay = formatPlayerName(match.playerA, true);
                const playerBDisplay = formatPlayerName(match.playerB, true);
                
                const verifiedIcon = match.verified ? ' ‚úÖ' : '';
                
                return `
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #444; font-size: 14px;">
                    <div><strong>${playerADisplay} vs ${playerBDisplay}${verifiedIcon}</strong></div>
                    <div>Wynik: ${match.result === 'A' ? `üèÜ ${playerADisplay}` : match.result === 'B' ? `üèÜ ${playerBDisplay}` : 'ü§ù Remis'}</div>
                    <div>Zmiana: ${match.change > 0 ? '+' : ''}${match.change}</div>
                    <div style="font-size: 12px; color: #aaa;">${match.date}</div>
                </div>
                `;
            }).join('');
        }
        
        // ============================================
        // FUNKCJE GIER 501
        // ============================================
        
        function selectGameMode(mode) {
            if (mode === '501') {
                // Resetuj stan gry
                resetGameState();
                showPage('gameSetup');
            }
        }
        
        function showComingSoon() {
            alert('Ten tryb gry bƒôdzie dostƒôpny wkr√≥tce!');
        }
        
        function updateGamePlayerSelects() {
            const select1 = document.getElementById('gameSelectPlayer1');
            const select2 = document.getElementById('gameSelectPlayer2');
            
            if (!select1 || !select2) return;
            
            const current1 = select1.value;
            const current2 = select2.value;
            
            select1.innerHTML = '<option value="">Wybierz gracza</option>';
            select2.innerHTML = '<option value="">Wybierz gracza</option>';
            
            players.forEach(player => {
                const displayName = formatPlayerName(player.name, false); // Pe≈Çne nazwiska w grach
                const option = `<option value="${player.id}">${displayName} (${player.elo})</option>`;
                select1.innerHTML += option;
                select2.innerHTML += option;
            });
            
            if (current1 && players.some(p => p.id === current1)) select1.value = current1;
            if (current2 && players.some(p => p.id === current2)) select2.value = current2;
            
            updateGameSwapButton();
        }
        
        function swapGamePlayers() {
            const select1 = document.getElementById('gameSelectPlayer1');
            const select2 = document.getElementById('gameSelectPlayer2');
            const swapBtn = document.getElementById('gameSwapBtn');
            
            if (!select1 || !select2) return;
            
            const player1Id = select1.value;
            const player2Id = select2.value;
            
            if (!player1Id || !player2Id) {
                return;
            }
            
            if (player1Id === player2Id) {
                return;
            }
            
            const temp = player1Id;
            select1.value = player2Id;
            select2.value = temp;
            
            if (swapBtn) {
                swapBtn.style.transform = 'rotate(180deg)';
                swapBtn.style.transition = 'transform 0.3s';
                
                setTimeout(() => {
                    swapBtn.style.transform = 'rotate(0deg)';
                }, 300);
            }
        }
        
        function updateGameSwapButton() {
            const select1 = document.getElementById('gameSelectPlayer1');
            const select2 = document.getElementById('gameSelectPlayer2');
            const swapBtn = document.getElementById('gameSwapBtn');
            
            if (!select1 || !select2 || !swapBtn) return;
            
            const player1Id = select1.value;
            const player2Id = select2.value;
            
            if (player1Id && player2Id && player1Id !== player2Id) {
                swapBtn.disabled = false;
                swapBtn.title = "Zamie≈Ñ graczy miejscami";
            } else {
                swapBtn.disabled = true;
                swapBtn.title = "Wybierz r√≥≈ºnych graczy aby zamieniƒá";
            }
        }
        
        function start501Game() {
            const select1 = document.getElementById('gameSelectPlayer1');
            const select2 = document.getElementById('gameSelectPlayer2');
            
            if (!select1 || !select2) return;
            
            const player1Id = select1.value;
            const player2Id = select2.value;
            
            if (!player1Id || !player2Id) {
                alert('Wybierz obu graczy!');
                return;
            }
            
            if (player1Id === player2Id) {
                alert('Wybierz r√≥≈ºnych graczy!');
                return;
            }
            
            const player1 = players.find(p => p.id === player1Id);
            const player2 = players.find(p => p.id === player2Id);
            
            if (!player1 || !player2) {
                alert('B≈ÇƒÖd: Nie znaleziono graczy!');
                return;
            }
            
            // Zapisz graczy do gry
            currentGame.player1 = player1;
            currentGame.player2 = player2;
            currentGame.startingPlayer = 1;
            currentGame.currentPlayer = 1;
            currentGame.scores.player1 = 501;
            currentGame.scores.player2 = 501;
            currentGame.legs.player1 = 0;
            currentGame.legs.player2 = 0;
            currentGame.turns = [];
            currentGame.dartsThrown = 0;
            currentGame.gameOver = false;
            currentGame.winner = null;
            currentGame.gameId = 'game_' + Date.now();
            
            // Resetuj statystyki
            currentGame.stats = {
                player1: {
                    totalPoints: 0,
                    dartsThrown: 0,
                    average: 0,
                    highestCheckout: 0,
                    turns: 0
                },
                player2: {
                    totalPoints: 0,
                    dartsThrown: 0,
                    average: 0,
                    highestCheckout: 0,
                    turns: 0
                }
            };
            
            gameHistory = [];
            
            // Wy≈õwietl stronƒô gry
            showPage('game501');
            
            // Zaktualizuj interfejs gry
            updateGameUI();
        }
        
        function updateGameUI() {
            if (!currentGame.player1 || !currentGame.player2) return;
            
            // Aktualizuj nazwy graczy
            document.getElementById('player1Name').textContent = currentGame.player1.name;
            document.getElementById('player2Name').textContent = currentGame.player2.name;
            
            // Aktualizuj punkty
            document.getElementById('player1Points').textContent = currentGame.scores.player1;
            document.getElementById('player2Points').textContent = currentGame.scores.player2;
            
            // Aktualizuj statystyki
            document.getElementById('player1Legs').textContent = currentGame.legs.player1;
            document.getElementById('player2Legs').textContent = currentGame.legs.player2;
            
            // Oblicz ≈õrednie
            const avg1 = currentGame.stats.player1.dartsThrown > 0 
                ? (currentGame.stats.player1.totalPoints / currentGame.stats.player1.dartsThrown * 3).toFixed(2)
                : '0.00';
            const avg2 = currentGame.stats.player2.dartsThrown > 0 
                ? (currentGame.stats.player2.totalPoints / currentGame.stats.player2.dartsThrown * 3).toFixed(2)
                : '0.00';
            
            document.getElementById('player1Average').textContent = avg1;
            document.getElementById('player2Average').textContent = avg2;
            
            // Aktualizuj informacje o turze
            const currentPlayerName = currentGame.currentPlayer === 1 
                ? currentGame.player1.name 
                : currentGame.player2.name;
            
            document.getElementById('currentPlayerName').textContent = currentPlayerName;
            document.getElementById('dartsThrown').textContent = `${currentGame.dartsThrown}/3`;
            
            // Zaktualizuj aktywnego gracza
            document.getElementById('player1Score').classList.remove('active', 'winner');
            document.getElementById('player2Score').classList.remove('active', 'winner');
            
            if (!currentGame.gameOver) {
                if (currentGame.currentPlayer === 1) {
                    document.getElementById('player1Score').classList.add('active');
                } else {
                    document.getElementById('player2Score').classList.add('active');
                }
            } else {
                if (currentGame.winner === 1) {
                    document.getElementById('player1Score').classList.add('winner');
                } else if (currentGame.winner === 2) {
                    document.getElementById('player2Score').classList.add('winner');
                }
            }
            
            // Zaktualizuj przyciski mno≈ºnik√≥w
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.multiplier-btn')[currentMultiplier - 1].classList.add('active');
            
            // Oblicz sumƒô kolejki
            calculateTurnTotal();
            
            // Zaktualizuj historiƒô kolejek
            updateTurnsHistory();
            
            // Zaktualizuj wskaz√≥wki checkout
            updateCheckoutHints();
        }
        
        function setMultiplier(multiplier) {
            currentMultiplier = multiplier;
            updateGameUI();
            calculateTurnTotal();
        }
        
        function calculateTurnTotal() {
            const dart1 = parseInt(document.getElementById('dart1').value) || 0;
            const dart2 = parseInt(document.getElementById('dart2').value) || 0;
            const dart3 = parseInt(document.getElementById('dart3').value) || 0;
            
            const total = (dart1 + dart2 + dart3) * currentMultiplier;
            document.getElementById('turnTotal').textContent = total;
            
            // Oblicz nowy wynik
            const currentScore = currentGame.currentPlayer === 1 
                ? currentGame.scores.player1 
                : currentGame.scores.player2;
            
            const newScore = currentScore - total;
            document.getElementById('newScore').textContent = newScore >= 0 ? newScore : 'BUST!';
            
            if (newScore < 0) {
                document.getElementById('newScore').style.color = '#F44336';
            } else if (newScore === 0) {
                document.getElementById('newScore').style.color = '#4CAF50';
            } else {
                document.getElementById('newScore').style.color = '#4CAF50';
            }
            
            // Sprawd≈∫ czy mo≈ºna wys≈Çaƒá rzuty
            const submitBtn = document.getElementById('submitDartsBtn');
            if (submitBtn) {
                if (dart1 === 0 && dart2 === 0 && dart3 === 0) {
                    submitBtn.disabled = true;
                } else {
                    submitBtn.disabled = false;
                }
            }
        }
        
        function updateCheckoutHints() {
            const currentScore = currentGame.currentPlayer === 1 
                ? currentGame.scores.player1 
                : currentGame.scores.player2;
            
            let hint = '';
            
            if (currentScore <= 170) {
                // Podaj popularne checkouty
                if (currentScore === 170) hint = 'Checkout: T20 + T20 + Bull';
                else if (currentScore === 167) hint = 'Checkout: T20 + T19 + Bull';
                else if (currentScore === 164) hint = 'Checkout: T20 + T18 + Bull';
                else if (currentScore === 161) hint = 'Checkout: T20 + T17 + Bull';
                else if (currentScore === 160) hint = 'Checkout: T20 + T20 + D20';
                else if (currentScore === 158) hint = 'Checkout: T20 + T20 + D19';
                else if (currentScore === 120) hint = 'Checkout: T20 + T20 + D20 (lub T20 + 20 + D20)';
                else if (currentScore <= 40 && currentScore % 2 === 0) hint = `Checkout: D${currentScore / 2}`;
                else if (currentScore === 50) hint = 'Checkout: Bull';
                else if (currentScore === 25) hint = 'Checkout: Single Bull';
                else if (currentScore < 60) hint = 'Szukaj podw√≥jnego!';
            }
            
            document.getElementById('checkoutHint').textContent = hint;
        }
        
        function submitDarts() {
            const dart1 = parseInt(document.getElementById('dart1').value) || 0;
            const dart2 = parseInt(document.getElementById('dart2').value) || 0;
            const dart3 = parseInt(document.getElementById('dart3').value) || 0;
            
            // Sprawd≈∫ czy wszystkie rzuty sƒÖ puste
            if (dart1 === 0 && dart2 === 0 && dart3 === 0) {
                alert('Wprowad≈∫ punkty z przynajmniej jednego rzutu!');
                return;
            }
            
            const total = (dart1 + dart2 + dart3) * currentMultiplier;
            
            // Zapisz kolejkƒô
            const turn = {
                player: currentGame.currentPlayer,
                darts: [dart1 * currentMultiplier, dart2 * currentMultiplier, dart3 * currentMultiplier],
                total: total,
                timestamp: new Date()
            };
            
            // Sprawd≈∫ czy gracz nie przekroczy≈Ç wyniku
            const currentScore = currentGame.currentPlayer === 1 
                ? currentGame.scores.player1 
                : currentGame.scores.player2;
            
            const newScore = currentScore - total;
            
            if (newScore < 0 || (newScore === 1) || (newScore > 0 && newScore < 2)) {
                // Bust! Kolejka nie liczy siƒô
                turn.valid = false;
                turn.result = 'BUST';
                
                // Dodaj kolejkƒô do historii
                currentGame.turns.push(turn);
                gameHistory.push({...turn, playerName: currentGame.currentPlayer === 1 ? currentGame.player1.name : currentGame.player2.name});
                
                // Prze≈ÇƒÖcz gracza
                currentGame.currentPlayer = currentGame.currentPlayer === 1 ? 2 : 1;
                currentGame.dartsThrown = 0;
                
                // Wyczy≈õƒá pola
                clearDartInputs();
                
                // Zaktualizuj UI
                updateGameUI();
                
                // Poka≈º informacjƒô o bust
                alert(`BUST! ${currentGame.currentPlayer === 1 ? currentGame.player2.name : currentGame.player1.name} przekroczy≈Ç wynik. Kolejka przechodzi do przeciwnika.`);
                return;
            }
            
            if (newScore === 0) {
                // Sprawd≈∫ czy ostatni rzut by≈Ç podw√≥jnym
                const lastDart = dart3 * currentMultiplier;
                const isDoubleFinish = lastDart % 2 === 0 && lastDart <= 40 && lastDart > 0;
                const isBull = lastDart === 50 || lastDart === 25;
                
                if (isDoubleFinish || isBull || (dart1 * currentMultiplier === 0 && dart2 * currentMultiplier === 0 && (isDoubleFinish || isBull))) {
                    // Wygrana! Gracz osiƒÖgnƒÖ≈Ç 0 z podw√≥jnym finiszem
                    turn.valid = true;
                    turn.result = 'WIN';
                    
                    // Dodaj kolejkƒô do historii
                    currentGame.turns.push(turn);
                    gameHistory.push({...turn, playerName: currentGame.currentPlayer === 1 ? currentGame.player1.name : currentGame.player2.name});
                    
                    // Zaktualizuj statystyki
                    if (currentGame.currentPlayer === 1) {
                        currentGame.legs.player1++;
                        currentGame.stats.player1.turns++;
                        currentGame.stats.player1.totalPoints += total;
                        currentGame.stats.player1.dartsThrown += 3;
                        if (total > currentGame.stats.player1.highestCheckout) {
                            currentGame.stats.player1.highestCheckout = total;
                        }
                    } else {
                        currentGame.legs.player2++;
                        currentGame.stats.player2.turns++;
                        currentGame.stats.player2.totalPoints += total;
                        currentGame.stats.player2.dartsThrown += 3;
                        if (total > currentGame.stats.player2.highestCheckout) {
                            currentGame.stats.player2.highestCheckout = total;
                        }
                    }
                    
                    // Ustaw zwyciƒôzcƒô
                    currentGame.gameOver = true;
                    currentGame.winner = currentGame.currentPlayer;
                    
                    // Wyczy≈õƒá pola
                    clearDartInputs();
                    
                    // Zaktualizuj UI
                    updateGameUI();
                    
                    // Przejd≈∫ do wynik√≥w po kr√≥tkim op√≥≈∫nieniu
                    setTimeout(() => {
                        showGameResults();
                    }, 1500);
                    
                    return;
                } else {
                    // Bust! Ostatni rzut nie by≈Ç podw√≥jnym
                    turn.valid = false;
                    turn.result = 'BUST (no double)';
                    
                    // Dodaj kolejkƒô do historii
                    currentGame.turns.push(turn);
                    gameHistory.push({...turn, playerName: currentGame.currentPlayer === 1 ? currentGame.player1.name : currentGame.player2.name});
                    
                    // Prze≈ÇƒÖcz gracza
                    currentGame.currentPlayer = currentGame.currentPlayer === 1 ? 2 : 1;
                    currentGame.dartsThrown = 0;
                    
                    // Wyczy≈õƒá pola
                    clearDartInputs();
                    
                    // Zaktualizuj UI
                    updateGameUI();
                    
                    // Poka≈º informacjƒô o bust
                    alert('BUST! Ostatni rzut musi byƒá podw√≥jnym (lub bulleye) aby wygraƒá!');
                    return;
                }
            }
            
            // Normalna kolejka
            turn.valid = true;
            turn.result = 'OK';
            
            // Dodaj kolejkƒô do historii
            currentGame.turns.push(turn);
            gameHistory.push({...turn, playerName: currentGame.currentPlayer === 1 ? currentGame.player1.name : currentGame.player2.name});
            
            // Zaktualizuj wynik
            if (currentGame.currentPlayer === 1) {
                currentGame.scores.player1 = newScore;
                currentGame.stats.player1.turns++;
                currentGame.stats.player1.totalPoints += total;
                currentGame.stats.player1.dartsThrown += 3;
            } else {
                currentGame.scores.player2 = newScore;
                currentGame.stats.player2.turns++;
                currentGame.stats.player2.totalPoints += total;
                currentGame.stats.player2.dartsThrown += 3;
            }
            
            // Prze≈ÇƒÖcz gracza
            currentGame.currentPlayer = currentGame.currentPlayer === 1 ? 2 : 1;
            currentGame.dartsThrown = 0;
            
            // Wyczy≈õƒá pola
            clearDartInputs();
            
            // Zaktualizuj UI
            updateGameUI();
        }
        
        function clearDartInputs() {
            document.getElementById('dart1').value = '';
            document.getElementById('dart2').value = '';
            document.getElementById('dart3').value = '';
            currentMultiplier = 1;
            calculateTurnTotal();
        }
        
        function undoLastTurn() {
            if (currentGame.turns.length === 0) {
                alert('Brak kolejek do cofniƒôcia!');
                return;
            }
            
            if (currentGame.gameOver) {
                alert('Nie mo≈ºna cofnƒÖƒá po zako≈Ñczeniu gry!');
                return;
            }
            
            // Pobierz ostatniƒÖ kolejkƒô
            const lastTurn = currentGame.turns.pop();
            gameHistory.pop();
            
            if (!lastTurn) return;
            
            // Cofnij wynik
            if (lastTurn.player === 1) {
                if (lastTurn.valid && lastTurn.result !== 'WIN') {
                    currentGame.scores.player1 += lastTurn.total;
                }
                // Cofnij statystyki
                currentGame.stats.player1.turns--;
                currentGame.stats.player1.totalPoints -= lastTurn.total;
                currentGame.stats.player1.dartsThrown -= 3;
            } else {
                if (lastTurn.valid && lastTurn.result !== 'WIN') {
                    currentGame.scores.player2 += lastTurn.total;
                }
                // Cofnij statystyki
                currentGame.stats.player2.turns--;
                currentGame.stats.player2.totalPoints -= lastTurn.total;
                currentGame.stats.player2.dartsThrown -= 3;
            }
            
            // Je≈õli by≈Ça to wygrana, cofnij legi
            if (lastTurn.result === 'WIN') {
                if (lastTurn.player === 1) {
                    currentGame.legs.player1--;
                    currentGame.gameOver = false;
                    currentGame.winner = null;
                } else {
                    currentGame.legs.player2--;
                    currentGame.gameOver = false;
                    currentGame.winner = null;
                }
            }
            
            // Przywr√≥ƒá poprzedniego gracza
            currentGame.currentPlayer = lastTurn.player;
            
            // Zaktualizuj UI
            updateGameUI();
            
            // Aktualizuj przycisk cofania
            updateUndoButton();
        }
        
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                undoBtn.disabled = currentGame.turns.length === 0 || currentGame.gameOver;
            }
        }
        
        function updateTurnsHistory() {
            const historyElement = document.getElementById('turnsHistory');
            if (!historyElement) return;
            
            if (gameHistory.length === 0) {
                historyElement.innerHTML = '<div style="text-align: center; color: #777; padding: 20px;">Brak kolejek</div>';
                return;
            }
            
            let historyHTML = '';
            
            // Poka≈º ostatnie 10 kolejek
            const recentTurns = gameHistory.slice(-10).reverse();
            
            recentTurns.forEach(turn => {
                const dartsHTML = turn.darts.map(dart => 
                    `<span class="dart-score">${dart > 0 ? dart : '0'}</span>`
                ).join(' ');
                
                const resultClass = turn.result === 'WIN' ? 'style="color: #4CAF50; font-weight: bold;"' : 
                                  turn.result === 'BUST' ? 'style="color: #F44336;"' : 
                                  '';
                
                historyHTML += `
                    <div class="turn-item">
                        <div>
                            <strong>${turn.playerName}</strong><br>
                            ${dartsHTML}
                        </div>
                        <div>
                            <span ${resultClass}>${turn.total}</span><br>
                            <small style="color: #aaa;">${turn.result || 'OK'}</small>
                        </div>
                    </div>
                `;
            });
            
            historyElement.innerHTML = historyHTML;
            
            // Aktualizuj przycisk cofania
            updateUndoButton();
        }
        
        function showGameResults() {
            showPage('gameResults');
            
            // Aktualizuj wyniki
            document.getElementById('winnerName').textContent = currentGame.winner === 1 
                ? currentGame.player1.name 
                : currentGame.player2.name;
            
            document.getElementById('resultsPlayer1Name').textContent = currentGame.player1.name;
            document.getElementById('resultsPlayer2Name').textContent = currentGame.player2.name;
            
            document.getElementById('resultsPlayer1Score').textContent = currentGame.scores.player1;
            document.getElementById('resultsPlayer2Score').textContent = currentGame.scores.player2;
            
            document.getElementById('resultsPlayer1Legs').textContent = currentGame.legs.player1;
            document.getElementById('resultsPlayer2Legs').textContent = currentGame.legs.player2;
            
            const avg1 = currentGame.stats.player1.dartsThrown > 0 
                ? (currentGame.stats.player1.totalPoints / currentGame.stats.player1.dartsThrown * 3).toFixed(2)
                : '0.00';
            const avg2 = currentGame.stats.player2.dartsThrown > 0 
                ? (currentGame.stats.player2.totalPoints / currentGame.stats.player2.dartsThrown * 3).toFixed(2)
                : '0.00';
            
            document.getElementById('resultsPlayer1Average').textContent = avg1;
            document.getElementById('resultsPlayer2Average').textContent = avg2;
            
            document.getElementById('resultsPlayer1Turns').textContent = currentGame.stats.player1.turns;
            document.getElementById('resultsPlayer2Turns').textContent = currentGame.stats.player2.turns;
            
            document.getElementById('resultsPlayer1Checkout').textContent = currentGame.stats.player1.highestCheckout;
            document.getElementById('resultsPlayer2Checkout').textContent = currentGame.stats.player2.highestCheckout;
        }
        
        function updateEloAuto() {
            if (!currentGame.player1 || !currentGame.player2 || !currentGame.winner) {
                alert('B≈ÇƒÖd: Brak danych gry!');
                return;
            }
            
            // Przygotuj mecz do kalkulatora ELO
            const scoreA = currentGame.winner === 1 ? 1 : 0; // 1 = gracz 1 wygrywa, 0 = gracz 2 wygrywa
            
            pendingMatch = {
                playerA: currentGame.player1,
                playerB: currentGame.player2,
                scoreA: scoreA
            };
            
            // Poka≈º modal z kodem dla pierwszego gracza
            showCodeModal('A', currentGame.player1.name);
        }
        
        function updateEloManual() {
            // Przejd≈∫ do kalkulatora ELO z wybranymi graczami
            showPage('elo');
            
            // Ustaw wybranych graczy w selectach
            setTimeout(() => {
                const selectA = document.getElementById('selectPlayerA');
                const selectB = document.getElementById('selectPlayerB');
                
                if (selectA && selectB && currentGame.player1 && currentGame.player2) {
                    selectA.value = currentGame.player1.id;
                    selectB.value = currentGame.player2.id;
                    
                    // Zaktualizuj interfejs
                    onPlayerSelectChange();
                    
                    // Poka≈º komunikat
                    alert('Przejd≈∫ teraz do kalkulatora ELO i wybierz wynik meczu rƒôcznie.');
                }
            }, 500);
        }
        
        function playAgain() {
            // Zachowaj graczy, resetuj resztƒô
            const player1 = currentGame.player1;
            const player2 = currentGame.player2;
            
            resetGameState();
            
            currentGame.player1 = player1;
            currentGame.player2 = player2;
            
            // Przejd≈∫ do gry
            showPage('game501');
            updateGameUI();
        }
        
        function resetGameState() {
            currentGame = {
                mode: '501',
                player1: null,
                player2: null,
                startingPlayer: 1,
                currentPlayer: 1,
                scores: {
                    player1: 501,
                    player2: 501
                },
                legs: {
                    player1: 0,
                    player2: 0
                },
                turns: [],
                dartsThrown: 0,
                gameOver: false,
                winner: null,
                gameId: null,
                stats: {
                    player1: {
                        totalPoints: 0,
                        dartsThrown: 0,
                        average: 0,
                        highestCheckout: 0,
                        turns: 0
                    },
                    player2: {
                        totalPoints: 0,
                        dartsThrown: 0,
                        average: 0,
                        highestCheckout: 0,
                        turns: 0
                    }
                }
            };
            
            currentMultiplier = 1;
            gameHistory = [];
        }
        
        // ============================================
        // FUNKCJE Z DRUGIEGO KODU (SEZONY) - POPRAWIONE
        // ============================================
        
        // Funkcja do generowania statusu sezonu - POPRAWIONA
        function generateSeasonStatus() {
            const seasonStatusElement = document.getElementById('seasonStatus');
            if (!seasonStatusElement) return;
            
            if (!currentSeason) {
                seasonStatusElement.className = 'season-status off-season';
                seasonStatusElement.innerHTML = `
                    <div class="season-name">üèÅ OKRES POZASEZONOWY</div>
                    <div class="season-dates">Brak aktywnych sezon√≥w</div>
                    <div class="season-days-left">Mo≈ºesz przygotowaƒá nowy sezon</div>
                `;
                return;
            }
            
            const now = new Date();
            const startDate = new Date(currentSeason.startDate);
            const endDate = new Date(currentSeason.endDate);
            
            // Resetuj godziny, ≈ºeby por√≥wnywaƒá tylko daty
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const seasonStart = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const seasonEnd = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            
            // Oblicz dni do ko≈Ñca (na podstawie pe≈Çnych dat z godzinami)
            const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            
            if (today < seasonStart) {
                // Sezon jeszcze siƒô nie zaczƒÖ≈Ç
                const daysToStart = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                seasonStatusElement.className = 'season-status off-season';
                seasonStatusElement.innerHTML = `
                    <div class="season-name">‚è≥ SEZON WKR√ìTCE</div>
                    <div class="season-dates">${currentSeason.name || `Sezon ${currentSeason.seasonNumber}`}</div>
                    <div class="season-dates">Rozpocznie siƒô: ${formatDate(startDate)}</div>
                    <div class="season-days-left">Za ${daysToStart} ${daysToStart === 1 ? 'dzie≈Ñ' : 'dni'}</div>
                `;
            } else if (today > seasonEnd) {
                // Sezon ju≈º siƒô zako≈Ñczy≈Ç
                seasonStatusElement.className = 'season-status ended';
                seasonStatusElement.innerHTML = `
                    <div class="season-name">üèÅ SEZON ZAKO≈ÉCZONY</div>
                    <div class="season-dates">${currentSeason.name || `Sezon ${currentSeason.seasonNumber}`}</div>
                    <div class="season-dates">${formatDate(startDate)} - ${formatDate(endDate)}</div>
                    <div class="season-days-left">Zako≈Ñczy≈Ç siƒô ${Math.abs(daysLeft)} ${Math.abs(daysLeft) === 1 ? 'dzie≈Ñ' : 'dni'} temu</div>
                `;
            } else {
                // Sezon trwa!
                seasonStatusElement.className = 'season-status running';
                seasonStatusElement.innerHTML = `
                    <div class="season-name">üèÜ TRWA SEZON!</div>
                    <div class="season-dates">${currentSeason.name || `Sezon ${currentSeason.seasonNumber}`}</div>
                    <div class="season-dates">${formatDate(startDate)} - ${formatDate(endDate)}</div>
                    <div class="season-days-left">Pozosta≈Ço ${daysLeft} ${daysLeft === 1 ? 'dzie≈Ñ' : 'dni'}</div>
                `;
            }
        }
        
        // Funkcja do generowania strony rang
        function generateRanksPage() {
            const ranksListElement = document.getElementById('ranksList');
            if (!ranksListElement) return;
            
            // U≈ºyj prog√≥w z sezonu je≈õli istnieje, domy≈õlne je≈õli nie
            const rankThresholds = currentSeason ? currentSeason.rankThresholds : {};
            
            // Grupuj graczy wed≈Çug rang
            const playersByRank = {};
            ranks.forEach(rank => {
                const minElo = rankThresholds[rank.id] || rank.minElo;
                const maxElo = rankThresholds[rank.id + 1] ? rankThresholds[rank.id + 1] - 1 : rank.maxElo;
                
                playersByRank[rank.id] = players.filter(player => 
                    player.elo >= minElo && player.elo <= maxElo
                );
            });
            
            // Sortuj graczy w ka≈ºdej randze malejƒÖco wed≈Çug ELO
            ranks.forEach(rank => {
                playersByRank[rank.id].sort((a, b) => b.elo - a.elo);
            });
            
            // Generuj HTML dla ka≈ºdej rangi
            let ranksHTML = '';
            
            ranks.forEach(rank => {
                const playersInRank = playersByRank[rank.id];
                const playersCount = playersInRank.length;
                
                // Pobierz progi dla tej rangi (z sezonu lub domy≈õlne)
                const minElo = rankThresholds[rank.id] || rank.minElo;
                let maxElo = rank.maxElo;
                
                if (rank.id < 9) {
                    maxElo = rankThresholds[rank.id + 1] ? rankThresholds[rank.id + 1] - 1 : rank.maxElo;
                }
                
                // Formatowanie przedzia≈Çu ELO
                let eloRange = '';
                if (rank.id === 1) {
                    eloRange = `Wymagane ELO: ${minElo}-${maxElo}`;
                } else if (rank.id === ranks.length) {
                    eloRange = `Wymagane ELO: ${minElo}+`;
                } else {
                    eloRange = `Wymagane ELO: ${minElo}`;
                }
                
                // HTML dla graczy w randze
                let playersHTML = '';
                if (playersCount > 0) {
                    playersHTML = '<div class="players-on-rank">';
                    const playersToShow = playersInRank.slice(0, 8);
                    
                    playersToShow.forEach(player => {
                        const displayName = formatPlayerName(player.name, true);
                        playersHTML += `
                            <div class="player-on-rank" title="${displayName} - ELO: ${player.elo}">
                                <span class="player-name-truncate">${displayName}</span>
                                <span class="player-on-rank-elo">${player.elo}</span>
                            </div>
                        `;
                    });
                    
                    if (playersCount > 8) {
                        playersHTML += `<div class="player-on-rank" style="background: #444;">+${playersCount - 8} wiƒôcej</div>`;
                    }
                    
                    playersHTML += '</div>';
                } else {
                    playersHTML = '<div class="no-players">Brak graczy na tej randze</div>';
                }
                
                // Dodaj specjalnƒÖ klasƒô dla rang 1 i 9
                const rankClass = rank.id === 1 ? 'rank-1' : (rank.id === 9 ? 'rank-9' : '');
                
                // Generuj HTML dla rangi
                ranksHTML += `
                    <div class="rank-container ${rankClass}">
                        <div class="rank-number">${rank.id}</div>
                        
                        <div class="rank-image-container">
                            <div style="color: #777; font-size: 12px; text-align: center; padding: 10px;">
                                Ranga ${rank.id}<br>
                                (pixel art)
                            </div>
                        </div>
                        
                        <div class="rank-info">
                            <div class="rank-name">${rank.name}</div>
                            <div class="rank-elo">${eloRange}</div>
                            <div class="rank-elo" style="margin-top: 5px;">Graczy: ${playersCount}</div>
                        </div>
                        
                        <div class="rank-players">
                            <div style="font-size: 13px; color: #aaa; margin-bottom: 8px;">Gracze na tej randze:</div>
                            ${playersHTML}
                        </div>
                    </div>
                `;
            });
            
            ranksListElement.innerHTML = ranksHTML;
            
            // Aktualizuj przyciski sezonu
            updateNewSeasonButton();
            updateEndSeasonButton();
        }
        
        // Aktualizuj przycisk nowego sezonu
        function updateNewSeasonButton() {
            const newSeasonBtn = document.getElementById('newSeasonBtn');
            if (!newSeasonBtn) return;
            
            // Poka≈º tylko dla admina i deva
            if (currentUserRole === 'admin' || currentUserRole === 'dev') {
                newSeasonBtn.classList.remove('hidden');
                
                // Sprawd≈∫ czy mo≈ºna rozpoczƒÖƒá nowy sezon
                const now = new Date();
                let canStartNewSeason = true;
                
                if (currentSeason) {
                    const endDate = new Date(currentSeason.endDate);
                    // DEV te≈º NIE MO≈ªE rozpoczynaƒá nowego sezonu podczas trwania obecnego
                    if (now <= endDate) {
                        canStartNewSeason = false;
                        newSeasonBtn.disabled = true;
                        newSeasonBtn.classList.add('disabled');
                        newSeasonBtn.innerHTML = 'üö´ Sezon w trakcie';
                    } else {
                        newSeasonBtn.disabled = false;
                        newSeasonBtn.classList.remove('disabled');
                        newSeasonBtn.innerHTML = 'üöÄ Zacznij nowy sezon';
                    }
                } else {
                    newSeasonBtn.disabled = false;
                    newSeasonBtn.classList.remove('disabled');
                    newSeasonBtn.innerHTML = 'üöÄ Zacznij nowy sezon';
                }
            } else {
                newSeasonBtn.classList.add('hidden');
            }
        }
        
        // Aktualizuj przycisk zako≈Ñczenia sezonu (tylko dla DEV) - POPRAWIONA
        function updateEndSeasonButton() {
            const endSeasonBtn = document.getElementById('endSeasonBtn');
            if (!endSeasonBtn) return;
            
            // Poka≈º tylko dla deva
            if (currentUserRole === 'dev') {
                endSeasonBtn.classList.remove('hidden');
                
                // Sprawd≈∫ czy mo≈ºna zako≈Ñczyƒá sezon
                if (currentSeason) {
                    const now = new Date();
                    const startDate = new Date(currentSeason.startDate);
                    
                    // Resetuj godziny, ≈ºeby por√≥wnywaƒá tylko daty
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const seasonStart = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    
                    // DEV mo≈ºe zako≈Ñczyƒá sezon tylko je≈õli siƒô ju≈º rozpoczƒÖ≈Ç (dzisiaj lub wcze≈õniej)
                    if (today >= seasonStart) {
                        endSeasonBtn.disabled = false;
                        endSeasonBtn.classList.remove('disabled');
                        endSeasonBtn.innerHTML = '‚èπÔ∏è Zako≈Ñcz sezon (SYSTEM)';
                    } else {
                        endSeasonBtn.disabled = true;
                        endSeasonBtn.classList.add('disabled');
                        endSeasonBtn.innerHTML = '‚è≥ Sezon jeszcze siƒô nie rozpoczƒÖ≈Ç';
                    }
                } else {
                    endSeasonBtn.disabled = true;
                    endSeasonBtn.classList.add('disabled');
                    endSeasonBtn.innerHTML = 'üö´ Brak aktywnego sezonu';
                }
            } else {
                endSeasonBtn.classList.add('hidden');
            }
        }
        
        // Funkcja do generowania strony osiƒÖgniƒôƒá
        function generateAchievementsPage() {
            const achievementsListElement = document.getElementById('achievementsList');
            if (!achievementsListElement) return;
            
            let achievementsHTML = '';
            
            achievements.forEach(achievement => {
                const isNoneAchievement = achievement.id === 1;
                
                achievementsHTML += `
                    <div class="achievement-container" style="${isNoneAchievement ? 'border-left-color: #666;' : ''}">
                        <div class="achievement-image-container" style="${isNoneAchievement ? 'border-color: #666;' : ''}">
                            <div style="color: #777; font-size: 11px; text-align: center; padding: 5px;">
                                OsiƒÖgniƒôcie ${achievement.id}
                            </div>
                        </div>
                        
                        <div class="achievement-text-container">
                            <div class="achievement-name" style="${isNoneAchievement ? 'color: #666;' : ''}">${achievement.name}</div>
                            <div class="achievement-description">
                                ${achievement.description}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            achievementsListElement.innerHTML = achievementsHTML;
        }
        
        // Funkcja do generowania strony wcze≈õniejszych sezon√≥w
        async function generateSeasonsPage() {
            const seasonsListElement = document.getElementById('seasonsList');
            if (!seasonsListElement) return;
            
            // Za≈Çaduj sezony z Firebase
            await loadPreviousSeasons();
            
            if (previousSeasons.length === 0) {
                seasonsListElement.innerHTML = `
                    <div class="season-container">
                        <div class="season-info">
                            <div class="season-name-in-list">Brak wcze≈õniejszych sezon√≥w</div>
                            <div class="season-details">Jeszcze nie rozegrano ≈ºadnego sezonu.</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let seasonsHTML = '';
            
            previousSeasons.forEach(season => {
                // Oblicz d≈Çugo≈õƒá sezonu w dniach
                const startDate = new Date(season.startDate);
                const endDate = new Date(season.endDate);
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                
                seasonsHTML += `
                    <div class="season-container">
                        <div class="season-info">
                            <div class="season-name-in-list">${season.name || `Sezon ${season.seasonNumber}`}</div>
                            <div class="season-details">
                                <strong>Okres:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}<br>
                                <strong>D≈Çugo≈õƒá:</strong> ${days} dni<br>
                                <strong>Uczestnik√≥w:</strong> ${season.participants || 0}<br>
                                <strong>Rozegrane mecze:</strong> ${season.matchesPlayed || 0}
                            </div>
                            
                            ${season.podium ? `
                            <div class="season-podium">
                                <strong>üèÜ Podium:</strong>
                                ${season.podium.map((player, index) => `
                                    <div class="podium-item">
                                        <div class="podium-place podium-place-${index + 1}">${index + 1}</div>
                                        <div>
                                            <strong>${player.name}</strong><br>
                                            <small>ELO: ${player.elo} | ${player.achievement || 'Brak osiƒÖgniƒôcia'}</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            seasonsListElement.innerHTML = seasonsHTML;
        }
        
        // Funkcja do generowania formularza nowego sezonu - POPRAWIONA
        function generateNewSeasonForm() {
            const eloThresholdsElement = document.getElementById('eloThresholds');
            if (!eloThresholdsElement) return;
            
            let thresholdsHTML = '';
            
            // Dla rang 1-8 (ranga 9 jest od ostatniego progu)
            for (let i = 1; i <= 8; i++) {
                const rank = ranks.find(r => r.id === i);
                if (!rank) continue;
                
                thresholdsHTML += `
                    <div class="elo-threshold-item">
                        <label>${rank.name} (Ranga ${i}):</label>
                        <input type="number" 
                               id="rankThreshold${i}" 
                               class="rank-threshold-input"
                               min="${i === 1 ? 0 : 1}" 
                               value="${rank.minElo}"
                               onchange="validateThresholds()">
                        <small style="color: #aaa; font-size: 12px;">Minimalne ELO</small>
                    </div>
                `;
            }
            
            // Dla rangi 9 (ostatniej)
            thresholdsHTML += `
                <div class="elo-threshold-item">
                    <label>${ranks[8].name} (Ranga 9):</label>
                    <input type="number" 
                           id="rankThreshold9" 
                           class="rank-threshold-input"
                           min="1" 
                           value="${ranks[8].minElo}"
                           onchange="validateThresholds()">
                    <small style="color: #aaa; font-size: 12px;">Minimalne ELO</small>
                </div>
            `;
            
            eloThresholdsElement.innerHTML = thresholdsHTML;
            
            // Ustaw minimalne daty
            const today = new Date().toISOString().split('T')[0];
            const startDateInput = document.getElementById('seasonStartDate');
            const endDateInput = document.getElementById('seasonEndDate');
            
            if (startDateInput) {
                startDateInput.min = today;
                if (!startDateInput.value) {
                    // Ustaw domy≈õlnie dzisiejszƒÖ datƒô
                    startDateInput.value = today;
                }
            }
            
            if (endDateInput) {
                endDateInput.min = today;
                if (!endDateInput.value) {
                    // Ustaw domy≈õlnie datƒô za 30 dni
                    const defaultEndDate = new Date();
                    defaultEndDate.setDate(defaultEndDate.getDate() + 30);
                    endDateInput.value = defaultEndDate.toISOString().split('T')[0];
                }
            }
            
            validateThresholds();
            validateSeasonDates();
        }
        
        // Walidacja prog√≥w ELO
        function validateThresholds() {
            let isValid = true;
            let previousValue = 0;
            
            for (let i = 1; i <= 9; i++) {
                const input = document.getElementById(`rankThreshold${i}`);
                if (!input) continue;
                
                const value = parseInt(input.value) || 0;
                
                if (i === 1) {
                    // Ranga 1 musi mieƒá minElo >= 0
                    if (value < 0) {
                        input.style.borderColor = '#f44336';
                        isValid = false;
                    } else {
                        input.style.borderColor = '#444';
                    }
                } else {
                    // Ka≈ºda kolejna ranga musi mieƒá wy≈ºszy pr√≥g ni≈º poprzednia
                    if (value <= previousValue) {
                        input.style.borderColor = '#f44336';
                        isValid = false;
                    } else {
                        input.style.borderColor = '#444';
                    }
                }
                
                previousValue = value;
            }
            
            return isValid;
        }
        
        // Walidacja dat sezonu - POPRAWIONA
        function validateSeasonDates() {
            const startDateInput = document.getElementById('seasonStartDate');
            const endDateInput = document.getElementById('seasonEndDate');
            const createBtn = document.getElementById('createSeasonBtn');
            
            if (!startDateInput || !endDateInput || !createBtn) return;
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            // Ustaw minimalnƒÖ datƒô ko≈Ñca na dzie≈Ñ po starcie
            if (startDateInput.value) {
                const minEndDate = new Date(startDate);
                minEndDate.setDate(minEndDate.getDate() + 1);
                const minEndDateStr = minEndDate.toISOString().split('T')[0];
                if (endDateInput.min !== minEndDateStr) {
                    endDateInput.min = minEndDateStr;
                }
            }
            
            // Sprawd≈∫ czy daty sƒÖ poprawne
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Resetuj godziny do 00:00
            
            // Start mo≈ºe byƒá dzisiaj lub w przysz≈Ço≈õci
            const startDateOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            
            const isValid = startDateOnly >= now && 
                           endDate > startDate && 
                           validateThresholds();
            
            createBtn.disabled = !isValid;
            
            return isValid;
        }
        
        // Rozpocznij nowy sezon - POPRAWIONA
        async function createNewSeason() {
            if (!db) {
                alert('Brak po≈ÇƒÖczenia z Firebase!');
                return;
            }
            
            if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
                alert('Tylko administrator mo≈ºe rozpoczƒÖƒá nowy sezon!');
                return;
            }
            
            // Sprawd≈∫ czy mo≈ºna rozpoczƒÖƒá nowy sezon - DEV te≈º nie mo≈ºe podczas sezonu
            const now = new Date();
            if (currentSeason) {
                const endDate = new Date(currentSeason.endDate);
                if (now <= endDate) {
                    alert('Nie mo≈ºna rozpoczƒÖƒá nowego sezonu podczas trwania obecnego!');
                    return;
                }
            }
            
            // Pobierz warto≈õci z formularza
            const rankThresholds = {};
            for (let i = 1; i <= 9; i++) {
                const input = document.getElementById(`rankThreshold${i}`);
                if (input) {
                    rankThresholds[i] = parseInt(input.value) || 0;
                }
            }
            
            const startDate = document.getElementById('seasonStartDate').value;
            const endDate = document.getElementById('seasonEndDate').value;
            const seasonName = document.getElementById('seasonName').value.trim();
            
            // Walidacja
            if (!startDate || !endDate) {
                alert('Wybierz datƒô poczƒÖtku i ko≈Ñca sezonu!');
                return;
            }
            
            if (!validateThresholds()) {
                alert('Progi ELO muszƒÖ rosnƒÖƒá dla ka≈ºdej kolejnej rangi!');
                return;
            }
            
            // Pobierz numer nowego sezonu - POPRAWIONE
            let seasonNumber = 1;
            try {
                // Pobierz wszystkie sezony aby znale≈∫ƒá najwy≈ºszy numer
                const seasonsSnapshot = await db.collection('seasons').get();
                let maxSeasonNumber = 0;
                
                seasonsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.seasonNumber > maxSeasonNumber) {
                        maxSeasonNumber = data.seasonNumber;
                    }
                });
                
                if (maxSeasonNumber > 0) {
                    seasonNumber = maxSeasonNumber + 1;
                }
            } catch (error) {
                console.error("B≈ÇƒÖd pobierania numeru sezonu:", error);
            }
            
            // Przygotuj dane sezonu
            const seasonData = {
                seasonNumber: seasonNumber,
                name: seasonName || `Sezon ${seasonNumber} ${new Date().getFullYear()}/${new Date().getFullYear() + 1}`,
                startDate: startDate,
                endDate: endDate,
                rankThresholds: rankThresholds,
                status: 'pending', // pending, running, ended
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUserRole,
                participants: players.length,
                matchesPlayed: 0
            };
            
            try {
                // Utw√≥rz unikalny ID dla sezonu
                const seasonId = `season_${seasonNumber}`;
                
                // Zapisz sezon w Firebase z unikalnym ID
                await db.collection('seasons').doc(seasonId).set(seasonData);
                
                // Ustaw jako bie≈ºƒÖcy sezon
                await db.collection('system').doc('currentSeason').set({
                    seasonId: seasonId,
                    seasonNumber: seasonNumber,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`‚úÖ Rozpoczƒôto nowy sezon: ${seasonData.name}\nNumer sezonu: ${seasonNumber}`);
                
                // Prze≈Çaduj dane
                await loadCurrentSeason();
                showPage('ranks');
                
            } catch (error) {
                console.error('B≈ÇƒÖd tworzenia sezonu:', error);
                alert('B≈ÇƒÖd tworzenia sezonu: ' + error.message);
            }
        }
        
        // Funkcja do zako≈Ñczenia sezonu przez DEV - POPRAWIONA
        async function endSeasonDev() {
            if (currentUserRole !== 'dev') {
                alert('Tylko dostƒôp systemowy mo≈ºe zako≈Ñczyƒá sezon!');
                return;
            }
            
            if (!currentSeason) {
                alert('Brak aktywnego sezonu do zako≈Ñczenia!');
                return;
            }
            
            if (!confirm('Czy na pewno chcesz ZAKO≈ÉCZYƒÜ aktualny sezon?\n\n‚ö†Ô∏è Ta operacja jest nieodwracalna:\n- Zresetuje ELO wszystkich graczy do 1500\n- Utworzy archiwum sezonu\n- Rozliczy osiƒÖgniƒôcia')) {
                return;
            }
            
            try {
                // Oblicz podium i osiƒÖgniƒôcia
                const sortedPlayers = players.sort((a, b) => b.elo - a.elo);
                const podium = sortedPlayers.slice(0, 3).map((player, index) => ({
                    name: player.name,
                    elo: player.elo,
                    achievement: getAchievementForPosition(index + 1, player.elo)
                }));
                
                // Zresetuj ELO wszystkich graczy do 1500
                const batch = db.batch();
                const playersSnapshot = await db.collection('players').get();
                
                playersSnapshot.forEach(doc => {
                    batch.update(doc.ref, { elo: 1500 });
                });
                
                // Aktualizuj dane sezonu - U≈ªYJ UPDATE zamiast SET
                const seasonRef = db.collection('seasons').doc(currentSeason.id);
                
                // Przygotuj tylko pola do aktualizacji
                const updates = {
                    status: 'ended',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: players.length,
                    podium: podium,
                    finalEloStats: players.map(p => ({ name: p.name, finalElo: p.elo })),
                    matchesPlayed: history.length,
                    endedBy: 'dev',
                    endedManually: true
                };
                
                // U≈ºyj update() zamiast set() - to aktualizuje tylko wybrane pola
                batch.update(seasonRef, updates);
                
                // Usu≈Ñ bie≈ºƒÖcy sezon z systemu
                const currentSeasonRef = db.collection('system').doc('currentSeason');
                batch.delete(currentSeasonRef);
                
                await batch.commit();
                
                alert('‚úÖ Sezon zosta≈Ç zako≈Ñczony!\nELO wszystkich graczy zresetowane do 1500.\nSezon zosta≈Ç dodany do archiwum.');
                
                // Prze≈Çaduj dane
                loadData();
                await loadCurrentSeason();
                await loadPreviousSeasons();
                showPage('ranks');
                
            } catch (error) {
                console.error('B≈ÇƒÖd ko≈Ñczenia sezonu:', error);
                alert('B≈ÇƒÖd ko≈Ñczenia sezonu: ' + error.message);
            }
        }
        
        // Funkcje pomocnicze
        function formatDate(date) {
            return date.toLocaleDateString('pl-PL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function formatDateTime(date) {
            return date.toLocaleDateString('pl-PL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function showAchievements() {
            showPage('achievements');
        }
        
        function showNewSeasonForm() {
            showPage('newSeason');
        }
        
        function showPreviousSeasons() {
            showPage('seasons');
        }
        
        // Funkcja diagnostyczna do sprawdzenia sezon√≥w w Firebase
        async function debugSeasons() {
            if (!db) return;
            
            try {
                console.log("=== DIAGNOSTYKA SEZON√ìW ===");
                
                // Pobierz wszystkie sezony
                const seasonsSnapshot = await db.collection('seasons').get();
                
                console.log(`Znaleziono ${seasonsSnapshot.size} sezon√≥w w Firebase:`);
                
                seasonsSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log(`Sezon: ${data.name || `Sezon ${data.seasonNumber}`}`);
                    console.log(`- ID: ${doc.id}`);
                    console.log(`- Numer: ${data.seasonNumber}`);
                    console.log(`- Status: ${data.status || 'brak'}`);
                    console.log(`- Data rozpoczƒôcia: ${data.startDate}`);
                    console.log(`- Data zako≈Ñczenia: ${data.endDate}`);
                    console.log(`- Zako≈Ñczony przez: ${data.endedBy || 'nie'}`);
                    console.log('---');
                });
                
                // Sprawd≈∫ bie≈ºƒÖcy sezon
                const currentSeasonDoc = await db.collection('system').doc('currentSeason').get();
                if (currentSeasonDoc.exists) {
                    console.log("Bie≈ºƒÖcy sezon w systemie:", currentSeasonDoc.data());
                } else {
                    console.log("Brak bie≈ºƒÖcego sezonu w systemie");
                }
                
                // Sprawd≈∫ liczbƒô graczy
                console.log(`Liczba graczy: ${players.length}`);
                
            } catch (error) {
                console.error("B≈ÇƒÖd diagnostyki:", error);
            }
        }
        
        // ≈Åadowanie danych sezonu - POPRAWIONE
        async function loadCurrentSeason() {
            if (!db) return;
            
            try {
                const seasonDoc = await db.collection('system').doc('currentSeason').get();
                
                if (seasonDoc.exists) {
                    const currentSeasonData = seasonDoc.data();
                    const seasonId = currentSeasonData.seasonId;
                    
                    if (seasonId) {
                        const seasonDocData = await db.collection('seasons').doc(seasonId).get();
                        
                        if (seasonDocData.exists) {
                            currentSeason = seasonDocData.data();
                            currentSeason.id = seasonDocData.id;
                            
                            // Sprawd≈∫ czy sezon siƒô ju≈º zako≈Ñczy≈Ç
                            const now = new Date();
                            const endDate = new Date(currentSeason.endDate);
                            
                            if (now > endDate && currentSeason.status !== 'ended') {
                                // Automatycznie zako≈Ñcz sezon
                                await endSeasonAutomatically();
                            }
                        } else {
                            console.error("Dokument sezonu nie istnieje:", seasonId);
                            currentSeason = null;
                        }
                    } else {
                        currentSeason = null;
                    }
                } else {
                    currentSeason = null;
                }
                
                generateSeasonStatus();
                updateNewSeasonButton();
                updateEndSeasonButton();
                
            } catch (error) {
                console.error("B≈ÇƒÖd ≈Çadowania sezonu:", error);
                currentSeason = null;
            }
        }
        
        // ≈Åadowanie wcze≈õniejszych sezon√≥w - POPRAWIONE
        async function loadPreviousSeasons() {
            if (!db) return;
            
            try {
                const seasonsSnapshot = await db.collection('seasons')
                    .orderBy('seasonNumber', 'desc')
                    .limit(10)
                    .get();
                
                previousSeasons = [];
                seasonsSnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    // Dodaj tylko sezony kt√≥re sƒÖ zako≈Ñczone LUB nie sƒÖ bie≈ºƒÖcym sezonem
                    if (data.status === 'ended') {
                        previousSeasons.push(data);
                    }
                });
                
                console.log(`Za≈Çadowano ${previousSeasons.length} zako≈Ñczonych sezon√≥w`, previousSeasons);
                
            } catch (error) {
                console.error("B≈ÇƒÖd ≈Çadowania sezon√≥w:", error);
                previousSeasons = [];
            }
        }
        
        // Automatyczne ko≈Ñczenie sezonu - POPRAWIONE
        async function endSeasonAutomatically() {
            if (!db || !currentSeason || currentSeason.status === 'ended') return;
            
            try {
                console.log("Automatyczne ko≈Ñczenie sezonu:", currentSeason.name);
                
                // Oblicz podium
                const sortedPlayers = players.sort((a, b) => b.elo - a.elo);
                const podium = sortedPlayers.slice(0, 3).map((player, index) => ({
                    name: player.name,
                    elo: player.elo,
                    achievement: getAchievementForPosition(index + 1, player.elo)
                }));
                
                // Zresetuj ELO wszystkich graczy do 1500
                const batch = db.batch();
                const playersSnapshot = await db.collection('players').get();
                
                playersSnapshot.forEach(doc => {
                    batch.update(doc.ref, { elo: 1500 });
                });
                
                // Aktualizuj dane sezonu
                const seasonRef = db.collection('seasons').doc(currentSeason.id);
                
                const updates = {
                    status: 'ended',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: players.length,
                    podium: podium,
                    finalEloStats: players.map(p => ({ name: p.name, finalElo: p.elo })),
                    matchesPlayed: history.length,
                    endedBy: 'auto',
                    endedManually: false
                };
                
                // Zaktualizuj istniejƒÖcy dokument
                batch.update(seasonRef, updates);
                
                // Usu≈Ñ bie≈ºƒÖcy sezon z systemu
                const currentSeasonRef = db.collection('system').doc('currentSeason');
                batch.delete(currentSeasonRef);
                
                await batch.commit();
                
                console.log('‚úÖ Sezon zako≈Ñczony automatycznie i dodany do archiwum');
                
                // Od≈õwie≈º dane
                loadData();
                await loadCurrentSeason();
                await loadPreviousSeasons();
                
            } catch (error) {
                console.error("B≈ÇƒÖd automatycznego ko≈Ñczenia sezonu:", error);
            }
        }
        
        // Funkcja do okre≈õlania osiƒÖgniƒôcia na podstawie pozycji i ELO
        function getAchievementForPosition(position, elo) {
            if (position === 1 && elo >= (currentSeason?.rankThresholds[9] || 2401)) {
                return "Top 1 of season [RANK9]";
            } else if (position === 1) {
                return "Top 1 of season";
            } else if (position === 2) {
                return "Top 2 of season";
            } else if (position === 3) {
                return "Top 3 of season";
            }
            return "None";
        }
        
        // Inicjalizacja
        function getDeviceId() {
            const deviceInfo = navigator.userAgent + navigator.platform + navigator.language;
            let hash = 0;
            for (let i = 0; i < deviceInfo.length; i++) {
                const char = deviceInfo.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'device_' + Math.abs(hash).toString(16);
        }
        
        // G≈Ç√≥wna inicjalizacja aplikacji
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Strona za≈Çadowana, inicjalizujƒô Firebase...');
            
            // Inicjalizuj Firebase
            const firebaseInstance = initializeFirebase();
            
            if (firebaseInstance) {
                db = firebaseInstance.db;
                auth = firebaseInstance.auth;
                
                // Za≈Çaduj dane
                loadData();
                await loadCurrentSeason();
                await loadPreviousSeasons();
                
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
                
            } else {
                console.log('Tryb offline - pokazujƒô dane demo');
                
                // Przyk≈Çadowi gracze dla demo
                players = [
                    { id: '1', name: 'Jan Kowalski', elo: 2450, code: '12345' },
                    { id: '2', name: 'Anna Nowak', elo: 2200, code: '23456' },
                    { id: '3', name: 'Piotr Wi≈õniewski', elo: 2100, code: '34567' },
                    { id: '4', name: 'Katarzyna W√≥jcik', elo: 1950, code: '45678' },
                    { id: '5', name: 'Micha≈Ç Kowalczyk', elo: 1800, code: '56789' },
                    { id: '6', name: 'Agnieszka Kami≈Ñska', elo: 1650, code: '67890' },
                    { id: '7', name: 'Tomasz Lewandowski', elo: 1500, code: '78901' },
                    { id: '8', name: 'Magdalena Zieli≈Ñska', elo: 1350, code: '89012' },
                    { id: '9', name: 'Krzysztof Szyma≈Ñski', elo: 1200, code: '90123' },
                    { id: '10', name: 'Ewa Wo≈∫niak', elo: 1100, code: '01234' }
                ];
                
                updateUIForRole();
                updateMenuForRole();
                updateNewSeasonButton();
                updateEndSeasonButton();
            }
            
            // Dodaj event listeners
            setTimeout(() => {
                const selectPlayerA = document.getElementById('selectPlayerA');
                const selectPlayerB = document.getElementById('selectPlayerB');
                
                if (selectPlayerA) {
                    selectPlayerA.addEventListener('change', onPlayerSelectChange);
                }
                
                if (selectPlayerB) {
                    selectPlayerB.addEventListener('change', onPlayerSelectChange);
                }
                
                // Event listener dla Enter w polu has≈Ça
                const adminPasswordInput = document.getElementById('adminPassword');
                if (adminPasswordInput) {
                    adminPasswordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            login();
                        }
                    });
                }
                
                // Obs≈Çuga ESC w modalach
                document.addEventListener('keydown', function(event) {
                    const modal = document.getElementById('codeModal');
                    if (event.key === 'Escape' && modal && modal.classList.contains('active')) {
                        closeCodeModal();
                    }
                });
                
                // Klikniƒôcie poza modal
                const modalOverlay = document.getElementById('codeModal');
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', function(event) {
                        if (event.target === this) {
                            closeCodeModal();
                        }
                    });
                }
                
                // Event listeners dla p√≥l dart√≥w
                const dartInputs = ['dart1', 'dart2', 'dart3'];
                dartInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', calculateTurnTotal);
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                // Przejd≈∫ do nastƒôpnego pola lub zatwierd≈∫
                                const currentIndex = dartInputs.indexOf(id);
                                if (currentIndex < 2) {
                                    document.getElementById(dartInputs[currentIndex + 1]).focus();
                                } else {
                                    submitDarts();
                                }
                            }
                        });
                    }
                });
                
                // Generuj kody
                generateRandomCode();
                generateRandomCodeDev();
                
                // Generuj poczƒÖtkowe widoki
                generateRanksPage();
                generateAchievementsPage();
                generateSeasonStatus();
                
            }, 500);
            
            console.log('‚úÖ Aplikacja gotowa do u≈ºycia!');
            showPage('elo');
        });
    </script>
</body>
</html>